---
title: Modelar el comportamiento de la cancelación en los flujos de trabajo
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: 8738afa838f1d0ca36b7fd6def00f0794bcf47ac
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 03/12/2020
ms.locfileid: "79143049"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="9f3d0-102">Modelar el comportamiento de la cancelación en los flujos de trabajo</span><span class="sxs-lookup"><span data-stu-id="9f3d0-102">Modeling Cancellation Behavior in Workflows</span></span>
<span data-ttu-id="9f3d0-103">Las actividades se pueden cancelar dentro de un flujo de trabajo, por ejemplo, mediante una actividad <xref:System.Activities.Statements.Parallel> que cancele las bifurcaciones incompletas cuando su propiedad <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> se evalúe como `true` o desde fuera del flujo de trabajo, si el host llama al método <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-103">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="9f3d0-104">Para proporcionar un control de la cancelación, los autores del flujo de trabajo pueden utilizar la actividad <xref:System.Activities.Statements.CancellationScope>, la actividad <xref:System.Activities.Statements.CompensableActivity> o crear actividades personalizadas que proporcionen lógica de cancelación.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-104">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="9f3d0-105">En este tema se proporciona información general sobre la cancelación en flujos de trabajo.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-105">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="9f3d0-106">Cancelación, compensación y transacciones</span><span class="sxs-lookup"><span data-stu-id="9f3d0-106">Cancellation, Compensation, and Transactions</span></span>  
 <span data-ttu-id="9f3d0-107">Las transacciones ofrecen a la aplicación la posibilidad de anular (revertir) todos los cambios ejecutados dentro de la transacción si se produce algún error en cualquier momento del proceso de transacción.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-107">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="9f3d0-108">Sin embargo, no todos los trabajos que puede que resulte necesario cancelar o deshacer son adecuados para las transacciones, como los trabajos de ejecución prolongada o aquellos que no implican recursos transaccionales.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-108">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="9f3d0-109">La compensación proporciona un modelo para deshacer un trabajo no transaccional completado previamente si se produce un error en el flujo de trabajo posteriormente.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-109">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="9f3d0-110">La cancelación proporciona un modelo para que el flujo de trabajo y los autores de la actividad puedan controlar un trabajo no transaccional que no se ha completado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-110">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="9f3d0-111">Si una actividad no ha completado su ejecución y se cancela, se invocará su lógica de la cancelación si está disponible.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-111">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="9f3d0-112">Para obtener más información acerca de las transacciones y la compensación, vea [Transacciones](workflow-transactions.md) y [compensación](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="9f3d0-112">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="9f3d0-113">Usar CancellationScope</span><span class="sxs-lookup"><span data-stu-id="9f3d0-113">Using CancellationScope</span></span>  
 <span data-ttu-id="9f3d0-114">La actividad <xref:System.Activities.Statements.CancellationScope> tiene dos secciones que pueden contener actividades secundarias: <xref:System.Activities.Statements.CancellationScope.Body%2A> y <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-114">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="9f3d0-115">La propiedad <xref:System.Activities.Statements.CancellationScope.Body%2A> es donde se colocan las actividades que constituyen la lógica de la actividad y la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> es donde se colocan las actividades que proporcionan la lógica de cancelación para la actividad.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-115">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="9f3d0-116">Una actividad solo puede cancelar si no se ha completado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-116">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="9f3d0-117">En el caso de la actividad <xref:System.Activities.Statements.CancellationScope>, la finalización hace referencia a la realización de las actividades de la propiedad <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-117">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="9f3d0-118">Si se programa una solicitud de cancelación y no se han completado las actividades de la propiedad <xref:System.Activities.Statements.CancellationScope.Body%2A>, el objeto <xref:System.Activities.Statements.CancellationScope> se marcará como <xref:System.Activities.ActivityInstanceState.Canceled> y las actividades <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> se ejecutarán.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-118">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="9f3d0-119">Cancelar un flujo de trabajo desde el host</span><span class="sxs-lookup"><span data-stu-id="9f3d0-119">Canceling a Workflow from the Host</span></span>  
 <span data-ttu-id="9f3d0-120">Un host puede cancelar un flujo de trabajo llamando al método <xref:System.Activities.WorkflowApplication.Cancel%2A> de la instancia de <xref:System.Activities.WorkflowApplication> que hospeda el flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-120">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="9f3d0-121">En el ejemplo siguiente, se crea un flujo de trabajo con un objeto <xref:System.Activities.Statements.CancellationScope>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-121">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="9f3d0-122">Se invoca el flujo de trabajo y, a continuación, el host llama al método <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-122">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="9f3d0-123">La ejecución principal del flujo de trabajo se detiene, se invoca la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> del objeto <xref:System.Activities.Statements.CancellationScope> y, a continuación, el flujo de trabajo se completa con el estado <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-123">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="9f3d0-124">Cuando se invoca este flujo de trabajo, en la consola se muestra el siguiente resultado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-124">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="9f3d0-125">**Iniciando el flujo de trabajo.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-125">**Starting the workflow.**</span></span>  
<span data-ttu-id="9f3d0-126">**CancellationHandler invocado.** 
Flujo de **trabajo b30ebb30-df46-4d90-a211-e31c38d8db3c Cancelado.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-126">**CancellationHandler invoked.**
**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>
> [!NOTE]
> <span data-ttu-id="9f3d0-127">Cuando una actividad <xref:System.Activities.Statements.CancellationScope> se cancela y se invoca la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, es responsabilidad del autor del flujo de trabajo determinar el progreso de la actividad antes de cancelarse para proporcionar la lógica de cancelación adecuada.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-127">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="9f3d0-128">La propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> no proporciona ninguna información sobre el progreso de la actividad cancelada.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-128">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="9f3d0-129">Un flujo de trabajo también se puede cancelar desde el host si una excepción no controlada traspasa la raíz del flujo de trabajo y el controlador de la propiedad <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> devuelve <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-129">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="9f3d0-130">En este ejemplo el flujo de trabajo se inicia y, a continuación, genera una <xref:System.ApplicationException>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-130">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="9f3d0-131">El flujo de trabajo no controla la excepción y, en consecuencia, se invoca al controlador de la propiedad <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-131">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="9f3d0-132">El controlador indica al tiempo de ejecución que cancele el flujo de trabajo y se invoca la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> de la actividad <xref:System.Activities.Statements.CancellationScope> actualmente en ejecución.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-132">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="9f3d0-133">Cuando se invoca este flujo de trabajo, en la consola se muestra el siguiente resultado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-133">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="9f3d0-134">**Iniciando el flujo de trabajo.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-134">**Starting the workflow.**</span></span>  
<span data-ttu-id="9f3d0-135">**OnUnhandledException en el flujo de trabajo 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9**
**Se ha producido una excepción ApplicationException.** 
 **CancellationHandler invocado.** 
Flujo de trabajo **6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Cancelado.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-135">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9**
**An ApplicationException was thrown.**
**CancellationHandler invoked.**
**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>
### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="9f3d0-136">Cancelar una actividad desde dentro de un flujo de trabajo</span><span class="sxs-lookup"><span data-stu-id="9f3d0-136">Canceling an Activity from Inside a Workflow</span></span>  
 <span data-ttu-id="9f3d0-137">Una actividad también puede cancelarse mediante su elemento primario.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-137">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="9f3d0-138">Por ejemplo, si una actividad <xref:System.Activities.Statements.Parallel> tiene varias bifurcaciones en ejecución y su propiedad <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> se evalúa como `true`, se cancelarán sus bifurcaciones incompletas.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-138">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="9f3d0-139">En este ejemplo, se crea una actividad <xref:System.Activities.Statements.Parallel> con dos bifurcaciones.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-139">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="9f3d0-140">Su propiedad <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> está establecida como `true`, por lo que la actividad <xref:System.Activities.Statements.Parallel> se completa cuando lo hace una de sus bifurcaciones.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-140">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="9f3d0-141">En este ejemplo, la bifurcación 2 se completa, por lo que se cancela la bifurcación 1.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-141">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="9f3d0-142">Cuando se invoca este flujo de trabajo, en la consola se muestra el siguiente resultado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-142">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="9f3d0-143">**Rama 1 a partir.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-143">**Branch 1 starting.**</span></span>  
<span data-ttu-id="9f3d0-144">**Rama 2 completa.** 
 **Sucursal 1 cancelada.** 
Flujo de **trabajo e0685e24-18ef-4a47-acf3-5c638732f3be Completado.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-144">**Branch 2 complete.**
**Branch 1 canceled.**
**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="9f3d0-145">Las actividades también se cancelan si una excepción traspasa la raíz de la actividad, pero se controla en un nivel más alto del flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-145">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="9f3d0-146">En este ejemplo, la lógica principal del flujo de trabajo consta de una actividad <xref:System.Activities.Statements.Sequence>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-146">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="9f3d0-147">El objeto <xref:System.Activities.Statements.Sequence> se especifica como la propiedad <xref:System.Activities.Statements.CancellationScope.Body%2A> de una actividad <xref:System.Activities.Statements.CancellationScope> que está incluida en una actividad <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-147">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="9f3d0-148">El cuerpo del objeto <xref:System.Activities.Statements.Sequence> produce una excepción, que es controlada por el elemento principal de la actividad <xref:System.Activities.Statements.TryCatch> y el objeto <xref:System.Activities.Statements.Sequence> se cancela.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-148">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="9f3d0-149">Cuando se invoca este flujo de trabajo, en la consola se muestra el siguiente resultado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-149">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="9f3d0-150">**Secuencia que comienza.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-150">**Sequence starting.**</span></span>  
<span data-ttu-id="9f3d0-151">**Secuencia cancelada.** 
 **Excepción detectada.** 
Flujo de **trabajo e3c18939-121e-4c43-af1c-ba1ce977ce55 Completado.**</span><span class="sxs-lookup"><span data-stu-id="9f3d0-151">**Sequence canceled.**
**Exception caught.**
**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>
### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="9f3d0-152">Producir excepciones en CancellationHandler</span><span class="sxs-lookup"><span data-stu-id="9f3d0-152">Throwing Exceptions from a CancellationHandler</span></span>  
 <span data-ttu-id="9f3d0-153">Cualquier excepción producida por la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> de un objeto <xref:System.Activities.Statements.CancellationScope> resulta grave para el flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-153">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="9f3d0-154">Si existe alguna posibilidad de que se escapen excepciones de un objeto <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, utilice un objeto <xref:System.Activities.Statements.TryCatch> en la propiedad <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> para detectar y controlar estas excepciones.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-154">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="9f3d0-155">Cancelación mediante CompensableActivity</span><span class="sxs-lookup"><span data-stu-id="9f3d0-155">Cancellation using CompensableActivity</span></span>  
 <span data-ttu-id="9f3d0-156">Al igual que la actividad <xref:System.Activities.Statements.CancellationScope>, <xref:System.Activities.Statements.CompensableActivity> tiene una propiedad <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-156">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="9f3d0-157">Si se cancela un objeto <xref:System.Activities.Statements.CompensableActivity>, se invoca cualquier actividad presente en su propiedad <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-157">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="9f3d0-158">Esto puede ser útil para deshacer un trabajo compensable completado parcialmente.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-158">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="9f3d0-159">Para obtener información <xref:System.Activities.Statements.CompensableActivity> sobre cómo utilizar para compensación y cancelación, consulte [Compensación](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="9f3d0-159">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="9f3d0-160">Cancelación mediante actividades personalizadas</span><span class="sxs-lookup"><span data-stu-id="9f3d0-160">Cancellation using Custom Activities</span></span>  
 <span data-ttu-id="9f3d0-161">Los autores de actividades personalizadas pueden implementar la lógica de cancelación en sus actividades personalizadas de varias maneras diferentes.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-161">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="9f3d0-162">Las actividades personalizadas que derivan de <xref:System.Activities.Activity> pueden implementar la lógica de cancelación colocando <xref:System.Activities.Statements.CancellationScope> u otra actividad personalizada que contiene lógica de cancelación en el cuerpo de la actividad.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-162">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="9f3d0-163">Las actividades derivadas <xref:System.Activities.AsyncCodeActivity> y <xref:System.Activities.NativeActivity> pueden invalidar su método <xref:System.Activities.NativeActivity.Cancel%2A> respectivo y proporcionar lógica de cancelación allí.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-163"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="9f3d0-164">Las actividades derivadas de <xref:System.Activities.CodeActivity> no proporcionan ninguna disposición para cancelación porque todo el trabajo se realiza en una sola ráfaga de ejecución cuando el tiempo de ejecución llama al método <xref:System.Activities.CodeActivity.Execute%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-164"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="9f3d0-165">Si no se ha llamado todavía al método de ejecución y se cancela una actividad basada en <xref:System.Activities.CodeActivity>, la actividad se cierra con el estado <xref:System.Activities.ActivityInstanceState.Canceled> y no se llama al método <xref:System.Activities.CodeActivity.Execute%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-165">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="9f3d0-166">Cancelación utilizando NativeActivity</span><span class="sxs-lookup"><span data-stu-id="9f3d0-166">Cancellation using NativeActivity</span></span>  
 <span data-ttu-id="9f3d0-167">Las actividades derivadas <xref:System.Activities.NativeActivity> pueden invalidar el método <xref:System.Activities.NativeActivity.Cancel%2A> para proporcionar lógica de cancelación personalizada.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-167"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="9f3d0-168">Si no se invalida este método, se aplica la lógica de cancelación de flujo de trabajo predeterminada.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-168">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="9f3d0-169">La cancelación predeterminada es <xref:System.Activities.NativeActivity> el proceso que <xref:System.Activities.NativeActivity.Cancel%2A> se <xref:System.Activities.NativeActivity.Cancel%2A> produce para <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> un que no reemplaza el método o cuyo método llama al método base.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-169">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="9f3d0-170">Cuando se cancela una actividad, el tiempo de ejecución marca la actividad para cancelarla y controla automáticamente determinadas tareas de limpieza.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-170">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="9f3d0-171">Si la actividad solo tiene marcadores pendientes, estos se quitarán y la actividad se marcará como <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-171">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="9f3d0-172">Cualquier actividad secundaria pendiente de la actividad cancelada se cancelará a su vez.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-172">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="9f3d0-173">Cualquier intento de programación de actividades secundarias adicionales se ignorará y la actividad se marcará como <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-173">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="9f3d0-174">Si alguna de las actividades secundarias pendientes se completa con el estado <xref:System.Activities.ActivityInstanceState.Canceled> o <xref:System.Activities.ActivityInstanceState.Faulted>, la actividad se marcará como <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-174">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="9f3d0-175">Tenga en cuenta que se puede omitir una solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-175">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="9f3d0-176">Si una actividad no tiene marcadores pendientes ni actividades secundarias en ejecución y no programa ningún elemento de trabajo adicional tras haber sido marcada para cancelarse, se completará correctamente.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-176">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="9f3d0-177">Esta cancelación predeterminada resulta suficiente para muchos escenarios, pero si se necesita lógica de cancelación adicional, se pueden utilizar actividades de cancelación integradas o personalizadas.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-177">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="9f3d0-178">En el siguiente ejemplo, se define la invalidación <xref:System.Activities.NativeActivity.Cancel%2A> de una actividad <xref:System.Activities.NativeActivity> personalizada basada en `ParallelForEach`.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-178">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="9f3d0-179">Cuando se cancela la actividad, esta invalidación controla la lógica de cancelación de la actividad.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-179">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="9f3d0-180">Este ejemplo forma parte del ejemplo [ParallelForEach no genérico.](./samples/non-generic-parallelforeach.md)</span><span class="sxs-lookup"><span data-stu-id="9f3d0-180">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="9f3d0-181">Las actividades derivadas <xref:System.Activities.NativeActivity> pueden determinar si la propiedad <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> ha solicitado la cancelación y marcarse a sí mismas como canceladas llamando al método <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-181"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="9f3d0-182">La llamada al método <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> no completa la actividad de forma inmediata.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-182">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="9f3d0-183">Como es habitual, el tiempo de ejecución completará la actividad cuando no tenga ningún trabajo pendiente, pero si se llama al método <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>, el estado final será <xref:System.Activities.ActivityInstanceState.Canceled> en lugar de <xref:System.Activities.ActivityInstanceState.Closed>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-183">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="9f3d0-184">Cancelación utilizando AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="9f3d0-184">Cancellation using AsyncCodeActivity</span></span>  
 <span data-ttu-id="9f3d0-185">Las actividades basadas en <xref:System.Activities.AsyncCodeActivity> también pueden proporcionar lógica de cancelación personalizada invalidando el método <xref:System.Activities.AsyncCodeActivity.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-185"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="9f3d0-186">Si no se invalida este método, no se realizará ningún control de la cancelación si la actividad se cancela.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-186">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="9f3d0-187">En el siguiente ejemplo, se define la invalidación <xref:System.Activities.AsyncCodeActivity.Cancel%2A> de una actividad <xref:System.Activities.AsyncCodeActivity> personalizada basada en `ExecutePowerShell`.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-187">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="9f3d0-188">Cuando la actividad se cancela, pone en práctica el comportamiento de cancelación deseado.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-188">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="9f3d0-189">Las actividades derivadas <xref:System.Activities.AsyncCodeActivity> pueden determinar si la propiedad <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> ha solicitado la cancelación y marcarse a sí mismas como canceladas llamando al método <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="9f3d0-189"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
