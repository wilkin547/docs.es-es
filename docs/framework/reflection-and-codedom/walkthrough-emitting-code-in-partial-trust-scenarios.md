---
title: 'Tutorial: Emisión de código en escenarios que no son de plena confianza'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: fd420c9754494b95c55df403edec87743572db03
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 10/30/2019
ms.locfileid: "73129989"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="aba4e-102">Tutorial: Emisión de código en escenarios que no son de plena confianza</span><span class="sxs-lookup"><span data-stu-id="aba4e-102">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="aba4e-103">La emisión de reflexión usa el mismo conjunto de API con confianza completa o parcial, pero algunas características requieren permisos especiales en entornos de confianza parcial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-103">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="aba4e-104">Además, la emisión de reflexión tiene una característica, los métodos dinámicos hospedados de forma anónima, diseñada para su uso en entornos de confianza parcial y por ensamblados transparentes en seguridad.</span><span class="sxs-lookup"><span data-stu-id="aba4e-104">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="aba4e-105">Antes de .NET Framework 3.5, la emisión de código requería <xref:System.Security.Permissions.ReflectionPermission> con la marca <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-105">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="aba4e-106">Este permiso está incluido de forma predeterminada en los conjuntos de permisos con nombre `FullTrust` e `Intranet`, pero no en el conjunto de permisos `Internet`.</span><span class="sxs-lookup"><span data-stu-id="aba4e-106">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="aba4e-107">Por tanto, se podría usar una biblioteca de confianza parcial solo si tuviera el atributo <xref:System.Security.SecurityCriticalAttribute> y también se ejecutara un método <xref:System.Security.PermissionSet.Assert%2A> para <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-107">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="aba4e-108">Estas bibliotecas requieren una revisión cuidadosa de la seguridad porque los errores de codificación pueden provocar vulnerabilidades de seguridad.</span><span class="sxs-lookup"><span data-stu-id="aba4e-108">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="aba4e-109">.NET Framework 3.5 permite emitir código en escenarios de confianza parcial sin emitir ninguna petición de seguridad, porque la generación de código no es en sí una operación que requiera privilegios.</span><span class="sxs-lookup"><span data-stu-id="aba4e-109">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="aba4e-110">Es decir, el código generado no tiene más permisos que el ensamblado que lo emite.</span><span class="sxs-lookup"><span data-stu-id="aba4e-110">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="aba4e-111">Esto permite que las bibliotecas que emiten código sean transparentes en seguridad y quita la necesidad de validar <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, de manera que escribir una biblioteca segura no requiere este tipo de revisión exhaustiva de la seguridad.</span><span class="sxs-lookup"><span data-stu-id="aba4e-111">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="aba4e-112">En este tutorial se muestran las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="aba4e-112">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="aba4e-113">[Preparar un espacio aislado sencillo para probar el código de confianza parcial](#Setting_up).</span><span class="sxs-lookup"><span data-stu-id="aba4e-113">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="aba4e-114">Ésta es una manera sencilla de experimentar con código con confianza parcial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-114">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="aba4e-115">Para ejecutar código procedente de ubicaciones que no son de confianza, vea [Cómo: Ejecutar código de confianza parcial en un espacio aislado](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="aba4e-115">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="aba4e-116">[Ejecutar código en dominios de aplicación de confianza parcial](#Running_code).</span><span class="sxs-lookup"><span data-stu-id="aba4e-116">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="aba4e-117">[Usar métodos dinámicos hospedados de forma anónima para emitir y ejecutar el código en entornos de confianza parcial](#Using_methods).</span><span class="sxs-lookup"><span data-stu-id="aba4e-117">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="aba4e-118">Para obtener más información sobre cómo emitir código en escenarios de confianza parcial, vea [Problemas de seguridad en la emisión de la reflexión](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="aba4e-118">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="aba4e-119">Para obtener una lista completa del código mostrado en estos procedimientos, vea la [sección Ejemplo](#Example) al final de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-119">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="aba4e-120">Preparar las ubicaciones de confianza parcial</span><span class="sxs-lookup"><span data-stu-id="aba4e-120">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="aba4e-121">En los dos procedimientos siguientes se muestra cómo preparar las ubicaciones desde las que puede probar el código con confianza parcial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-121">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="aba4e-122">En el primer procedimiento se muestra cómo crear un dominio de aplicación en un espacio aislado en el que el código tiene permisos de Internet.</span><span class="sxs-lookup"><span data-stu-id="aba4e-122">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="aba4e-123">En el segundo procedimiento se muestra cómo agregar <xref:System.Security.Permissions.ReflectionPermission> con la marca <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> a un dominio de aplicación de confianza parcial, y de este modo habilitar a los ensamblados con una confianza igual o menor para el acceso a los datos privados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-123">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="aba4e-124">Crear dominios de aplicación en recintos de seguridad</span><span class="sxs-lookup"><span data-stu-id="aba4e-124">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="aba4e-125">Para crear un dominio de aplicación en el que los ensamblados se ejecuten con confianza parcial, debe especificar el conjunto de permisos que se va a conceder a los ensamblados mediante la sobrecarga del método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> para crear el dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-125">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="aba4e-126">La manera más fácil de especificar el conjunto de permisos concedidos es recuperar un conjunto de permisos con nombre de la directiva de seguridad.</span><span class="sxs-lookup"><span data-stu-id="aba4e-126">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="aba4e-127">En el procedimiento siguiente se crea un dominio de aplicación en un espacio aislado que ejecuta el código de confianza parcial, para probar los escenarios en los que el código emitido sólo puede tener acceso a los miembros públicos de tipos públicos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-127">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="aba4e-128">En un procedimiento posterior se muestra cómo agregar <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> para probar los escenarios en los que el código emitido puede tener acceso a los tipos y miembros no públicos de los ensamblados con permisos iguales o menores.</span><span class="sxs-lookup"><span data-stu-id="aba4e-128">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="aba4e-129">Para crear un dominio de aplicación con confianza parcial</span><span class="sxs-lookup"><span data-stu-id="aba4e-129">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="aba4e-130">Cree un conjunto de permisos que se concedan a los ensamblados del dominio de aplicación en un espacio aislado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-130">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="aba4e-131">En este caso, se utiliza el conjunto de permisos de la zona de Internet.</span><span class="sxs-lookup"><span data-stu-id="aba4e-131">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="aba4e-132">Cree un objeto <xref:System.AppDomainSetup> para inicializar el dominio de aplicación con una ruta de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-132">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="aba4e-133">Para simplificar, en este ejemplo de código se usa la carpeta actual.</span><span class="sxs-lookup"><span data-stu-id="aba4e-133">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="aba4e-134">Para ejecutar código que procede de Internet, use una carpeta independiente para el código que no es de confianza, como se describe en [Cómo: Ejecutar código de confianza parcial en un espacio aislado](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="aba4e-134">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="aba4e-135">Cree el dominio de aplicación, especificando la información sobre configuración del dominio de aplicación y el conjunto de permisos concedidos para todos los ensamblados que se ejecutan en el dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-135">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="aba4e-136">El último parámetro de la sobrecarga del método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> permite especificar un conjunto de ensamblados a los que se concederá plena confianza, en lugar del conjunto de permisos concedidos del dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-136">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="aba4e-137">No es necesario especificar los ensamblados de .NET Framework que la aplicación usa, porque esos ensamblados están en la caché global de ensamblados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-137">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="aba4e-138">Los ensamblados que están en la caché global de ensamblados siempre son de plena confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-138">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="aba4e-139">Puede usar este parámetro para especificar ensamblados con nombre seguro que no están en la caché global de ensamblados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-139">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="aba4e-140">Agregar RestrictedMemberAccess a dominios en recintos de seguridad</span><span class="sxs-lookup"><span data-stu-id="aba4e-140">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="aba4e-141">Las aplicaciones host pueden permitir que los métodos dinámicos hospedados de forma anónima tengan acceso a los datos privados de ensamblados con niveles de confianza igual o menor que el nivel de confianza del ensamblado que emite el código.</span><span class="sxs-lookup"><span data-stu-id="aba4e-141">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="aba4e-142">Para habilitar esta capacidad restringida para omitir las comprobaciones de visibilidad Just-In-Time (JIT), la aplicación host agrega un objeto <xref:System.Security.Permissions.ReflectionPermission> con el marcador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) al conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-142">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="aba4e-143">Por ejemplo, un host podría conceder a aplicaciones de Internet permisos de Internet más RMA, de manera que una aplicación de Internet pueda emitir código que tiene acceso a los datos privados de sus propios ensamblados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-143">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="aba4e-144">Debido a que el acceso se limita a los ensamblados con una confianza igual o menor, una aplicación de Internet no puede acceder a los miembros de ensamblados de plena confianza, como los ensamblados de .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="aba4e-144">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="aba4e-145">Para evitar la elevación de privilegios, la información de pila del ensamblado emisor se incluye al construir los métodos dinámicos hospedados de forma anónima.</span><span class="sxs-lookup"><span data-stu-id="aba4e-145">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="aba4e-146">Cuando se invoca el método, se comprueba la información de la pila.</span><span class="sxs-lookup"><span data-stu-id="aba4e-146">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="aba4e-147">Así, un método dinámico hospedado de forma anónima que se invoca desde código de plena confianza seguirá limitado al nivel de confianza del ensamblado emisor.</span><span class="sxs-lookup"><span data-stu-id="aba4e-147">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="aba4e-148">Para crear un dominio de aplicación con confianza parcial más RMA</span><span class="sxs-lookup"><span data-stu-id="aba4e-148">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="aba4e-149">Cree un nuevo objeto <xref:System.Security.Permissions.ReflectionPermission> con la marca (RMA) <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> y use el método <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> para agregar el permiso al conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-149">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="aba4e-150">El método <xref:System.Security.PermissionSet.AddPermission%2A> agrega el permiso al conjunto de permisos concedidos si aún no está incluido.</span><span class="sxs-lookup"><span data-stu-id="aba4e-150">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="aba4e-151">Si el permiso ya está incluido en el conjunto de permisos concedidos, los marcadores especificados se agregan al permiso existente.</span><span class="sxs-lookup"><span data-stu-id="aba4e-151">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="aba4e-152">RMA es una característica de los métodos dinámicos hospedados de forma anónima.</span><span class="sxs-lookup"><span data-stu-id="aba4e-152">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="aba4e-153">Cuando los métodos dinámicos normales omiten las comprobaciones de visibilidad JIT, el código emitido requiere plena confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-153">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="aba4e-154">Cree el dominio de aplicación y especifique la información sobre configuración del dominio de aplicación y el conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-154">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="aba4e-155">Ejecutar código en dominios de aplicación en un espacio aislado</span><span class="sxs-lookup"><span data-stu-id="aba4e-155">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="aba4e-156">En el procedimiento siguiente se explica cómo definir una clase mediante métodos que se pueden ejecutar en un dominio de aplicación, cómo crear una instancia de la clase en el dominio y cómo ejecutar sus métodos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-156">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="aba4e-157">Para definir y ejecutar un método en un dominio de aplicación</span><span class="sxs-lookup"><span data-stu-id="aba4e-157">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="aba4e-158">Defina una clase que se derive de <xref:System.MarshalByRefObject>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-158">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="aba4e-159">Esto permite crear instancias de la clase en otros dominios de aplicación y realizar llamadas a métodos en los límites del dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-159">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="aba4e-160">En este ejemplo, la clase se denomina `Worker`.</span><span class="sxs-lookup"><span data-stu-id="aba4e-160">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="aba4e-161">Defina un método público que contenga el código que desea ejecutar.</span><span class="sxs-lookup"><span data-stu-id="aba4e-161">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="aba4e-162">En este ejemplo, el código emite un método dinámico simple, crea un delegado para ejecutar el método e invoca al delegado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-162">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="aba4e-163">En el programa principal, obtenga el nombre para mostrar del ensamblado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-163">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="aba4e-164">Este nombre se usa al crear instancias de la clase `Worker` en el dominio de aplicación en un espacio aislado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-164">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="aba4e-165">En el programa principal, cree un dominio de aplicación en un espacio aislado, como se describe en [el primer procedimiento](#Setting_up) de este tutorial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-165">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="aba4e-166">No es necesario agregar ningún permiso al conjunto de permisos `Internet`, porque el método `SimpleEmitDemo` sólo usa métodos públicos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-166">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="aba4e-167">En el programa principal, cree una instancia de la clase `Worker` en el dominio de aplicación en un espacio aislado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-167">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="aba4e-168">El método <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> crea el objeto en el dominio de aplicación de destino y devuelve un proxy que se puede usar para llamar a las propiedades y métodos del objeto.</span><span class="sxs-lookup"><span data-stu-id="aba4e-168">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="aba4e-169">Si usa este código en Visual Studio, debe cambiar el nombre de la clase para que incluya el espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="aba4e-169">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="aba4e-170">De forma predeterminada, el espacio de nombres es el nombre del proyecto.</span><span class="sxs-lookup"><span data-stu-id="aba4e-170">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="aba4e-171">Por ejemplo, si el proyecto es "PartialTrust", el nombre de clase debe ser "PartialTrust.Worker".</span><span class="sxs-lookup"><span data-stu-id="aba4e-171">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="aba4e-172">Agregue código para llamar al método `SimpleEmitDemo`.</span><span class="sxs-lookup"><span data-stu-id="aba4e-172">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="aba4e-173">Se calculan las referencias de la llamada en el límite del dominio de aplicación y el código se ejecuta en el dominio de aplicación en un espacio aislado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-173">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="aba4e-174">Usar métodos dinámicos hospedados de forma anónima</span><span class="sxs-lookup"><span data-stu-id="aba4e-174">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="aba4e-175">Los métodos dinámicos hospedados de forma anónima están asociados a un ensamblado transparente proporcionado por el sistema.</span><span class="sxs-lookup"><span data-stu-id="aba4e-175">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="aba4e-176">Por consiguiente, el código que contienen es transparente.</span><span class="sxs-lookup"><span data-stu-id="aba4e-176">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="aba4e-177">Los métodos dinámicos normales, por otro lado, deben estar asociados a un módulo existente (directamente especificados o deducidos de un tipo asociado) y toman el nivel de seguridad de ese módulo.</span><span class="sxs-lookup"><span data-stu-id="aba4e-177">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="aba4e-178">La única manera de asociar un método dinámico al ensamblado que proporciona hospedaje anónimo es usar los constructores que se describen en el procedimiento siguiente.</span><span class="sxs-lookup"><span data-stu-id="aba4e-178">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="aba4e-179">No puede especificar explícitamente un módulo en el ensamblado hospedado de forma anónima.</span><span class="sxs-lookup"><span data-stu-id="aba4e-179">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="aba4e-180">Los métodos dinámicos normales tienen acceso a los miembros internos del módulo al que están asociados o a los miembros privados del tipo al que están asociados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-180">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="aba4e-181">Debido a que los métodos dinámicos de hospedaje anónimo están aislados del resto del código, no tienen acceso a los datos privados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-181">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="aba4e-182">Sin embargo, tienen una capacidad restringida para omitir las comprobaciones de visibilidad JIT para obtener acceso a los datos privados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-182">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="aba4e-183">Esta capacidad se limita a los ensamblados que tienen un nivel de confianza igual o menor que el nivel de confianza del ensamblado que emite el código.</span><span class="sxs-lookup"><span data-stu-id="aba4e-183">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="aba4e-184">Para evitar la elevación de privilegios, la información de pila del ensamblado emisor se incluye al construir los métodos dinámicos hospedados de forma anónima.</span><span class="sxs-lookup"><span data-stu-id="aba4e-184">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="aba4e-185">Cuando se invoca el método, se comprueba la información de la pila.</span><span class="sxs-lookup"><span data-stu-id="aba4e-185">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="aba4e-186">Un método dinámico hospedado de forma anónima que se invoca desde código de plena confianza seguirá limitado al nivel de confianza del ensamblado que lo emitió.</span><span class="sxs-lookup"><span data-stu-id="aba4e-186">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="aba4e-187">Para usar métodos dinámicos hospedados de forma anónima</span><span class="sxs-lookup"><span data-stu-id="aba4e-187">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="aba4e-188">Cree un método dinámico hospedado de forma anónima mediante un constructor que no especifique ningún módulo o tipo asociado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-188">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="aba4e-189">Si un método dinámico hospedado de forma anónima sólo usa tipos y métodos públicos, no necesita acceso restringido a los miembros y no tiene que omitir las comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-189">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="aba4e-190">No son necesarios permisos especiales para emitir un método dinámico, pero el código emitido requiere los permisos exigidos por los tipos y métodos que use.</span><span class="sxs-lookup"><span data-stu-id="aba4e-190">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="aba4e-191">Por ejemplo, si el código emitido llama a un método que tiene acceso a un archivo, requiere <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-191">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="aba4e-192">Si el nivel de confianza no incluye ese permiso, se produce una excepción de seguridad al ejecutar el código emitido.</span><span class="sxs-lookup"><span data-stu-id="aba4e-192">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="aba4e-193">El código mostrado aquí emite un método dinámico que sólo usa el método <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-193">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="aba4e-194">Por consiguiente, el código se puede ejecutar desde ubicaciones de confianza parcial.</span><span class="sxs-lookup"><span data-stu-id="aba4e-194">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="aba4e-195">Opcionalmente, para crear un método dinámico de host anónimo con capacidad restringida para omitir las comprobaciones de visibilidad JIT, puede usar el constructor <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> y especificar `true` para el parámetro `restrictedSkipVisibility`.</span><span class="sxs-lookup"><span data-stu-id="aba4e-195">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="aba4e-196">La restricción es que el método dinámico hospedado de forma anónima sólo puede tener acceso a los datos privados de ensamblados con niveles de confianza iguales o menores que el nivel de confianza del ensamblado emisor.</span><span class="sxs-lookup"><span data-stu-id="aba4e-196">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="aba4e-197">Por ejemplo, si el método dinámico se ejecuta con confianza en Internet, puede acceder a los datos privados de otros ensamblados que también se ejecutan con confianza en Internet, pero no puede acceder a los datos privados de ensamblados de .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="aba4e-197">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="aba4e-198">Los ensamblados de .NET Framework están instalados en la caché global de ensamblados y son siempre de plena confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-198">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="aba4e-199">Los métodos dinámicos hospedados de forma anónima pueden usar esta capacidad restringida para omitir las comprobaciones de visibilidad JIT sólo si la aplicación host concede <xref:System.Security.Permissions.ReflectionPermission> con el marcador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-199">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="aba4e-200">La petición de este permiso se realiza al invocar el método.</span><span class="sxs-lookup"><span data-stu-id="aba4e-200">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="aba4e-201">La información de pila de llamadas del ensamblado emisor se incluye al construir el método dinámico.</span><span class="sxs-lookup"><span data-stu-id="aba4e-201">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="aba4e-202">Por consiguiente, se realiza una petición de los permisos del ensamblado emisor, no del ensamblado que invoca el método.</span><span class="sxs-lookup"><span data-stu-id="aba4e-202">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="aba4e-203">Así se evita que el código emitido se ejecute con permisos elevados.</span><span class="sxs-lookup"><span data-stu-id="aba4e-203">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="aba4e-204">El [ejemplo de código completo](#Example) al final de este tutorial muestra el uso y las limitaciones de acceso a miembros restringidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-204">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="aba4e-205">Su clase `Worker` incluye un método que puede crear métodos dinámicos hospedados de forma anónima con o sin la capacidad restringida de omitir las comprobaciones de visibilidad y el ejemplo muestra el resultado de ejecutar este método en dominios de aplicación que tienen niveles de confianza diferentes.</span><span class="sxs-lookup"><span data-stu-id="aba4e-205">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="aba4e-206">La capacidad restringida de omitir las comprobaciones de visibilidad es una característica de los métodos dinámicos hospedados de forma anónima.</span><span class="sxs-lookup"><span data-stu-id="aba4e-206">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="aba4e-207">Cuando los métodos dinámicos normales omiten las comprobaciones de visibilidad JIT, se les debe otorgar plena confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-207">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="aba4e-208">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="aba4e-208">Example</span></span>

### <a name="description"></a><span data-ttu-id="aba4e-209">Descripción</span><span class="sxs-lookup"><span data-stu-id="aba4e-209">Description</span></span>

<span data-ttu-id="aba4e-210">En el ejemplo de código siguiente se muestra cómo se utiliza el marcador <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> para permitir que los métodos dinámicos hospedados de forma anónima omitan las comprobaciones de visibilidad JIT, pero sólo cuando el miembro de destino tiene un nivel de confianza igual o menor que el ensamblado que emite el código.</span><span class="sxs-lookup"><span data-stu-id="aba4e-210">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="aba4e-211">El ejemplo define una clase `Worker` cuyas referencias se pueden calcular en los límites del dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="aba4e-211">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="aba4e-212">La clase tiene dos sobrecargas de método `AccessPrivateMethod` que emiten y ejecutan métodos dinámicos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-212">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="aba4e-213">La primera sobrecarga emite un método dinámico que llama al método privado `PrivateMethod` de la clase `Worker` y puede emitir el método dinámico con o sin comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-213">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="aba4e-214">La segunda sobrecarga emite un método dinámico que tiene acceso a una propiedad `internal` (propiedad `Friend` en Visual Basic) de la clase <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-214">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="aba4e-215">El ejemplo usa un método del asistente para crear un conjunto de permisos concedidos limitado a los permisos de `Internet` y crea un dominio de aplicación mediante la sobrecarga del método <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> para especificar que todo el código que se ejecute en el dominio usa este conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-215">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="aba4e-216">En el ejemplo se crea una instancia de la clase `Worker` en el dominio de aplicación y se ejecuta el método `AccessPrivateMethod` dos veces.</span><span class="sxs-lookup"><span data-stu-id="aba4e-216">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="aba4e-217">La primera vez que se ejecuta el método `AccessPrivateMethod`, se exigen las comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-217">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="aba4e-218">Se producirá un error en el método dinámico cuando se invoque, porque las comprobaciones de visibilidad JIT le impedirán el acceso al método privado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-218">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="aba4e-219">La segunda vez que se ejecuta el método `AccessPrivateMethod`, se omiten las comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-219">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="aba4e-220">Se producirá un error en el método dinámico al compilarse, porque el conjunto de permisos concedidos `Internet` no concede permisos suficientes para omitir las comprobaciones de visibilidad.</span><span class="sxs-lookup"><span data-stu-id="aba4e-220">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="aba4e-221">El ejemplo siguiente agrega <xref:System.Security.Permissions.ReflectionPermission> con <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> al conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-221">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="aba4e-222">A continuación, en el ejemplo se crea un segundo dominio y se especifica que todo el código que se ejecute en el dominio tenga los permisos del nuevo conjunto de permisos concedidos.</span><span class="sxs-lookup"><span data-stu-id="aba4e-222">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="aba4e-223">En el ejemplo se crea una instancia de la clase `Worker` en el nuevo dominio de aplicación y se ejecutan las dos sobrecargas del método `AccessPrivateMethod`.</span><span class="sxs-lookup"><span data-stu-id="aba4e-223">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="aba4e-224">Se ejecuta la primera sobrecarga del método `AccessPrivateMethod` y se omiten las comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-224">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="aba4e-225">El método dinámico se compila y se ejecuta correctamente, porque el ensamblado que emite el código es igual que el ensamblado que contiene el método privado.</span><span class="sxs-lookup"><span data-stu-id="aba4e-225">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="aba4e-226">Por consiguiente, los niveles de confianza son iguales.</span><span class="sxs-lookup"><span data-stu-id="aba4e-226">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="aba4e-227">Si la aplicación que contiene la clase `Worker` tuviera varios ensamblados, el mismo proceso sería correcto para cualquiera de esos ensamblados, porque todos tendrían el mismo nivel de confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-227">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="aba4e-228">Se ejecuta la segunda sobrecarga del método `AccessPrivateMethod` y, de nuevo, se omiten las comprobaciones de visibilidad JIT.</span><span class="sxs-lookup"><span data-stu-id="aba4e-228">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="aba4e-229">Esta vez, se produce un error en el método dinámico al compilarse porque intenta tener acceso a la propiedad `internal` `FirstChar` de la clase <xref:System.String>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-229">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="aba4e-230">El ensamblado que contiene la clase <xref:System.String> es de plena confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-230">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="aba4e-231">Por consiguiente, está en un nivel de confianza superior al del ensamblado que emite el código.</span><span class="sxs-lookup"><span data-stu-id="aba4e-231">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="aba4e-232">Esta comparación muestra cómo <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> habilita al código de confianza parcial para omitir las comprobaciones de visibilidad de otro código de confianza parcial sin poner en peligro la seguridad del código de confianza.</span><span class="sxs-lookup"><span data-stu-id="aba4e-232">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="aba4e-233">Código</span><span class="sxs-lookup"><span data-stu-id="aba4e-233">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="aba4e-234">Compilar el código</span><span class="sxs-lookup"><span data-stu-id="aba4e-234">Compiling the Code</span></span>

- <span data-ttu-id="aba4e-235">Si compila este código de ejemplo en Visual Studio, debe cambiar el nombre de la clase para que incluya el espacio de nombres al pasarla al método <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>.</span><span class="sxs-lookup"><span data-stu-id="aba4e-235">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="aba4e-236">De forma predeterminada, el espacio de nombres es el nombre del proyecto.</span><span class="sxs-lookup"><span data-stu-id="aba4e-236">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="aba4e-237">Por ejemplo, si el proyecto es "PartialTrust", el nombre de clase debe ser "PartialTrust.Worker".</span><span class="sxs-lookup"><span data-stu-id="aba4e-237">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="aba4e-238">Vea también</span><span class="sxs-lookup"><span data-stu-id="aba4e-238">See also</span></span>

- [<span data-ttu-id="aba4e-239">Problemas de seguridad en la emisión de la reflexión</span><span class="sxs-lookup"><span data-stu-id="aba4e-239">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="aba4e-240">Cómo: Ejecutar código de confianza parcial en un espacio aislado</span><span class="sxs-lookup"><span data-stu-id="aba4e-240">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
