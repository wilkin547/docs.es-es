---
title: Crear un servicio de flujo de trabajo de larga ejecución
ms.date: 03/30/2017
ms.assetid: 4c39bd04-5b8a-4562-a343-2c63c2821345
ms.openlocfilehash: 3e422c138b49fa19aa29e4fa1488d61a2c9bc2f8
ms.sourcegitcommit: 30a558d23e3ac5a52071121a52c305c85fe15726
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 12/25/2019
ms.locfileid: "75348102"
---
# <a name="create-a-long-running-workflow-service"></a><span data-ttu-id="3bc3b-102">Creación de un servicio de flujo de trabajo de ejecución prolongada</span><span class="sxs-lookup"><span data-stu-id="3bc3b-102">Create a Long-running Workflow Service</span></span>

<span data-ttu-id="3bc3b-103">En este tema se describe cómo crear un servicio de flujo de trabajo de larga ejecución.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-103">This topic describes how to create a long-running workflow service.</span></span> <span data-ttu-id="3bc3b-104">Los servicios de flujo de trabajo de larga ejecución se pueden ejecutar durante períodos de tiempo prolongados.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-104">Long running workflow services may run for long periods of time.</span></span> <span data-ttu-id="3bc3b-105">En algún momento, el flujo de trabajo se puede inactivar a la espera de recibir información adicional.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-105">At some point the workflow may go idle waiting for some additional information.</span></span> <span data-ttu-id="3bc3b-106">En este caso, el flujo de trabajo se conserva en una base de datos SQL y se quita de la memoria.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-106">When this occurs the workflow is persisted to a SQL database and is removed from memory.</span></span> <span data-ttu-id="3bc3b-107">Cuando esté disponible la información adicional, la instancia de flujo de trabajo se vuelve a cargar en la memoria y continua ejecutándose.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-107">When the additional information becomes available the workflow instance is loaded back into memory and continues executing.</span></span>  <span data-ttu-id="3bc3b-108">En este escenario, el usuario implementa un sistema de pedidos muy simplificado.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-108">In this scenario you are implementing a very simplified ordering system.</span></span>  <span data-ttu-id="3bc3b-109">El cliente envía un mensaje inicial al servicio de flujo de trabajo para que inicie el pedido.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-109">The client sends an initial message to the workflow service to start the order.</span></span> <span data-ttu-id="3bc3b-110">Devuelve un identificador de pedido al cliente.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-110">It returns an order ID to the client.</span></span> <span data-ttu-id="3bc3b-111">En este momento el servicio de flujo de trabajo espera otro mensaje del cliente y pasa al estado inactivo, y se conserva en una base de datos SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-111">At this point the workflow service is waiting for another message from the client and goes into the idle state and is persisted to a SQL Server database.</span></span>  <span data-ttu-id="3bc3b-112">Cuando el cliente envía el siguiente mensaje para pedir un elemento, el servicio de flujo de trabajo se vuelve a cargar en memoria y finaliza el procesamiento del pedido.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-112">When the client sends the next message to order an item, the workflow service is loaded back into memory and finishes processing the order.</span></span> <span data-ttu-id="3bc3b-113">En el ejemplo de código devuelve una cadena que indica que el elemento se ha agregado al pedido.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-113">In the code sample it returns a string stating the item has been added to the order.</span></span> <span data-ttu-id="3bc3b-114">No se pretende que el ejemplo de código sea una aplicación real de la tecnología, sino más bien un ejemplo sencillo que ilustre servicios de flujo de trabajo de ejecución prolongada.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-114">The code sample is not meant to be a real world application of the technology, but rather a simple sample that illustrates long running workflow services.</span></span> <span data-ttu-id="3bc3b-115">En este tema se da por hecho que sabe cómo crear proyectos y soluciones de Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-115">This topic assumes you know how to create Visual Studio 2012 projects and solutions.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="3bc3b-116">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="3bc3b-116">Prerequisites</span></span>

<span data-ttu-id="3bc3b-117">Debe tener instalado el siguiente software para usar este tutorial:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-117">You must have the following software installed to use this walkthrough:</span></span>

1. <span data-ttu-id="3bc3b-118">Microsoft SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="3bc3b-118">Microsoft SQL Server 2008</span></span>

2. <span data-ttu-id="3bc3b-119">Visual Studio 2012</span><span class="sxs-lookup"><span data-stu-id="3bc3b-119">Visual Studio 2012</span></span>

3. <span data-ttu-id="3bc3b-120">Microsoft [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span><span class="sxs-lookup"><span data-stu-id="3bc3b-120">Microsoft  [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]</span></span>

4. <span data-ttu-id="3bc3b-121">Está familiarizado con WCF y Visual Studio 2012 y sabe cómo crear proyectos o soluciones.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-121">You are familiar with WCF and Visual Studio 2012 and know how to create projects/solutions.</span></span>

## <a name="set-up-the-sql-database"></a><span data-ttu-id="3bc3b-122">Configurar el SQL Database</span><span class="sxs-lookup"><span data-stu-id="3bc3b-122">Set up the SQL Database</span></span>

1. <span data-ttu-id="3bc3b-123">Para conservar las instancias del servicio de flujo de trabajo debe tener instalado Microsoft SQL Server y configurar una base de datos con el fin de almacenar las instancias de flujo de trabajo persistentes.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-123">In order for workflow service instances to be persisted you must have Microsoft SQL Server installed and you must configure a database to store the persisted workflow instances.</span></span> <span data-ttu-id="3bc3b-124">Para ejecutar Microsoft SQL Management Studio, haga clic en el botón **Inicio** , seleccione **todos los programas**, **Microsoft SQL Server 2008**y **Microsoft SQL Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-124">Run Microsoft SQL Management Studio by clicking the **Start** button, selecting **All Programs**, **Microsoft SQL Server 2008**, and **Microsoft SQL Management Studio**.</span></span>

2. <span data-ttu-id="3bc3b-125">Haga clic en el botón **conectar** para iniciar sesión en la instancia de SQL Server</span><span class="sxs-lookup"><span data-stu-id="3bc3b-125">Click the **Connect** button to log on to the SQL Server instance</span></span>

3. <span data-ttu-id="3bc3b-126">Haga clic con el botón derecho en **bases** de datos en la vista de árbol y seleccione **nueva base de datos.**</span><span class="sxs-lookup"><span data-stu-id="3bc3b-126">Right click **Databases** in the tree view and select **New Database..**</span></span> <span data-ttu-id="3bc3b-127">para crear una nueva base de datos denominada `SQLPersistenceStore`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-127">to create a new database called `SQLPersistenceStore`.</span></span>

4. <span data-ttu-id="3bc3b-128">Ejecute el archivo de script SqlWorkflowInstanceStoreSchema.sql ubicado en el directorio C:\Windows\Microsoft.NET\Framework\v4.0\SQL\es en la base de datos SQLPersistenceStore para configurar los esquemas de base de datos necesarios.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-128">Run the SqlWorkflowInstanceStoreSchema.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database schemas.</span></span>

5. <span data-ttu-id="3bc3b-129">Ejecute el archivo de script SqlWorkflowInstanceStoreLogic.sql ubicado en el directorio C:\Windows\Microsoft.NET\Framework\v4.0\SQL\es en la base de datos SQLPersistenceStore para configurar la lógica de base de datos necesaria.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-129">Run the SqlWorkflowInstanceStoreLogic.sql script file located in the C:\Windows\Microsoft.NET\Framework\v4.0\SQL\en directory on the SQLPersistenceStore database to set up the needed database logic.</span></span>

## <a name="create-the-web-hosted-workflow-service"></a><span data-ttu-id="3bc3b-130">Crear el servicio de flujo de trabajo hospedado en Web</span><span class="sxs-lookup"><span data-stu-id="3bc3b-130">Create the Web Hosted Workflow Service</span></span>

1. <span data-ttu-id="3bc3b-131">Cree una solución vacía de Visual Studio 2012, asígnele el nombre `OrderProcessing`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-131">Create an empty Visual Studio 2012 solution, name it `OrderProcessing`.</span></span>

2. <span data-ttu-id="3bc3b-132">Agregue un nuevo proyecto de aplicación de servicio de flujo de trabajo WCF denominado `OrderService` a la solución.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-132">Add a new WCF Workflow Service Application project called `OrderService` to the solution.</span></span>

3. <span data-ttu-id="3bc3b-133">En el cuadro de diálogo Propiedades del proyecto, seleccione la pestaña **Web** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-133">In the project properties dialog, select the **Web** tab.</span></span>

    1. <span data-ttu-id="3bc3b-134">En **acción de inicio** , seleccione **página específica** y especifique `Service1.xamlx`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-134">Under **Start Action** select **Specific Page** and specify `Service1.xamlx`.</span></span>

        <span data-ttu-id="3bc3b-135">![Propiedades web del proyecto de servicio de flujo de trabajo](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Crear la opción de página específica del servicio de flujo de trabajo hospedado en Web")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-135">![Workflow Service Project Web Properties](./media/creating-a-long-running-workflow-service/start-action-specific-page-option.png "Create the web hosted workflow service - Specific Page option")</span></span>

    2. <span data-ttu-id="3bc3b-136">En **servidores** , seleccione **usar servidor Web de IIS local**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-136">Under **Servers** select **Use Local IIS Web server**.</span></span>

        <span data-ttu-id="3bc3b-137">![Configuración del servidor Web local](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Crear el servicio de flujo de trabajo hospedado en Web: usar la opción de servidor Web de IIS local")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-137">![Local Web Server Settings](./media/creating-a-long-running-workflow-service/use-local-web-server.png "Create the web hosted workflow service - Use Local IIS Web Server option")</span></span>

        > [!WARNING]
        > <span data-ttu-id="3bc3b-138">Debe ejecutar Visual Studio 2012 en modo de administrador para establecer esta configuración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-138">You must run Visual Studio 2012 in administrator mode to make this setting.</span></span>

        <span data-ttu-id="3bc3b-139">Estos dos pasos configuran el proyecto de servicio de flujo de trabajo que IIS va a hospedar.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-139">These two steps configure the workflow service project to be hosted by IIS.</span></span>

4. <span data-ttu-id="3bc3b-140">Abra `Service1.xamlx` si aún no está abierto y elimine las actividades **ReceiveRequest** y **SendResponse** existentes.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-140">Open `Service1.xamlx` if it is not open already and delete the existing **ReceiveRequest** and **SendResponse** activities.</span></span>

5. <span data-ttu-id="3bc3b-141">Seleccione la actividad de **servicio secuencial** y haga clic en el vínculo **variables** y agregue las variables que se muestran en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-141">Select the **Sequential Service** activity and click the **Variables** link and add the variables shown in the following illustration.</span></span> <span data-ttu-id="3bc3b-142">De esta forma, se agregan algunas variables que se usarán posteriormente en el servicio de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-142">Doing this adds some variables that will be used later on in the workflow service.</span></span>

    > [!NOTE]
    > <span data-ttu-id="3bc3b-143">Si CorrelationHandle no está en la lista desplegable tipo de variable, seleccione **Buscar tipos** en la lista desplegable.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-143">If CorrelationHandle is not in the Variable Type drop-down, select **Browse for types** from the drop-down.</span></span> <span data-ttu-id="3bc3b-144">Escriba CorrelationHandle en el cuadro **nombre de tipo** , seleccione CorrelationHandle en el cuadro de lista y haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-144">Type CorrelationHandle in the **Type name** box, select CorrelationHandle from the listbox and click **OK**.</span></span>

    <span data-ttu-id="3bc3b-145">![Agregar variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Agregar variables a la actividad de servicio secuencial.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-145">![Add Variables](./media/creating-a-long-running-workflow-service/add-variables-sequential-service-activity.gif "Add variables to the Sequential Service activity.")</span></span>

6. <span data-ttu-id="3bc3b-146">Arrastre y coloque una plantilla de actividad **ReceiveAndSendReply** en la actividad de **servicio secuencial** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-146">Drag and drop a **ReceiveAndSendReply** activity template into the **Sequential Service** activity.</span></span> <span data-ttu-id="3bc3b-147">Este conjunto de actividades recibirá un mensaje de un cliente y devolverá un respuesta.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-147">This set of activities will receive a message from a client and send a reply back.</span></span>

    1. <span data-ttu-id="3bc3b-148">Seleccione la actividad **Receive** y establezca las propiedades resaltadas en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-148">Select the **Receive** activity and set the properties highlighted in the following illustration.</span></span>

        <span data-ttu-id="3bc3b-149">![Establecer propiedades de la actividad Receive](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Establezca las propiedades de la actividad Receive.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-149">![Set Receive Activity Properties](./media/creating-a-long-running-workflow-service/set-receive-activity-properties.png "Set the Receive activity properties.")</span></span>

        <span data-ttu-id="3bc3b-150">La propiedad DisplayName establece el nombre mostrado para la actividad Receive en el diseñador.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-150">The DisplayName property sets the name displayed for the Receive activity in the designer.</span></span> <span data-ttu-id="3bc3b-151">Las propiedades ServiceContractName y OperationName especifican el nombre del contrato de servicio y la operación que implementa la actividad Receive.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-151">The ServiceContractName and OperationName properties specify the name of the service contract and operation that are implemented by the Receive activity.</span></span> <span data-ttu-id="3bc3b-152">Para obtener más información sobre cómo se usan los contratos en los servicios de flujo de trabajo, vea [usar contratos en el flujo de trabajo](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span><span class="sxs-lookup"><span data-stu-id="3bc3b-152">For more information about how contracts are used in Workflow services see [Using Contracts in Workflow](../../../../docs/framework/wcf/feature-details/using-contracts-in-workflow.md).</span></span>

    2. <span data-ttu-id="3bc3b-153">Haga clic en el vínculo **definir...** en la actividad **ReceiveStartOrder** y establezca las propiedades que se muestran en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-153">Click the **Define...** link in the **ReceiveStartOrder** activity and set the properties shown in the following illustration.</span></span>  <span data-ttu-id="3bc3b-154">Observe que el botón de radio **parámetros** está seleccionado, un parámetro denominado `p_customerName` está enlazado a la variable `customerName`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-154">Notice that the **Parameters** radio button is selected, a parameter named `p_customerName` is bound to the `customerName` variable.</span></span> <span data-ttu-id="3bc3b-155">Esto configura la actividad **Receive** para recibir algunos datos y enlazarlos a las variables locales.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-155">This configures the **Receive** activity to receive some data and bind that data to local variables.</span></span>

        <span data-ttu-id="3bc3b-156">![Establecer los datos recibidos por la actividad Receive](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Establezca las propiedades de los datos recibidos por la actividad Receive.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-156">![Setting the data received by the Receive activity](./media/creating-a-long-running-workflow-service/set-properties-for-receive-content.png "Set the properties for data received by the Receive activity.")</span></span>

    3. <span data-ttu-id="3bc3b-157">Seleccione la actividad **SendReplyToReceive** y establezca la propiedad resaltada que se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-157">Select The **SendReplyToReceive** activity and set the highlighted property shown in the following illustration.</span></span>

        <span data-ttu-id="3bc3b-158">![Establecer las propiedades de la actividad SendReply](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-158">![Setting the properties of the SendReply activity](./media/creating-a-long-running-workflow-service/set-properties-for-reply-activities.png "SetReplyProperties")</span></span>

    4. <span data-ttu-id="3bc3b-159">Haga clic en el vínculo **definir...** en la actividad **SendReplyToStartOrder** y establezca las propiedades que se muestran en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-159">Click the **Define...** link in the **SendReplyToStartOrder** activity and set the properties shown in the following illustration.</span></span> <span data-ttu-id="3bc3b-160">Observe que el botón de radio **parámetros** está seleccionado; un parámetro denominado `p_orderId` se enlaza a la variable `orderId`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-160">Notice that the **Parameters** radio button is selected; a parameter named `p_orderId` is bound to the `orderId` variable.</span></span> <span data-ttu-id="3bc3b-161">Esta configuración especifica que la actividad SendReplyToStartOrder ejecutará un valor de tipo de cadena en el autor de la llamada.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-161">This setting specifies that the SendReplyToStartOrder activity will return a value of type string to the caller.</span></span>

        <span data-ttu-id="3bc3b-162">![Configurar los datos de contenido de la actividad SendReply](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configurar la opción para la actividad SetReplyToStartOrder.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-162">![Configuring the SendReply activity content data](./media/creating-a-long-running-workflow-service/setreplycontent-for-sendreplytostartorder-activity.png "Configure setting for SetReplyToStartOrder activity.")</span></span>

    5. <span data-ttu-id="3bc3b-163">Arrastre y coloque una actividad Assign entre las actividades **Receive** y **SendReply** y establezca las propiedades como se muestra en la siguiente ilustración:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-163">Drag and drop an Assign activity in between the **Receive** and **SendReply** activities and set the properties as shown in the following illustration:</span></span>

        <span data-ttu-id="3bc3b-164">![Agregar una actividad Assign](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Agregue una actividad Assign.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-164">![Adding an assign activity](./media/creating-a-long-running-workflow-service/add-an-assign-activity.png "Add an assign activity.")</span></span>

        <span data-ttu-id="3bc3b-165">De esta forma, se crea un identificador de nuevo pedido y se coloca el valor en la variable orderId.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-165">This creates a new order ID and places the value in the orderId variable.</span></span>

    6. <span data-ttu-id="3bc3b-166">Seleccione la actividad **ReplyToStartOrder** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-166">Select the **ReplyToStartOrder** activity.</span></span> <span data-ttu-id="3bc3b-167">En la ventana Propiedades, haga clic en el botón de puntos suspensivos de **CorrelationInitializers**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-167">In the properties window click the ellipsis button for **CorrelationInitializers**.</span></span> <span data-ttu-id="3bc3b-168">Seleccione el vínculo **Agregar inicializador** , escriba `orderIdHandle` en el cuadro de texto inicializador, seleccione inicializador de correlación de consulta para el tipo de correlación y seleccione p_orderId en el cuadro desplegable consultas XPath.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-168">Select the **Add initializer** link, enter `orderIdHandle` in the Initializer text box, select Query correlation initializer for the Correlation type, and select p_orderId under the XPATH Queries dropdown box.</span></span> <span data-ttu-id="3bc3b-169">Esta configuración se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-169">These settings are shown in the following illustration.</span></span> <span data-ttu-id="3bc3b-170">Haga clic en **Aceptar**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-170">Click **OK**.</span></span>  <span data-ttu-id="3bc3b-171">De esta forma, se inicializa una correlación entre el cliente y esta instancia del servicio de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-171">This initializes a correlation between the client and this instance of the workflow service.</span></span> <span data-ttu-id="3bc3b-172">Cuando se reciba un mensaje con este identificador de pedido, se enruta a esta instancia del servicio de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-172">When a message containing this order ID is received it is routed to this instance of the workflow service.</span></span>

        <span data-ttu-id="3bc3b-173">![Agregar un inicializador de correlación](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Agregue un inicializador de correlación.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-173">![Adding a correlation initializer](./media/creating-a-long-running-workflow-service/add-correlationinitializers.png "Add a correlation initializer.")</span></span>

7. <span data-ttu-id="3bc3b-174">Arrastre y coloque otra actividad **ReceiveAndSendReply** al final del flujo de trabajo (fuera de la **secuencia** que contiene las actividades **Receive** y **SendReply** ).</span><span class="sxs-lookup"><span data-stu-id="3bc3b-174">Drag and drop another **ReceiveAndSendReply** activity to the end of the workflow (outside the **Sequence** containing the first **Receive** and **SendReply** activities).</span></span> <span data-ttu-id="3bc3b-175">De esta forma, se recibirá el segundo mensaje enviado por el cliente y se responderá al mismo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-175">This will receive the second message sent by the client and respond to it.</span></span>

    1. <span data-ttu-id="3bc3b-176">Seleccione la **secuencia** que contiene las actividades **Receive** y **SendReply** recién agregadas y haga clic en el botón **variables** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-176">Select the **Sequence** that contains the newly added **Receive** and **SendReply** activities and click the **Variables** button.</span></span> <span data-ttu-id="3bc3b-177">Agregue la variable resaltada en la siguiente ilustración:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-177">Add the variable highlighted in the following illustration:</span></span>

        <span data-ttu-id="3bc3b-178">![Agregar nuevas variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Agregue la variable ItemId.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-178">![Adding new variables](./media/creating-a-long-running-workflow-service/add-the-itemid-variable.png "Add the ItemId variable.")</span></span>

        <span data-ttu-id="3bc3b-179">Agregue también `orderResult` como **cadena** en el ámbito de `Sequence`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-179">Also add `orderResult` as **String** in the `Sequence` scope.</span></span>

    2. <span data-ttu-id="3bc3b-180">Seleccione la actividad **Receive** y establezca las propiedades que se muestran en la siguiente ilustración:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-180">Select the **Receive** activity and set the properties shown in the following illustration:</span></span>

        <span data-ttu-id="3bc3b-181">![Establecer las propiedades de la actividad Receive](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Establezca las propiedades de las actividades de recepción.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-181">![Set the Receive activity properties](./media/creating-a-long-running-workflow-service/set-receive-activities-properties.png "Set the Receive activities properties.")</span></span>

        > [!NOTE]
        > <span data-ttu-id="3bc3b-182">No olvide cambiar el campo **ServiceContractName** por `../IAddItem`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-182">Don't forget to change **ServiceContractName** field with `../IAddItem`.</span></span>

    3. <span data-ttu-id="3bc3b-183">Haga clic en el vínculo **definir...** en la actividad **ReceiveAddItem** y agregue los parámetros que se muestran en la siguiente ilustración: Esto configura la actividad Receive para aceptar dos parámetros, el identificador de pedido y el identificador del elemento que se está ordenando.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-183">Click the **Define...** link in the **ReceiveAddItem** activity and add the parameters shown in the following illustration:This configures the receive activity to accept two parameters, the order ID and the ID of the item being ordered.</span></span>

        <span data-ttu-id="3bc3b-184">![Especificar parámetros para la segunda recepción](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure la actividad Receive para recibir dos parámetros.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-184">![Specifying parameters for the second receive](./media/creating-a-long-running-workflow-service/add-receive-two-parameters.png "Configure the receive activity to receive two parameters.")</span></span>

    4. <span data-ttu-id="3bc3b-185">Haga clic en el botón de puntos suspensivos **CorrelateOn** y escriba `orderIdHandle`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-185">Click the **CorrelateOn** ellipsis button and enter `orderIdHandle`.</span></span> <span data-ttu-id="3bc3b-186">En **consultas XPath**, haga clic en la flecha desplegable y seleccione `p_orderId`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-186">Under **XPath Queries**, click the drop down arrow and select `p_orderId`.</span></span> <span data-ttu-id="3bc3b-187">De esta forma, se configura la correlación de la segunda actividad de recepción.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-187">This configures the correlation on the second receive activity.</span></span> <span data-ttu-id="3bc3b-188">Para obtener más información sobre la correlación, vea [correlación](../../../../docs/framework/wcf/feature-details/correlation.md).</span><span class="sxs-lookup"><span data-stu-id="3bc3b-188">For more information about correlation see [Correlation](../../../../docs/framework/wcf/feature-details/correlation.md).</span></span>

        <span data-ttu-id="3bc3b-189">![Establecimiento de la propiedad CorrelatesOn](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Establezca la propiedad CorrelatesOn.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-189">![Setting the CorrelatesOn property](./media/creating-a-long-running-workflow-service/correlateson-setting.png "Set the CorrelatesOn property.")</span></span>

    5. <span data-ttu-id="3bc3b-190">Arrastre y coloque una actividad **If** inmediatamente después de la actividad **ReceiveAddItem** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-190">Drag and drop an **If** activity immediately after the **ReceiveAddItem** activity.</span></span> <span data-ttu-id="3bc3b-191">Esta actividad actúa como instrucción If.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-191">This activity acts just like an if statement.</span></span>

        1. <span data-ttu-id="3bc3b-192">Establezca la propiedad **Condition** en `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span><span class="sxs-lookup"><span data-stu-id="3bc3b-192">Set the **Condition** property to `itemId=="Zune HD" (itemId="Zune HD" for Visual Basic)`</span></span>

        2. <span data-ttu-id="3bc3b-193">Arrastre y coloque una actividad **assign** en la sección **then** y otra en la sección **else** y establezca las propiedades de las actividades de **asignación** tal como se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-193">Drag and drop an **Assign** activity in to the **Then** section and another into the **Else** section set the properties of the **Assign** activities as shown in the following illustration.</span></span>

            <span data-ttu-id="3bc3b-194">![Asignar el resultado de la llamada de servicio](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Asigne el resultado de la llamada de servicio.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-194">![Assigning the result of the service call](./media/creating-a-long-running-workflow-service/assign-result-of-service-call.png "Assign the result of the service call.")</span></span>

            <span data-ttu-id="3bc3b-195">Si la condición es `true` se ejecutará la sección **then** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-195">If the condition is `true` the **Then** section will be executed.</span></span> <span data-ttu-id="3bc3b-196">Si la condición es `false` se ejecuta la sección **else** .</span><span class="sxs-lookup"><span data-stu-id="3bc3b-196">If the condition is `false` the **Else** section is executed.</span></span>

        3. <span data-ttu-id="3bc3b-197">Seleccione la actividad **SendReplyToReceive** y establezca la propiedad **displayName** que se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-197">Select the **SendReplyToReceive** activity and set the **DisplayName** property shown in the following illustration.</span></span>

            <span data-ttu-id="3bc3b-198">![Establecer las propiedades de la actividad SendReply](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Establezca la propiedad de actividad SendReply.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-198">![Setting the SendReply activity properties](./media/creating-a-long-running-workflow-service/send-reply-activity-property.png "Set the SendReply activity property.")</span></span>

        4. <span data-ttu-id="3bc3b-199">Haga clic en el vínculo **definir...** en la actividad **SetReplyToAddItem** y configúrelo como se muestra en la siguiente ilustración.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-199">Click the **Define ...** link in the **SetReplyToAddItem** activity and configure it as shown in the following illustration.</span></span> <span data-ttu-id="3bc3b-200">Esto configura la actividad **SendReplyToAddItem** para devolver el valor de la variable `orderResult`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-200">This configures the **SendReplyToAddItem** activity to return the value in the `orderResult` variable.</span></span>

            <span data-ttu-id="3bc3b-201">![Establecer el enlace de datos para la actividad SendReply](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Establezca la propiedad para la actividad SendReplyToAddItem.")</span><span class="sxs-lookup"><span data-stu-id="3bc3b-201">![Setting the data binding for the SendReply activity](./media/creating-a-long-running-workflow-service/set-property-for-sendreplytoadditem.gif "Set property for SendReplyToAddItem activity.")</span></span>

8. <span data-ttu-id="3bc3b-202">Abra el archivo Web. config y agregue los siguientes elementos en la sección > de comportamiento de \<para habilitar la persistencia del flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-202">Open the web.config file and add the following elements in the \<behavior> section to enable workflow persistence.</span></span>

    ```xml
    <sqlWorkflowInstanceStore connectionString="Data Source=your-machine\SQLExpress;Initial Catalog=SQLPersistenceStore;Integrated Security=True;Asynchronous Processing=True" instanceEncodingOption="None" instanceCompletionAction="DeleteAll" instanceLockedExceptionAction="BasicRetry" hostLockRenewalPeriod="00:00:30" runnableInstancesDetectionPeriod="00:00:02" />
              <workflowIdle timeToUnload="0"/>
    ```

    > [!WARNING]
    > <span data-ttu-id="3bc3b-203">Asegúrese de reemplazar el nombre del host y de la instancia de SQL Server en el fragmento de código anterior.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-203">Make sure to replace your host and SQL server instance name in the previous code snippet.</span></span>

9. <span data-ttu-id="3bc3b-204">Compile la solución.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-204">Build the solution.</span></span>

## <a name="create-a-client-application-to-call-the-workflow-service"></a><span data-ttu-id="3bc3b-205">Creación de una aplicación cliente para llamar al servicio de flujo de trabajo</span><span class="sxs-lookup"><span data-stu-id="3bc3b-205">Create a Client Application to Call the Workflow Service</span></span>

1. <span data-ttu-id="3bc3b-206">Agregue un nuevo proyecto de aplicación de consola denominado `OrderClient` a la solución.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-206">Add a new Console application project called `OrderClient` to the solution.</span></span>

2. <span data-ttu-id="3bc3b-207">Agregue referencias a los siguientes ensamblados al proyecto `OrderClient`</span><span class="sxs-lookup"><span data-stu-id="3bc3b-207">Add references to the following assemblies to the `OrderClient` project</span></span>

    1. <span data-ttu-id="3bc3b-208">System.ServiceModel.dll</span><span class="sxs-lookup"><span data-stu-id="3bc3b-208">System.ServiceModel.dll</span></span>

    2. <span data-ttu-id="3bc3b-209">System.ServiceModel.Activities.dll</span><span class="sxs-lookup"><span data-stu-id="3bc3b-209">System.ServiceModel.Activities.dll</span></span>

3. <span data-ttu-id="3bc3b-210">Agregue una referencia de servicio al servicio de flujo de trabajo y especifique `OrderService` como el espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-210">Add a service reference to the workflow service and specify `OrderService` as the namespace.</span></span>

4. <span data-ttu-id="3bc3b-211">En el método `Main()` del proyecto de cliente, agregue el siguiente código:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-211">In the `Main()` method of the client project add the following code:</span></span>

    ```csharp
    static void Main(string[] args)
    {
       // Send initial message to start the workflow service
       Console.WriteLine("Sending start message");
       StartOrderClient startProxy = new StartOrderClient();
       string orderId = startProxy.StartOrder("Kim Abercrombie");

       // The workflow service is now waiting for the second message to be sent
       Console.WriteLine("Workflow service is idle...");
       Console.WriteLine("Press [ENTER] to send an add item message to reactivate the workflow service...");
       Console.ReadLine();

       // Send the second message
       Console.WriteLine("Sending add item message");
       AddItemClient addProxy = new AddItemClient();
       AddItem item = new AddItem();
       item.p_itemId = "Zune HD";
       item.p_orderId = orderId;

       string orderResult = addProxy.AddItem(item);
       Console.WriteLine("Service returned: " + orderResult);
    }
    ```

5. <span data-ttu-id="3bc3b-212">Compile la solución y ejecute la aplicación `OrderClient`.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-212">Build the solution and run the `OrderClient` application.</span></span> <span data-ttu-id="3bc3b-213">El cliente mostrará un texto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-213">The client will display the following text:</span></span>

    ```output
    Sending start messageWorkflow service is idle...Press [ENTER] to send an add item message to reactivate the workflow service...
    ```

6. <span data-ttu-id="3bc3b-214">Para comprobar que el servicio de flujo de trabajo se ha guardado, inicie el SQL Server Management Studio; para ello, vaya al menú **Inicio** , seleccione **todos los programas**, **Microsoft SQL Server 2008** **SQL Server Management Studio**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-214">To verify that the workflow service has been persisted, start the SQL Server Management Studio by going to the **Start** menu, Selecting **All Programs**, **Microsoft SQL Server 2008**, **SQL Server Management Studio**.</span></span>

    1. <span data-ttu-id="3bc3b-215">En el panel izquierdo, expanda **, bases de datos**, **SQLPersistenceStore**, **vistas** y haga clic con el botón secundario en **System. Activities. DurableInstancing. instances** y seleccione **seleccionar las primeras 1000 filas**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-215">In the left hand pane expand, **Databases**, **SQLPersistenceStore**, **Views** and right click **System.Activities.DurableInstancing.Instances** and select **Select Top 1000 Rows**.</span></span> <span data-ttu-id="3bc3b-216">En el panel de **resultados** , compruebe que ve al menos una instancia en la lista.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-216">In the **Results** pane verify you see at least one instance listed.</span></span> <span data-ttu-id="3bc3b-217">Puede que haya otras instancia de ejecuciones previas si se produjo una excepción durante la ejecución.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-217">There may be other instances from prior runs if an exception occurred while running.</span></span> <span data-ttu-id="3bc3b-218">Puede eliminar las filas existentes haciendo clic con el botón secundario en **System. Activities. DurableInstancing. instances** y seleccionando **editar las primeras 200 filas**, presionando el botón **Ejecutar** , seleccionando todas las filas en el panel de resultados y seleccionando **eliminar**.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-218">You can delete existing rows by right clicking **System.Activities.DurableInstancing.Instances** and selecting **Edit Top 200 rows**, pressing the **Execute** button, selecting all rows in the results pane and selecting **delete**.</span></span>  <span data-ttu-id="3bc3b-219">Para comprobar que la instancia que se muestra en la base de datos es la instancia de la aplicación creada, compruebe que la vista de instancias esté vacía antes de ejecutar el cliente.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-219">To verify the instance displayed in the database is the instance your application created, verify the instances view is empty prior to running the client.</span></span> <span data-ttu-id="3bc3b-220">Una vez que se ejecute el cliente, vuelva a ejecutar la consulta (Seleccionar las primeras 1000 filas) y compruebe que se haya agregado una nueva instancia.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-220">Once the client is running re-run the query (Select Top 1000 Rows) and verify a new instance has been added.</span></span>

7. <span data-ttu-id="3bc3b-221">Presione Entrar para enviar y agregar un mensaje de elemento al servicio de flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="3bc3b-221">Press enter to send the add item message to the workflow service.</span></span> <span data-ttu-id="3bc3b-222">El cliente mostrará un texto similar al siguiente:</span><span class="sxs-lookup"><span data-stu-id="3bc3b-222">The client will display the following text:</span></span>

    ```output
    Sending add item messageService returned: Item added to orderPress any key to continue . . .
    ```

## <a name="see-also"></a><span data-ttu-id="3bc3b-223">Vea también</span><span class="sxs-lookup"><span data-stu-id="3bc3b-223">See also</span></span>

- [<span data-ttu-id="3bc3b-224">Servicios de flujo de trabajo</span><span class="sxs-lookup"><span data-stu-id="3bc3b-224">Workflow Services</span></span>](../../../../docs/framework/wcf/feature-details/workflow-services.md)
