---
description: Más información acerca de cómo usar las colas de Dead-Letter para controlar los errores de transferencia de mensajes
title: Utilización de las colas de mensajes no enviados para administrar los errores en la transferencia de mensajes
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: 497da84d37cf7c82a2da09e4303b8e53e7e0b46c
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/06/2021
ms.locfileid: "99704451"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="66e52-103">Utilización de las colas de mensajes no enviados para administrar los errores en la transferencia de mensajes</span><span class="sxs-lookup"><span data-stu-id="66e52-103">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>

<span data-ttu-id="66e52-104">Los mensajes en cola pueden producir un error en la entrega.</span><span class="sxs-lookup"><span data-stu-id="66e52-104">Queued messages can fail delivery.</span></span> <span data-ttu-id="66e52-105">Estos mensajes que no se han podido entregar se graban en una cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-105">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="66e52-106">Los errores en la entrega pueden deberse a motivos como errores de la red, una cola eliminada, una cola completa, error de autenticación o un error para entregar a tiempo.</span><span class="sxs-lookup"><span data-stu-id="66e52-106">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="66e52-107">Los mensajes en cola pueden permanecer en la cola durante mucho tiempo si la aplicación receptora no los lee puntualmente de la cola.</span><span class="sxs-lookup"><span data-stu-id="66e52-107">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="66e52-108">Este comportamiento puede no ser adecuado para los mensajes dependientes del tiempo.</span><span class="sxs-lookup"><span data-stu-id="66e52-108">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="66e52-109">Los mensajes dependientes del tiempo tienen un conjunto de propiedades de período de vida (TTL) en el enlace en cola, que indica cuánto tiempo los mensajes pueden estar en la cola antes de que deban expirar.</span><span class="sxs-lookup"><span data-stu-id="66e52-109">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="66e52-110">Los mensajes caducados se envían a la cola especial llamada cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-110">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="66e52-111">Los mensajes también se pueden colocar en una cola de mensajes no enviados por otras razones, como superar una cuota de la cola o debido a un error de autenticación.</span><span class="sxs-lookup"><span data-stu-id="66e52-111">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="66e52-112">Generalmente, las aplicaciones escriben lógica de compensación para leer los mensajes de la cola de mensajes no enviados y de los motivos de error.</span><span class="sxs-lookup"><span data-stu-id="66e52-112">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="66e52-113">La lógica de compensación depende de la causa del error.</span><span class="sxs-lookup"><span data-stu-id="66e52-113">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="66e52-114">Por ejemplo, en el caso de error de autenticación, puede corregir el certificado adjunto al mensaje y reenviar el mensaje.</span><span class="sxs-lookup"><span data-stu-id="66e52-114">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="66e52-115">Si se produjo un error en la entrega porque se alcanzó la cuota de la cola de destino, puede reintentar la entrega con la esperanza de que se haya resuelto el problema de la cuota.</span><span class="sxs-lookup"><span data-stu-id="66e52-115">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="66e52-116">La mayoría de sistemas de puesta en cola tienen una cola de mensajes no enviados para todo el sistema donde se almacenan todos los mensajes erróneos de ese sistema.</span><span class="sxs-lookup"><span data-stu-id="66e52-116">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="66e52-117">Message Queuing (MSMQ) proporciona dos colas de mensajes no enviados para todo el sistema: una cola de mensajes no enviados transaccional para todo el sistema que almacena mensajes que produjeron un error en la entrega a la cola transaccional y una cola de mensajes no enviados no transaccional para todo el sistema que almacena mensajes que produjeron un error en la entrega a la cola no transaccional.</span><span class="sxs-lookup"><span data-stu-id="66e52-117">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="66e52-118">Si dos clientes envían mensajes a dos servicios diferentes y, por lo tanto, las distintas colas en WCF comparten el mismo servicio de MSMQ para enviar, es posible que haya una mezcla de mensajes en la cola de mensajes no enviados del sistema.</span><span class="sxs-lookup"><span data-stu-id="66e52-118">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="66e52-119">Esto es no siempre óptimo.</span><span class="sxs-lookup"><span data-stu-id="66e52-119">This is not always optimal.</span></span> <span data-ttu-id="66e52-120">En muchos casos (seguridad, por ejemplo), quizás no desee que un cliente lea los mensajes de otro cliente de una cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-120">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="66e52-121">Una cola de mensajes no enviados compartida también requiere que los clientes naveguen por la cola para buscar un mensaje que enviaron, lo que puede resultar prohibitivamente caro en función del número de mensajes en la cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-121">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="66e52-122">Por lo tanto, en WCF `NetMsmqBinding` `MsmqIntegrationBinding,` y MSMQ en Windows Vista proporcionan una cola de mensajes no enviados personalizada (a veces denominada cola de mensajes no enviados específica de la aplicación).</span><span class="sxs-lookup"><span data-stu-id="66e52-122">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on Windows Vista provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="66e52-123">La cola de mensajes no enviados personalizada proporciona aislamiento entre los clientes que comparten el mismo servicio de MSMQ para enviar los mensajes.</span><span class="sxs-lookup"><span data-stu-id="66e52-123">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="66e52-124">En Windows Server 2003 y Windows XP, Windows Communication Foundation (WCF) proporciona una cola de mensajes no enviados en todo el sistema para todas las aplicaciones cliente en cola.</span><span class="sxs-lookup"><span data-stu-id="66e52-124">On Windows Server 2003 and Windows XP, Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="66e52-125">En Windows Vista, WCF proporciona una cola de mensajes no enviados para cada aplicación cliente en cola.</span><span class="sxs-lookup"><span data-stu-id="66e52-125">On Windows Vista, WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="66e52-126">Especificar el uso de la cola de mensajes no enviados</span><span class="sxs-lookup"><span data-stu-id="66e52-126">Specifying Use of the Dead-Letter Queue</span></span>  

 <span data-ttu-id="66e52-127">Una cola de mensajes no enviados está en el administrador de cola de la aplicación emisora.</span><span class="sxs-lookup"><span data-stu-id="66e52-127">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="66e52-128">Almacena mensajes que han expirado o que han producido un error en la transferencia o entrega.</span><span class="sxs-lookup"><span data-stu-id="66e52-128">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="66e52-129">El enlace tiene las propiedades de cola de mensajes no enviados siguientes:</span><span class="sxs-lookup"><span data-stu-id="66e52-129">The binding has the following dead-letter queue properties:</span></span>  
  
- <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
- <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="66e52-130">Leer mensajes de la cola de mensajes no enviados</span><span class="sxs-lookup"><span data-stu-id="66e52-130">Reading Messages from the Dead-Letter Queue</span></span>  

 <span data-ttu-id="66e52-131">Una aplicación que lee los mensajes de una cola de mensajes no enviados es similar a un servicio WCF que lee de una cola de aplicaciones, excepto por las siguientes diferencias secundarias:</span><span class="sxs-lookup"><span data-stu-id="66e52-131">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
- <span data-ttu-id="66e52-132">Para leer mensajes de una cola de mensajes no enviados transaccional de un sistema, el identificador URI (Uniform Resource Identifier) debe tener el formato siguiente: net.msmq://localhost/system$;DeadXact.</span><span class="sxs-lookup"><span data-stu-id="66e52-132">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
- <span data-ttu-id="66e52-133">Para leer mensajes de una cola de mensajes no enviados no transaccional de un sistema, el URI debe tener el formato siguiente: net.msmq://localhost/system$;DeadLetter.</span><span class="sxs-lookup"><span data-stu-id="66e52-133">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
- <span data-ttu-id="66e52-134">Para leer los mensajes de una cola de mensajes no enviados personalizada, el URI debe tener el formato siguiente: net. MSMQ://localhost/Private/ \<*custom-dlq-name*> donde *Custom-mensajes fallidos-Name* es el nombre de la cola de mensajes no enviados personalizada.</span><span class="sxs-lookup"><span data-stu-id="66e52-134">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="66e52-135">Para obtener más información sobre cómo direccionar las colas, consulte [puntos de conexión de servicio y direccionamiento de colas](service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="66e52-135">For more information about how to address queues, see [Service Endpoints and Queue Addressing](service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="66e52-136">La pila de WCF en el receptor coincide con las direcciones en las que el servicio está escuchando con la dirección del mensaje.</span><span class="sxs-lookup"><span data-stu-id="66e52-136">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="66e52-137">Si las direcciones coinciden, se envía el mensaje; si no, no se envía el mensaje.</span><span class="sxs-lookup"><span data-stu-id="66e52-137">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="66e52-138">Esto puede producir problemas al leer de la cola de mensajes no enviados, porque los mensajes en la cola de mensajes no enviados normalmente se direccionan al servicio y no al servicio de la cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-138">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="66e52-139">Por consiguiente, el servicio que lee de la cola de mensajes no enviados debe instalar un filtro de direcciones `ServiceBehavior` que indique a la pila que haga coincidir todos los mensajes de la cola independientemente del destinatario.</span><span class="sxs-lookup"><span data-stu-id="66e52-139">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="66e52-140">Específicamente, debe agregar `ServiceBehavior` con el parámetro <xref:System.ServiceModel.AddressFilterMode.Any> al servicio que lee los mensajes de la cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-140">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="66e52-141">Control de mensajes dudosos de la cola de mensajes no enviados</span><span class="sxs-lookup"><span data-stu-id="66e52-141">Poison Message Handling from the Dead-Letter Queue</span></span>  

 <span data-ttu-id="66e52-142">El control de mensajes dudosos está disponible en las colas de mensajes no enviados, con algunas condiciones.</span><span class="sxs-lookup"><span data-stu-id="66e52-142">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="66e52-143">Dado que no puede crear subcolas a partir de las colas del sistema, al leer de la cola de mensajes no enviados del sistema, `ReceiveErrorHandling` no puede estar establecido en `Move`.</span><span class="sxs-lookup"><span data-stu-id="66e52-143">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="66e52-144">Tenga en cuenta que si está leyendo de una cola de mensajes no enviados personalizada, puede tener subcolas y, por consiguiente, `Move` es una disposición válida para el mensaje dudoso.</span><span class="sxs-lookup"><span data-stu-id="66e52-144">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="66e52-145">Cuando `ReceiveErrorHandling` está establecido en `Reject`, al leer de la cola de mensajes no enviados personalizada, el mensaje dudoso se coloca en la cola de mensajes no enviados del sistema.</span><span class="sxs-lookup"><span data-stu-id="66e52-145">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="66e52-146">Si se está leyendo de la cola de mensajes no enviados del sistema, el mensaje se quita (se purga).</span><span class="sxs-lookup"><span data-stu-id="66e52-146">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="66e52-147">Un rechazo de una cola de mensajes no enviados del sistema en MSMQ quita (purga) el mensaje.</span><span class="sxs-lookup"><span data-stu-id="66e52-147">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="66e52-148">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="66e52-148">Example</span></span>  

 <span data-ttu-id="66e52-149">El ejemplo siguiente muestra cómo crear una cola de mensajes no enviados y cómo utilizarla para procesar los mensajes caducados.</span><span class="sxs-lookup"><span data-stu-id="66e52-149">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="66e52-150">El ejemplo se basa en el ejemplo de [Cómo: intercambiar mensajes en cola con puntos de conexión de WCF](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="66e52-150">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="66e52-151">El ejemplo siguiente muestra cómo escribir el código de cliente en el servicio de procesamiento de orden que utiliza una cola de mensajes no enviados para cada aplicación.</span><span class="sxs-lookup"><span data-stu-id="66e52-151">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="66e52-152">El ejemplo también muestra cómo procesar los mensajes de la cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-152">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="66e52-153">A continuación, se muestra el código para un cliente que especifica una cola de mensajes no enviados para cada aplicación.</span><span class="sxs-lookup"><span data-stu-id="66e52-153">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="66e52-154">El código siguiente muestra el archivo de configuración del cliente.</span><span class="sxs-lookup"><span data-stu-id="66e52-154">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="66e52-155">A continuación, se muestra el código para un servicio que procesa los mensajes de una cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-155">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="66e52-156">A continuación, se muestra el código para el archivo de configuración del servicio de cola de mensajes no enviados.</span><span class="sxs-lookup"><span data-stu-id="66e52-156">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="66e52-157">Vea también</span><span class="sxs-lookup"><span data-stu-id="66e52-157">See also</span></span>

- [<span data-ttu-id="66e52-158">Información general de colas</span><span class="sxs-lookup"><span data-stu-id="66e52-158">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="66e52-159">Procedimiento para intercambiar mensajes en cola con puntos de conexión de WCF</span><span class="sxs-lookup"><span data-stu-id="66e52-159">How to: Exchange Queued Messages with WCF Endpoints</span></span>](how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="66e52-160">Control de mensajes dudosos</span><span class="sxs-lookup"><span data-stu-id="66e52-160">Poison Message Handling</span></span>](poison-message-handling.md)
