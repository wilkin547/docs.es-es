---
description: Más información acerca de cómo administrar el contexto del servicio de datos (Servicios de datos de WCF)
title: Administrar el contexto del servicio de datos (Servicio de datos de WCF)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 713136245ae2d7d27010cc527efad83979929761
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/06/2021
ms.locfileid: "99795019"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Administrar el contexto del servicio de datos (Servicio de datos de WCF)

[!INCLUDE [wcf-deprecated](~/includes/wcf-deprecated.md)]

La clase <xref:System.Data.Services.Client.DataServiceContext> encapsula las operaciones admitidas en un servicio de datos determinado. Aunque los servicios de OData no tienen estado, el contexto no es. Por lo tanto, puede utilizar la <xref:System.Data.Services.Client.DataServiceContext> clase para mantener el estado en el cliente entre las interacciones con el servicio de datos con el fin de admitir características como la administración de cambios. Esta clase también administra las identidades y realiza el seguimiento de los cambios.  
  
## <a name="merge-options-and-identity-resolution"></a>Opciones de combinación y resolución de identidad  

 Cuando se ejecuta el objeto <xref:System.Data.Services.Client.DataServiceQuery%601>, las entidades de la fuente de respuesta se materializan en objetos. Para obtener más información, consulte [materialización de objetos](object-materialization-wcf-data-services.md). La forma en que las entradas de un mensaje de respuesta se materializan en objetos se basa en la resolución de identidades y depende de la opción de combinación con la que se ejecutó la consulta. Cuando se ejecutan varias consultas o solicitudes de carga en el ámbito de un único <xref:System.Data.Services.Client.DataServiceContext> , el cliente de servicios de datos de WCF solo realiza el seguimiento de una única instancia de un objeto que tiene un valor de clave concreto. Esta clave, que se utiliza para realizar la resolución de identidades, identifica una entidad de forma inequívoca.  
  
 De forma predeterminada, el cliente solo materializa una entrada de la fuente de respuesta en un objeto para las entidades de las que aún no realiza un seguimiento <xref:System.Data.Services.Client.DataServiceContext>. Esto significa que los cambios en los objetos que ya están en la memoria caché no se sobrescriben. Este comportamiento se controla especificando un valor de <xref:System.Data.Services.Client.MergeOption> para las consultas y las operaciones de carga. Esta opción se especifica estableciendo la propiedad <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> en <xref:System.Data.Services.Client.DataServiceContext>. <xref:System.Data.Services.Client.MergeOption.AppendOnly> es el valor de la opción de combinación predeterminada. De este modo, solo se materializan los objetos de entidades de las que no se realiza un seguimiento, lo que significa que los objetos existentes no se sobrescriben. Otra manera de evitar que los cambios en los objetos del cliente se sobrescriban con las actualizaciones del servicio de datos es especificar <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Cuando se especifica <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, los valores de los objetos del cliente son reemplazados por los valores más recientes de las entradas de la fuente de respuesta, aunque se hayan realizado cambios en estos objetos. Cuando se utiliza una opción de combinación <xref:System.Data.Services.Client.MergeOption.NoTracking>, <xref:System.Data.Services.Client.DataServiceContext> no puede enviar los cambios realizados en los objetos de cliente al servicio de datos. Con esta opción, los cambios siempre se sobrescriben con valores del servicio de datos.  
  
## <a name="managing-concurrency"></a>Administración de la simultaneidad  

 OData admite la simultaneidad optimista que permite al servicio de datos detectar conflictos de actualización. El proveedor del servicio de datos se puede configurar de manera que el servicio de datos compruebe los cambios en las entidades mediante un token de simultaneidad. Este token incluye una o más propiedades de un tipo de entidad que el servicio de datos valida para determinar si un recurso ha cambiado. Los tokens de simultaneidad, que se incluyen en el encabezado eTag de las solicitudes y las respuestas del servicio de datos, los administra el cliente Servicios de datos de WCF. Para obtener más información, vea [actualizar el servicio de datos](updating-the-data-service-wcf-data-services.md).  
  
 <xref:System.Data.Services.Client.DataServiceContext> realiza el seguimiento de los cambios realizados en los objetos notificados manualmente utilizando <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A> y <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A> o mediante <xref:System.Data.Services.Client.DataServiceCollection%601>. Cuando se llama al método <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, el cliente envía de nuevo los cambios al servicio de datos. Se puede producir un error en <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> cuando los cambios de datos en el cliente entran en conflicto con los cambios en el servicio de datos. Cuando esto sucede, debe consultar de nuevo el recurso de entidad para recibir los datos actualizados. Para sobrescribir los cambios en el servicio de datos, ejecute la consulta con la opción de combinación <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Al llamar de nuevo al método <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>, los cambios conservados en el cliente se mantienen en el servicio de datos, siempre que no se hayan realizado otros cambios en el recurso del servicio de datos.  
  
## <a name="saving-changes"></a>Guardar los cambios  

 El seguimiento de los cambios se realiza en la instancia de la clase <xref:System.Data.Services.Client.DataServiceContext>, pero los cambios no se envían al servidor inmediatamente. Una vez que haya efectuado los cambios necesarios de una actividad determinada, llame al método <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> para enviar todos los cambios al servicio de datos. Se devuelve un objeto <xref:System.Data.Services.Client.DataServiceResponse> cuando finaliza la operación <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>. El objeto <xref:System.Data.Services.Client.DataServiceResponse> incluye una secuencia de objetos <xref:System.Data.Services.Client.OperationResponse> que, a su vez, contienen una secuencia de instancias de <xref:System.Data.Services.Client.EntityDescriptor> o <xref:System.Data.Services.Client.LinkDescriptor> que representan los cambios que se guardaron o se intentaron realizar. Cuando se crea o modifica una entidad en el servicio de datos, la instancia de la clase <xref:System.Data.Services.Client.EntityDescriptor> contiene una referencia a la entidad actualizada, que incluye los valores de propiedad generados por el servidor, como el valor de `ProductID` generado en el ejemplo anterior. La biblioteca de cliente actualiza automáticamente el objeto de .NET Framework para que tenga estos nuevos valores.  
  
 En el caso de las operaciones de inserción y actualización correctas, la propiedad de estado del objeto <xref:System.Data.Services.Client.EntityDescriptor> o del objeto <xref:System.Data.Services.Client.LinkDescriptor> asociado a la operación se establece en <xref:System.Data.Services.Client.EntityStates.Unchanged> y los nuevos valores se combinan mediante <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. Cuando una operación de inserción, actualización o eliminación produce un error en el servicio de datos, el estado de la entidad permanece como estaba antes de que se llamara al método <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> y la propiedad <xref:System.Data.Services.Client.OperationResponse.Error%2A> de <xref:System.Data.Services.Client.OperationResponse> se establece en una instancia de <xref:System.Data.Services.Client.DataServiceRequestException> que contiene información sobre el error. Para obtener más información, vea [actualizar el servicio de datos](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Establecer el método HTTP para las actualizaciones  

 De forma predeterminada, la biblioteca cliente de .NET Framework envía actualizaciones a las entidades existentes como solicitudes MERGE. Una solicitud MERGE actualiza las propiedades seleccionadas de la entidad; sin embargo, el cliente siempre incluye todas las propiedades en la solicitud MERGE, incluso las propiedades que no hayan cambiado. El protocolo OData también admite el envío de solicitudes PUT para actualizar entidades. En una solicitud PUT, una entidad existente se reemplaza básicamente por una nueva instancia de la entidad con valores de propiedad desde el cliente. Para usar las solicitudes PUT, establezca la marca del objeto <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> de la enumeración <xref:System.Data.Services.Client.SaveChangesOptions> cuando se llame a <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
> Una solicitud PUT se comportará de forma distinta que una solicitud MERGE cuando el cliente no conozca todas las propiedades de la entidad. Esto puede ocurrir cuando se proyecte un tipo de entidad en un nuevo tipo en el cliente. También puede ocurrir cuando se hayan agregado nuevas propiedades a la entidad del modelo de datos del servicio y la propiedad <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> de la clase <xref:System.Data.Services.Client.DataServiceContext> se establezca en `true` para ignorar tales errores de asignación de cliente. En estos casos, una solicitud PUT restablecerá las propiedades que desconozca el cliente en sus valores predeterminados.  
  
### <a name="post-tunneling"></a>Tunelización POST  

 De forma predeterminada, la biblioteca de cliente envía solicitudes de creación, lectura, actualización y eliminación a un servicio OData mediante los métodos HTTP correspondientes de POST, GET, PUT/MERGE/PATCH y DELETE. Esto mantiene los principios básicos de Transferencia de datos de representación (REST, Representational State Transfer). Sin embargo, no todas las implementaciones del servidor web admiten el conjunto completo de métodos HTTP. En algunos casos, los métodos compatibles podrían estar restringidos solo a GET y POST. Esto puede ocurrir cuando un intermediario, como un firewall, bloquea las solicitudes con ciertos métodos. Dado que los métodos GET y POST se admiten con mayor frecuencia, OData prescribe una manera de ejecutar cualquier método HTTP no admitido mediante una solicitud POST. Conocido como *tunelización de métodos* o *tunelización post*, permite a un cliente enviar una solicitud post con el método real especificado en el `X-HTTP-Method` encabezado personalizado. Para habilitar POST tunelizado para las solicitudes, establezca la propiedad <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> en la instancia de <xref:System.Data.Services.Client.DataServiceContext> en `true`.  
  
## <a name="see-also"></a>Vea también

- [Biblioteca cliente de Data Services de WCF](wcf-data-services-client-library.md)
- [Actualización del servicio de datos](updating-the-data-service-wcf-data-services.md)
- [Operaciones asincrónicas](asynchronous-operations-wcf-data-services.md)
- [Procesamiento por lotes de operaciones](batching-operations-wcf-data-services.md)
