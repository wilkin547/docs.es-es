---
title: Base de datos por microservicio
description: Compare el almacenamiento de datos en aplicaciones monolíticas y nativas en la nube.
author: robvet
ms.date: 01/22/2020
ms.openlocfilehash: e472309d3dc815070fc2d2c220bf4fe00b8c29ae
ms.sourcegitcommit: 13e79efdbd589cad6b1de634f5d6b1262b12ab01
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 01/28/2020
ms.locfileid: "76795066"
---
# <a name="database-per-microservice"></a><span data-ttu-id="a5ade-103">Base de datos por microservicio</span><span class="sxs-lookup"><span data-stu-id="a5ade-103">Database-per-microservice</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="a5ade-104">Como hemos visto en este libro, un enfoque nativo en la nube cambia la manera de diseñar, implementar y administrar aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="a5ade-104">As we've seen throughout this book, a cloud-native approach changes the way you design, deploy, and manage applications.</span></span> <span data-ttu-id="a5ade-105">También cambia la manera de administrar y almacenar los datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-105">It also changes the way you manage and store data.</span></span>

<span data-ttu-id="a5ade-106">En la figura 5-1 se contrastan las diferencias.</span><span class="sxs-lookup"><span data-stu-id="a5ade-106">Figure 5-1 contrasts the differences.</span></span>

![Almacenamiento de datos en aplicaciones nativas de la nube](./media/distributed-data.png)

<span data-ttu-id="a5ade-108">**Figura 5-1**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-108">**Figure 5-1**.</span></span> <span data-ttu-id="a5ade-109">Administración de datos en aplicaciones nativas en la nube</span><span class="sxs-lookup"><span data-stu-id="a5ade-109">Data management in cloud-native applications</span></span>

<span data-ttu-id="a5ade-110">Los desarrolladores experimentados reconocerán fácilmente la arquitectura en el lado izquierdo de la figura 5-1.</span><span class="sxs-lookup"><span data-stu-id="a5ade-110">Experienced developers will easily recognize the architecture on the left-side of figure 5-1.</span></span> <span data-ttu-id="a5ade-111">En esta *aplicación monolítica*, los componentes de servicio empresarial colocar juntos en un nivel de servicios compartidos, compartiendo datos de una única base de datos relacional.</span><span class="sxs-lookup"><span data-stu-id="a5ade-111">In this *monolithic application*, business service components collocate together in a shared services tier, sharing data from a single relational database.</span></span>

<span data-ttu-id="a5ade-112">En muchos sentidos, una sola base de datos mantiene la administración de datos simple.</span><span class="sxs-lookup"><span data-stu-id="a5ade-112">In many ways, a single database keeps data management simple.</span></span> <span data-ttu-id="a5ade-113">La consulta de datos en varias tablas es sencilla.</span><span class="sxs-lookup"><span data-stu-id="a5ade-113">Querying data across multiple tables is straightforward.</span></span> <span data-ttu-id="a5ade-114">Cambios en la actualización de datos juntos o en todas las reversiones.</span><span class="sxs-lookup"><span data-stu-id="a5ade-114">Changes to data update together or they all rollback.</span></span> <span data-ttu-id="a5ade-115">[Las transacciones ACID](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) garantizan una coherencia fuerte y inmediata.</span><span class="sxs-lookup"><span data-stu-id="a5ade-115">[ACID transactions](https://docs.microsoft.com/windows/desktop/cossdk/acid-properties) guarantee strong and immediate consistency.</span></span>

<span data-ttu-id="a5ade-116">Al diseñar para la nube nativa, adoptamos un enfoque diferente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-116">Designing for cloud-native, we take a different approach.</span></span> <span data-ttu-id="a5ade-117">En el lado derecho de la figura 5-1, observe cómo la funcionalidad empresarial se segrega en microservicios pequeños e independientes.</span><span class="sxs-lookup"><span data-stu-id="a5ade-117">On the right-side of Figure 5-1, note how business functionality segregates into small, independent microservices.</span></span> <span data-ttu-id="a5ade-118">Cada microservicio encapsula una funcionalidad empresarial específica y sus propios datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-118">Each microservice encapsulates a specific business capability and its own data.</span></span> <span data-ttu-id="a5ade-119">La base de datos monolítica se descompone en un modelo de datos distribuido con muchas bases de datos más pequeñas, cada una de las cuales se alinea con un microservicio.</span><span class="sxs-lookup"><span data-stu-id="a5ade-119">The monolithic database decomposes into a distributed data model with many smaller databases, each aligning with a microservice.</span></span> <span data-ttu-id="a5ade-120">Cuando el humo se borra, surge un diseño que expone una *base de datos por microservicio*.</span><span class="sxs-lookup"><span data-stu-id="a5ade-120">When the smoke clears, we emerge with a design that exposes a *database per microservice*.</span></span>

## <a name="why"></a><span data-ttu-id="a5ade-121">¿Por qué?</span><span class="sxs-lookup"><span data-stu-id="a5ade-121">Why?</span></span>

<span data-ttu-id="a5ade-122">Esta base de datos por microservicio proporciona muchas ventajas, especialmente para los sistemas que deben evolucionar rápidamente y admiten una escala masiva.</span><span class="sxs-lookup"><span data-stu-id="a5ade-122">This database per microservice provides many benefits, especially for systems that must evolve rapidly and support massive scale.</span></span> <span data-ttu-id="a5ade-123">Con este modelo...</span><span class="sxs-lookup"><span data-stu-id="a5ade-123">With this model...</span></span>

- <span data-ttu-id="a5ade-124">Los datos del dominio se encapsulan dentro del servicio</span><span class="sxs-lookup"><span data-stu-id="a5ade-124">Domain data is encapsulated within the service</span></span>
- <span data-ttu-id="a5ade-125">El esquema de datos puede evolucionar sin afectar directamente a otros servicios</span><span class="sxs-lookup"><span data-stu-id="a5ade-125">Data schema can evolve without directly impacting other services</span></span>
- <span data-ttu-id="a5ade-126">Cada almacén de datos puede escalarse de forma independiente</span><span class="sxs-lookup"><span data-stu-id="a5ade-126">Each data store can independently scale</span></span>
- <span data-ttu-id="a5ade-127">Un error del almacén de datos en un servicio no afecta directamente A otros servicios</span><span class="sxs-lookup"><span data-stu-id="a5ade-127">A data store failure in one service won't directly impact other services</span></span>

<span data-ttu-id="a5ade-128">La segregación de datos también permite a cada microservicio implementar el tipo de almacén de datos que se optimiza mejor para su carga de trabajo, sus necesidades de almacenamiento y patrones de lectura y escritura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-128">Segregating data also enables each microservice to implement the data store type that is best optimized for its workload, storage needs, and read/write patterns.</span></span> <span data-ttu-id="a5ade-129">Entre las opciones se incluyen los almacenes de datos relacionales, de documentos, de clave-valor e incluso de gráficos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-129">Choices include relational, document, key-value, and even graph-based data stores.</span></span>

<span data-ttu-id="a5ade-130">La figura 5-2 presenta el principio de la persistencia de Polyglot en un sistema nativo en la nube.</span><span class="sxs-lookup"><span data-stu-id="a5ade-130">Figure 5-2 presents the principle of polyglot persistence in a cloud-native system.</span></span>

![Persistencia de datos de Polyglot](./media/polyglot-data-persistence.png)

<span data-ttu-id="a5ade-132">**Figura 5-2**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-132">**Figure 5-2**.</span></span> <span data-ttu-id="a5ade-133">Persistencia de datos de Polyglot</span><span class="sxs-lookup"><span data-stu-id="a5ade-133">Polyglot data persistence</span></span>

<span data-ttu-id="a5ade-134">Observe en la ilustración anterior cómo cada microservicio admite un tipo de almacén de datos diferente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-134">Note in the previous figure how each microservice supports a different type of data store.</span></span>

- <span data-ttu-id="a5ade-135">El microservicio del catálogo de productos consume una base de datos relacional para dar cabida a la estructura relacional enriquecida de sus datos subyacentes.</span><span class="sxs-lookup"><span data-stu-id="a5ade-135">The product catalog microservice consumes a relational database to accommodate the rich relational structure of its underlying data.</span></span>
- <span data-ttu-id="a5ade-136">El microservicio de carro de la compra consume una caché distribuida que admite su simple almacén de datos de clave-valor.</span><span class="sxs-lookup"><span data-stu-id="a5ade-136">The shopping cart microservice consumes a distributed cache that supports its simple, key-value data store.</span></span>
- <span data-ttu-id="a5ade-137">El microservicio de pedidos consume una base de datos de documentos NoSql para operaciones de escritura junto con un almacén de clave/valor muy desnormalizado para acomodar grandes volúmenes de operaciones de lectura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-137">The ordering microservice consumes both a NoSql document database for write operations along with a highly denormalized key/value store to accommodate high-volumes of read operations.</span></span>
  
<span data-ttu-id="a5ade-138">Aunque las bases de datos relacionales siguen siendo relevantes para los microservicios con datos complejos, las bases de datos NoSQL han ganado una popularidad considerable.</span><span class="sxs-lookup"><span data-stu-id="a5ade-138">While relational databases remain relevant for microservices with complex data, NoSQL databases have gained considerable popularity.</span></span> <span data-ttu-id="a5ade-139">Proporcionan escalado masivo y alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="a5ade-139">They provide massive scale and high availability.</span></span> <span data-ttu-id="a5ade-140">Su naturaleza sin esquema permite a los desarrolladores salir de una arquitectura de clases de datos con tipo y ORM que hacen que los cambios sean costosos y lentos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-140">Their schemaless nature allows developers to move away from an architecture of typed data classes and ORMs that make change expensive and time-consuming.</span></span> <span data-ttu-id="a5ade-141">En este capítulo se tratan las bases de datos NoSQL.</span><span class="sxs-lookup"><span data-stu-id="a5ade-141">We cover NoSQL databases later in this chapter.</span></span>

 <span data-ttu-id="a5ade-142">Aunque encapsular los datos en microservicios independientes puede aumentar la agilidad, el rendimiento y la escalabilidad, también presenta muchos desafíos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-142">While encapsulating  data into separate microservices can increase agility, performance, and scalability, it also presents many challenges.</span></span> <span data-ttu-id="a5ade-143">En la siguiente sección, trataremos estos desafíos junto con patrones y prácticas para ayudarle a superarlos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-143">In the next section, we discuss these challenges along with patterns and practices to help overcome them.</span></span>  

## <a name="cross-service-queries"></a><span data-ttu-id="a5ade-144">Consultas entre servicios</span><span class="sxs-lookup"><span data-stu-id="a5ade-144">Cross-service queries</span></span>

<span data-ttu-id="a5ade-145">Aunque los microservicios son independientes y se centran en funcionalidades funcionales específicas, como el inventario, el envío o la ordenación, con frecuencia requieren la integración con otros microservicios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-145">While microservices are independent and focus on specific functional capabilities, like inventory, shipping, or ordering, they frequently require integration with other microservices.</span></span> <span data-ttu-id="a5ade-146">A menudo, la integración implica que un microservicio *consulte* a otro los datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-146">Often the integration involves one microservice *querying* another for data.</span></span> <span data-ttu-id="a5ade-147">En la figura 5-3 se muestra el escenario.</span><span class="sxs-lookup"><span data-stu-id="a5ade-147">Figure 5-3 shows the scenario.</span></span>

![Consultas entre microservicios](./media/cross-service-query.png)

<span data-ttu-id="a5ade-149">**Figura 5-3**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-149">**Figure 5-3**.</span></span> <span data-ttu-id="a5ade-150">Consultas entre microservicios</span><span class="sxs-lookup"><span data-stu-id="a5ade-150">Querying across microservices</span></span>

<span data-ttu-id="a5ade-151">En la ilustración anterior, vemos un microservicio de cesta de la compra que agrega un artículo a la cesta de la compra de un usuario.</span><span class="sxs-lookup"><span data-stu-id="a5ade-151">In the preceding figure, we see a shopping basket microservice that adds an item to a user's shopping basket.</span></span> <span data-ttu-id="a5ade-152">Mientras que el almacén de datos para este microservicio contiene datos de cesta y de elemento de línea, no mantiene los datos de productos o de precios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-152">While the data store for this microservice contains basket and line item data, it doesn't maintain product or pricing data.</span></span> <span data-ttu-id="a5ade-153">En su lugar, los elementos de datos son propiedad de los microservicios de catálogo y de precios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-153">Instead, those data items are owned by the catalog and pricing microservices.</span></span> <span data-ttu-id="a5ade-154">Esto supone un problema.</span><span class="sxs-lookup"><span data-stu-id="a5ade-154">This presents a problem.</span></span> <span data-ttu-id="a5ade-155">¿Cómo puede el microservicio de cesta de la compra agregar un producto a la cesta de la compra del usuario cuando no tiene datos de productos ni de precios en su base de datos?</span><span class="sxs-lookup"><span data-stu-id="a5ade-155">How can the shopping basket microservice add a product to the user's shopping basket when it doesn't have product nor pricing data in its database?</span></span>

<span data-ttu-id="a5ade-156">Una opción que se describe en el capítulo 4 es una [llamada http directa](service-to-service-communication.md#queries) desde la cesta de la compra al catálogo y los microservicios de precios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-156">One option discussed in Chapter 4 is a [direct HTTP call](service-to-service-communication.md#queries) from the shopping basket to the catalog and pricing microservices.</span></span> <span data-ttu-id="a5ade-157">Sin embargo, en el capítulo 4, hemos mencionado que las *llamadas http* sincrónicas unen microservicios, lo que reduce su autonomía y reduce sus ventajas arquitectónicas.</span><span class="sxs-lookup"><span data-stu-id="a5ade-157">However, in chapter 4, we said synchronous HTTP calls *couple* microservices together, reducing their autonomy and diminishing their architectural benefits.</span></span>

<span data-ttu-id="a5ade-158">También se puede implementar un patrón de solicitud-respuesta con colas de entrada y salida independientes para cada servicio.</span><span class="sxs-lookup"><span data-stu-id="a5ade-158">We could also implement a request-reply pattern with separate inbound and outbound queues for each service.</span></span> <span data-ttu-id="a5ade-159">Sin embargo, este patrón es complicado y requiere la fontanería para correlacionar los mensajes de solicitud y respuesta.</span><span class="sxs-lookup"><span data-stu-id="a5ade-159">However, this pattern is complicated and requires plumbing to correlate request and response messages.</span></span>
<span data-ttu-id="a5ade-160">Aunque Desacople las llamadas de microservicios de back-end, el servicio de llamada debe esperar de forma sincrónica a que se complete la llamada.</span><span class="sxs-lookup"><span data-stu-id="a5ade-160">While it does decouple the backend microservice calls, the calling service must still synchronously wait for the call to complete.</span></span> <span data-ttu-id="a5ade-161">La congestión de la red, los errores transitorios o un microservicio sobrecargado y pueden dar lugar a operaciones de ejecución prolongada e incluso con errores.</span><span class="sxs-lookup"><span data-stu-id="a5ade-161">Network congestion, transient faults, or an overloaded microservice and can result in long-running and even failed operations.</span></span>

<span data-ttu-id="a5ade-162">En su lugar, un patrón ampliamente aceptado para quitar las dependencias entre servicios es el [patrón de vista materializada](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), que se muestra en la figura 5-4.</span><span class="sxs-lookup"><span data-stu-id="a5ade-162">Instead, a widely accepted pattern for removing cross-service dependencies is the [Materialized View Pattern](https://docs.microsoft.com/azure/architecture/patterns/materialized-view), shown in Figure 5-4.</span></span>

![Patrón de vista materializada](./media/materialized-view-pattern.png)

<span data-ttu-id="a5ade-164">**Figura 5-4**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-164">**Figure 5-4**.</span></span> <span data-ttu-id="a5ade-165">Patrón de vista materializada</span><span class="sxs-lookup"><span data-stu-id="a5ade-165">Materialized View Pattern</span></span>

<span data-ttu-id="a5ade-166">Con este patrón, se coloca una tabla de datos local (conocida como *modelo de lectura*) en el servicio de cesta de la compra.</span><span class="sxs-lookup"><span data-stu-id="a5ade-166">With this pattern, you place a local data table (known as a *read model*) in the shopping basket service.</span></span> <span data-ttu-id="a5ade-167">Esta tabla contiene una copia desnormalizada de los datos necesarios de los microservicios de productos y precios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-167">This table contains a denormalized copy of the data needed from the product and pricing microservices.</span></span> <span data-ttu-id="a5ade-168">Copiar los datos directamente en el microservicio de la cesta de la compra elimina la necesidad de costosas llamadas entre servicios.</span><span class="sxs-lookup"><span data-stu-id="a5ade-168">Copying the data directly into the shopping basket microservice eliminates the need for expensive cross-service calls.</span></span> <span data-ttu-id="a5ade-169">Con los datos locales del servicio, mejora el tiempo de respuesta y la confiabilidad del servicio.</span><span class="sxs-lookup"><span data-stu-id="a5ade-169">With the data local to the service, you improve the service's response time and reliability.</span></span> <span data-ttu-id="a5ade-170">Además, tener su propia copia de los datos hace que el servicio de la cesta de la compra sea más resistente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-170">Additionally, having its own copy of the data makes the shopping basket service more resilient.</span></span> <span data-ttu-id="a5ade-171">Si el servicio de catálogo debe dejar de estar disponible, no afectará directamente al servicio de cesta de la compra.</span><span class="sxs-lookup"><span data-stu-id="a5ade-171">If the catalog service should become unavailable, it wouldn't directly impact the shopping basket service.</span></span> <span data-ttu-id="a5ade-172">La cesta de la compra puede seguir operando con los datos de su propio almacén.</span><span class="sxs-lookup"><span data-stu-id="a5ade-172">The shopping basket can continue operating with the data from its own store.</span></span> 

<span data-ttu-id="a5ade-173">La detección con este enfoque es que ahora tiene datos duplicados en el sistema.</span><span class="sxs-lookup"><span data-stu-id="a5ade-173">The catch with this approach is that you now have duplicate data in your system.</span></span> <span data-ttu-id="a5ade-174">Sin embargo, la duplicación *estratégica* de datos en sistemas nativos en la nube es una práctica establecida que no se considera un antipatrón, o una práctica incorrecta.</span><span class="sxs-lookup"><span data-stu-id="a5ade-174">However, *strategically* duplicating data in cloud-native systems is an established practice and not considered an anti-pattern, or bad practice.</span></span> <span data-ttu-id="a5ade-175">Tenga en cuenta que solo un *servicio* puede poseer un conjunto de datos y tener autoridad sobre él.</span><span class="sxs-lookup"><span data-stu-id="a5ade-175">Keep in mind that *one and only one service* can own a data set and have authority over it.</span></span> <span data-ttu-id="a5ade-176">Deberá sincronizar los modelos de lectura cuando se actualice el sistema de registro.</span><span class="sxs-lookup"><span data-stu-id="a5ade-176">You'll need to synchronize the read models when the system of record is updated.</span></span> <span data-ttu-id="a5ade-177">La sincronización se implementa normalmente mediante mensajería asincrónica con un [patrón de publicación/suscripción](service-to-service-communication.md#events), como se muestra en la figura 5,4.</span><span class="sxs-lookup"><span data-stu-id="a5ade-177">Synchronization is typically implemented via asynchronous messaging with a [publish/subscribe pattern](service-to-service-communication.md#events), as shown in Figure 5.4.</span></span>

## <a name="distributed-transactions"></a><span data-ttu-id="a5ade-178">Transacciones distribuidas</span><span class="sxs-lookup"><span data-stu-id="a5ade-178">Distributed transactions</span></span>

<span data-ttu-id="a5ade-179">Aunque la consulta de datos entre microservicios es difícil, implementar una transacción en varios microservicios es incluso más complejo.</span><span class="sxs-lookup"><span data-stu-id="a5ade-179">While querying data across microservices is difficult, implementing a transaction across several microservices is even more complex.</span></span> <span data-ttu-id="a5ade-180">El reto inherente de mantener la coherencia de los datos en orígenes de datos independientes en diferentes microservicios no puede estar desutilizado.</span><span class="sxs-lookup"><span data-stu-id="a5ade-180">The inherent challenge of maintaining data consistency across independent data sources in different microservices can't be understated.</span></span> <span data-ttu-id="a5ade-181">La falta de transacciones distribuidas en aplicaciones nativas de la nube significa que debe administrar mediante programación las transacciones distribuidas.</span><span class="sxs-lookup"><span data-stu-id="a5ade-181">The lack of distributed transactions in cloud-native applications means that you must manage distributed transactions programmatically.</span></span> <span data-ttu-id="a5ade-182">Puede pasar de un mundo de *coherencia inmediata* a la *coherencia final*.</span><span class="sxs-lookup"><span data-stu-id="a5ade-182">You move from a world of *immediate consistency* to that of *eventual consistency*.</span></span>

<span data-ttu-id="a5ade-183">En la figura 5-5 se muestra el problema.</span><span class="sxs-lookup"><span data-stu-id="a5ade-183">Figure 5-5 shows the problem.</span></span>

![Transacción en el patrón saga](./media/saga-transaction-operation.png)

<span data-ttu-id="a5ade-185">**Figura 5-5**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-185">**Figure 5-5**.</span></span> <span data-ttu-id="a5ade-186">Implementar una transacción entre microservicios</span><span class="sxs-lookup"><span data-stu-id="a5ade-186">Implementing a transaction across microservices</span></span>

<span data-ttu-id="a5ade-187">En la ilustración anterior, cinco microservicios independientes participan en una transacción distribuida que crea un pedido.</span><span class="sxs-lookup"><span data-stu-id="a5ade-187">In the preceding figure, five independent microservices participate in a distributed transaction that creates an order.</span></span> <span data-ttu-id="a5ade-188">Cada microservicio mantiene su propio almacén de datos e implementa una transacción local para su almacén.</span><span class="sxs-lookup"><span data-stu-id="a5ade-188">Each microservice maintains its own data store and implements a local transaction for its store.</span></span> <span data-ttu-id="a5ade-189">Para crear el pedido, la transacción local para *cada* microservicio individual debe realizarse correctamente, o *todas* deben anular y revertir la operación.</span><span class="sxs-lookup"><span data-stu-id="a5ade-189">To create the order, the local transaction for *each* individual microservice must succeed, or *all* must abort and roll back the operation.</span></span> <span data-ttu-id="a5ade-190">Aunque la compatibilidad con transacciones integrada está disponible dentro de cada uno de los microservicios, no hay compatibilidad con una transacción distribuida que abarcaría entre los cinco servicios para mantener la coherencia de los datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-190">While built-in transactional support is available inside each of the microservices, there's no support for a distributed transaction that would span across all five services to keep data consistent.</span></span>

<span data-ttu-id="a5ade-191">En su lugar, debe construir esta transacción distribuida *mediante programación*.</span><span class="sxs-lookup"><span data-stu-id="a5ade-191">Instead, you must construct this distributed transaction *programmatically*.</span></span>

<span data-ttu-id="a5ade-192">Un patrón popular para agregar compatibilidad transaccional distribuida es el patrón saga.</span><span class="sxs-lookup"><span data-stu-id="a5ade-192">A popular pattern for adding distributed transactional support is the Saga pattern.</span></span> <span data-ttu-id="a5ade-193">Se implementa agrupando las transacciones locales mediante programación y invocando secuencialmente cada una de ellas.</span><span class="sxs-lookup"><span data-stu-id="a5ade-193">It's implemented by grouping local transactions together programmatically and sequentially invoking each one.</span></span> <span data-ttu-id="a5ade-194">Si se produce un error en cualquiera de las transacciones locales, el saga anula la operación e invoca un conjunto de [transacciones de compensación](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span><span class="sxs-lookup"><span data-stu-id="a5ade-194">If any of the local transactions fail, the Saga aborts the operation and invokes a set of [compensating transactions](https://docs.microsoft.com/azure/architecture/patterns/compensating-transaction).</span></span> <span data-ttu-id="a5ade-195">Las transacciones de compensación deshacen los cambios realizados por las transacciones locales anteriores y restauran la coherencia de los datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-195">The compensating transactions undo the changes made by the preceding local transactions and restore data consistency.</span></span> <span data-ttu-id="a5ade-196">En la figura 5-6 se muestra una transacción con error con el patrón saga.</span><span class="sxs-lookup"><span data-stu-id="a5ade-196">Figure 5-6 shows a failed transaction with the Saga pattern.</span></span>

![Reversión en el patrón saga](./media/saga-rollback-operation.png)

<span data-ttu-id="a5ade-198">**Figura 5-6**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-198">**Figure 5-6**.</span></span> <span data-ttu-id="a5ade-199">Deshacer una transacción</span><span class="sxs-lookup"><span data-stu-id="a5ade-199">Rolling back a transaction</span></span>

<span data-ttu-id="a5ade-200">En la ilustración anterior, se produjo un error en la operación de *actualización de inventario* en el microservicio de inventario.</span><span class="sxs-lookup"><span data-stu-id="a5ade-200">In the previous figure, the *Update Inventory* operation has failed in the Inventory microservice.</span></span> <span data-ttu-id="a5ade-201">Saga invoca un conjunto de transacciones de compensación (en rojo) para ajustar los recuentos de inventario, cancelar el pago y el pedido y devolver los datos de cada microservicio a un estado coherente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-201">The Saga invokes a set of compensating transactions (in red) to adjust the inventory counts, cancel the payment and the order, and return the data for each microservice back to a consistent state.</span></span>

<span data-ttu-id="a5ade-202">Los patrones saga normalmente se sencillamenten como una serie de eventos relacionados, o bien se organizan como un conjunto de comandos relacionados.</span><span class="sxs-lookup"><span data-stu-id="a5ade-202">Saga patterns are typically choreographed as a series of related events, or orchestrated as a set of related commands.</span></span> <span data-ttu-id="a5ade-203">En el capítulo 4, analizamos el patrón Service Aggregator que sería la base de una implementación de saga orquestada.</span><span class="sxs-lookup"><span data-stu-id="a5ade-203">In Chapter 4, we discussed the service aggregator pattern that would be the foundation for an orchestrated saga implementation.</span></span> <span data-ttu-id="a5ade-204">También hemos analizado los eventos junto con temas de Azure Service Bus y Azure Event Grid que serían una base para una implementación de sencillamente saga.</span><span class="sxs-lookup"><span data-stu-id="a5ade-204">We also discussed eventing along with Azure Service Bus and Azure Event Grid topics that would be a foundation for a choreographed saga implementation.</span></span>

## <a name="high-volume-data"></a><span data-ttu-id="a5ade-205">Datos de gran volumen</span><span class="sxs-lookup"><span data-stu-id="a5ade-205">High volume data</span></span>

<span data-ttu-id="a5ade-206">Las aplicaciones nativas en la nube de gran tamaño suelen admitir los requisitos de datos de gran volumen.</span><span class="sxs-lookup"><span data-stu-id="a5ade-206">Large cloud-native applications often support high-volume data requirements.</span></span> <span data-ttu-id="a5ade-207">En estos casos, las técnicas tradicionales de almacenamiento de datos pueden producir cuellos de botella.</span><span class="sxs-lookup"><span data-stu-id="a5ade-207">In these scenarios, traditional data storage techniques can cause bottlenecks.</span></span> <span data-ttu-id="a5ade-208">En el caso de los sistemas complejos que se implementan a gran escala, segregación de responsabilidades de comandos y consultas (CQRS) y el abastecimiento de eventos pueden mejorar el rendimiento de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="a5ade-208">For complex systems that deploy on a large scale, both Command and Query Responsibility Segregation (CQRS) and Event Sourcing may improve application performance.</span></span>  

### <a name="cqrs"></a><span data-ttu-id="a5ade-209">CQRS</span><span class="sxs-lookup"><span data-stu-id="a5ade-209">CQRS</span></span>

<span data-ttu-id="a5ade-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs)es un patrón arquitectónico que puede ayudar a maximizar el rendimiento, la escalabilidad y la seguridad.</span><span class="sxs-lookup"><span data-stu-id="a5ade-210">[CQRS](https://docs.microsoft.com/azure/architecture/patterns/cqrs), is an architectural pattern that can help maximize performance, scalability, and security.</span></span> <span data-ttu-id="a5ade-211">El patrón separa las operaciones que leen datos de las operaciones que escriben datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-211">The pattern separates operations that read data from those operations that write data.</span></span> 

<span data-ttu-id="a5ade-212">En los escenarios normales, se usan el mismo modelo de entidad y el mismo objeto de repositorio de datos para las operaciones *de lectura y* escritura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-212">For normal scenarios, the same entity model and data repository object are used for *both* read and write operations.</span></span>

<span data-ttu-id="a5ade-213">Sin embargo, un escenario de datos de gran volumen puede beneficiarse de modelos independientes y tablas de datos para lecturas y escrituras.</span><span class="sxs-lookup"><span data-stu-id="a5ade-213">However, a high volume data scenario can benefit from separate models and data tables for reads and writes.</span></span> <span data-ttu-id="a5ade-214">Para mejorar el rendimiento, la operación de lectura puede realizar consultas en una representación muy desnormalizada de los datos para evitar combinaciones de tablas repetitivas y bloqueos de tabla.</span><span class="sxs-lookup"><span data-stu-id="a5ade-214">To improve performance, the read operation could query against a highly denormalized representation of the data to avoid expensive repetitive table joins and table locks.</span></span> <span data-ttu-id="a5ade-215">La operación de *escritura* , conocida como *comando*, se actualizaría contra una representación totalmente normalizada de los datos que garantizarían la coherencia.</span><span class="sxs-lookup"><span data-stu-id="a5ade-215">The *write* operation, known as a *command*, would update against a fully normalized representation of the data that would guarantee consistency.</span></span> <span data-ttu-id="a5ade-216">A continuación, debe implementar un mecanismo para mantener ambas representaciones sincronizadas. Normalmente, siempre que se modifica la tabla de escritura, se publica un evento que replica la modificación en la tabla de lectura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-216">You then need to implement a mechanism to keep both representations in sync. Typically, whenever the write table is modified, it publishes an event that replicates the modification to the read table.</span></span>

<span data-ttu-id="a5ade-217">En la figura 5-7 se muestra una implementación del patrón CQRS.</span><span class="sxs-lookup"><span data-stu-id="a5ade-217">Figure 5-7 shows an implementation of the CQRS pattern.</span></span>

![segregación de responsabilidades de comandos y consultas](./media/cqrs-implementation.png)

<span data-ttu-id="a5ade-219">**Figura 5-7**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-219">**Figure 5-7**.</span></span> <span data-ttu-id="a5ade-220">Implementación de CQRS</span><span class="sxs-lookup"><span data-stu-id="a5ade-220">CQRS implementation</span></span>

<span data-ttu-id="a5ade-221">En la ilustración anterior, se implementan los modelos de comando y consulta independientes.</span><span class="sxs-lookup"><span data-stu-id="a5ade-221">In the previous figure, separate command and query models are implemented.</span></span> <span data-ttu-id="a5ade-222">Cada operación de escritura de datos se guarda en el almacén de escritura y, a continuación, se propaga al almacén de lectura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-222">Each data write operation is saved to the write store and then propagated to the read store.</span></span> <span data-ttu-id="a5ade-223">Preste mucha atención a cómo funciona el proceso de propagación de datos en el principio de [coherencia eventual](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span><span class="sxs-lookup"><span data-stu-id="a5ade-223">Pay close attention to how the data propagation process operates on the principle of [eventual consistency](http://www.cloudcomputingpatterns.org/eventual_consistency/).</span></span> <span data-ttu-id="a5ade-224">El modelo de lectura finalmente se sincroniza con el modelo de escritura, pero puede haber algún retraso en el proceso.</span><span class="sxs-lookup"><span data-stu-id="a5ade-224">The read model eventually synchronizes with the write model, but there may be some lag in the process.</span></span> <span data-ttu-id="a5ade-225">Analizamos la coherencia final en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-225">We discuss eventual consistency in the next section.</span></span>

<span data-ttu-id="a5ade-226">Esta separación permite que las lecturas y escrituras se escalen de forma independiente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-226">This separation enables reads and writes to scale independently.</span></span> <span data-ttu-id="a5ade-227">Las operaciones de lectura utilizan un esquema optimizado para las consultas, mientras que las escrituras usan un esquema optimizado para las actualizaciones.</span><span class="sxs-lookup"><span data-stu-id="a5ade-227">Read operations use a schema optimized for queries, while the writes use a schema optimized for updates.</span></span> <span data-ttu-id="a5ade-228">Las consultas de lectura incluyen datos desnormalizados, mientras que la lógica de negocios compleja se puede aplicar al modelo de escritura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-228">Read queries go against denormalized data, while complex business logic can be applied to the write model.</span></span> <span data-ttu-id="a5ade-229">También puede imponer una seguridad más estricta en las operaciones de escritura que las que exponen lecturas.</span><span class="sxs-lookup"><span data-stu-id="a5ade-229">As well, you might impose tighter security on write operations than those exposing reads.</span></span>

<span data-ttu-id="a5ade-230">La implementación de CQRS puede mejorar el rendimiento de las aplicaciones para los servicios nativos de la nube.</span><span class="sxs-lookup"><span data-stu-id="a5ade-230">Implementing CQRS can improve application performance for cloud-native services.</span></span> <span data-ttu-id="a5ade-231">Sin embargo, da como resultado un diseño más complejo.</span><span class="sxs-lookup"><span data-stu-id="a5ade-231">However, it does result in a more complex design.</span></span> <span data-ttu-id="a5ade-232">Aplique este principio con cuidado y de forma estratégica a las secciones de la aplicación nativa en la nube que se beneficiarán de ella.</span><span class="sxs-lookup"><span data-stu-id="a5ade-232">Apply this principle carefully and strategically to those sections of your cloud-native application that will benefit from it.</span></span> <span data-ttu-id="a5ade-233">Para obtener más información sobre CQRS, vea el libro [de Microsoft microservicios de .net: arquitectura para aplicaciones .net en contenedor](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span><span class="sxs-lookup"><span data-stu-id="a5ade-233">For more on CQRS, see the Microsoft book [.NET Microservices: Architecture for Containerized .NET Applications](https://docs.microsoft.com/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/apply-simplified-microservice-cqrs-ddd-patterns).</span></span>

### <a name="event-sourcing"></a><span data-ttu-id="a5ade-234">Origen de eventos</span><span class="sxs-lookup"><span data-stu-id="a5ade-234">Event sourcing</span></span>

<span data-ttu-id="a5ade-235">Otro enfoque para optimizar los escenarios de datos de gran volumen implica el [suministro de eventos](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span><span class="sxs-lookup"><span data-stu-id="a5ade-235">Another approach to optimizing high volume data scenarios involves [Event Sourcing](https://docs.microsoft.com/azure/architecture/patterns/event-sourcing).</span></span>

<span data-ttu-id="a5ade-236">Un sistema normalmente almacena el estado actual de una entidad de datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-236">A system typically stores the current state of a data entity.</span></span> <span data-ttu-id="a5ade-237">Si un usuario cambia el número de teléfono, por ejemplo, el registro del cliente se actualiza con el nuevo número.</span><span class="sxs-lookup"><span data-stu-id="a5ade-237">If a user changes their phone number, for example, the customer record is updated with the new number.</span></span> <span data-ttu-id="a5ade-238">Siempre sabemos el estado actual de una entidad de datos, pero cada actualización sobrescribe el estado anterior.</span><span class="sxs-lookup"><span data-stu-id="a5ade-238">We always know the current state of a data entity, but each update overwrites the previous state.</span></span> 

<span data-ttu-id="a5ade-239">En la mayoría de los casos, este modelo funciona bien.</span><span class="sxs-lookup"><span data-stu-id="a5ade-239">In most cases, this model works fine.</span></span> <span data-ttu-id="a5ade-240">Sin embargo, en los sistemas de gran volumen, la sobrecarga del bloqueo transaccional y las operaciones de actualización frecuentes pueden afectar al rendimiento de la base de datos, la capacidad de respuesta y la escalabilidad del límite.</span><span class="sxs-lookup"><span data-stu-id="a5ade-240">In high volume systems, however, overhead from transactional locking and frequent update operations can impact database performance, responsiveness, and limit scalability.</span></span>

<span data-ttu-id="a5ade-241">El suministro de eventos adopta un enfoque diferente para capturar datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-241">Event Sourcing takes a different approach to capturing data.</span></span> <span data-ttu-id="a5ade-242">Cada operación que afecta a los datos se conserva en un almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-242">Each operation that affects data is persisted to an event store.</span></span> <span data-ttu-id="a5ade-243">En lugar de actualizar el estado de un registro de datos, se anexa cada cambio a una lista secuencial de eventos pasados, similar a la contabilidad de un contable.</span><span class="sxs-lookup"><span data-stu-id="a5ade-243">Instead of updating the state of a data record, we append each change to a sequential list of past events - similar to an accountant's ledger.</span></span> <span data-ttu-id="a5ade-244">El almacén de eventos se convierte en el sistema de registro de los datos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-244">The Event Store becomes the system of record for the data.</span></span> <span data-ttu-id="a5ade-245">Se usa para propagar varias vistas materializadas en el contexto enlazado de un microservicio.</span><span class="sxs-lookup"><span data-stu-id="a5ade-245">It's used to propagate various materialized views within the bounded context of a microservice.</span></span> <span data-ttu-id="a5ade-246">En la figura 5,8 se muestra el patrón.</span><span class="sxs-lookup"><span data-stu-id="a5ade-246">Figure 5.8 shows the pattern.</span></span>

![Origen de eventos](./media/event-sourcing.png)

<span data-ttu-id="a5ade-248">**Figura 5-8**.</span><span class="sxs-lookup"><span data-stu-id="a5ade-248">**Figure 5-8**.</span></span> <span data-ttu-id="a5ade-249">Origen de eventos</span><span class="sxs-lookup"><span data-stu-id="a5ade-249">Event Sourcing</span></span>

<span data-ttu-id="a5ade-250">En la ilustración anterior, observe cómo cada entrada (en azul) del carro de la compra de un usuario se anexa a un almacén de eventos subyacente.</span><span class="sxs-lookup"><span data-stu-id="a5ade-250">In the previous figure, note how each entry (in blue) for a user's shopping cart is appended to an underlying event store.</span></span> <span data-ttu-id="a5ade-251">En la vista materializada adyacente, el sistema proyecta el estado actual mediante la reproducción de todos los eventos asociados a cada carro de la compra.</span><span class="sxs-lookup"><span data-stu-id="a5ade-251">In the adjoining materialized view, the system projects the current state by replaying all the events associated with each shopping cart.</span></span> <span data-ttu-id="a5ade-252">Esta vista, o leer modelo, se expone de nuevo a la interfaz de usuario.</span><span class="sxs-lookup"><span data-stu-id="a5ade-252">This view, or read model, is then exposed back to the UI.</span></span> <span data-ttu-id="a5ade-253">Los eventos también se pueden integrar con sistemas y aplicaciones externos o consultarse para determinar el estado actual de una entidad.</span><span class="sxs-lookup"><span data-stu-id="a5ade-253">Events can also be integrated with external systems and applications or queried to determine the current state of an entity.</span></span> <span data-ttu-id="a5ade-254">Con este enfoque, se mantiene el historial.</span><span class="sxs-lookup"><span data-stu-id="a5ade-254">With this approach, you maintain history.</span></span> <span data-ttu-id="a5ade-255">No solo sabe el estado actual de una entidad, sino también cómo llegó a este estado.</span><span class="sxs-lookup"><span data-stu-id="a5ade-255">You know not only the current state of an entity, but also how you reached this state.</span></span>

<span data-ttu-id="a5ade-256">En la conversación mecánica, el suministro de eventos simplifica el modelo de escritura.</span><span class="sxs-lookup"><span data-stu-id="a5ade-256">Mechanically speaking, event sourcing simplifies the write model.</span></span> <span data-ttu-id="a5ade-257">No hay actualizaciones ni eliminaciones.</span><span class="sxs-lookup"><span data-stu-id="a5ade-257">There are no updates or deletes.</span></span> <span data-ttu-id="a5ade-258">Al anexar cada entrada de datos como un evento inmutable, se minimizan los conflictos de contención, bloqueo y simultaneidad asociados a las bases de datos relacionales.</span><span class="sxs-lookup"><span data-stu-id="a5ade-258">Appending each data entry as an immutable event minimizes contention, locking, and concurrency conflicts associated with relational databases.</span></span> <span data-ttu-id="a5ade-259">La creación de modelos de lectura con el patrón de vista materializada le permite desacoplar la vista del modelo de escritura y elegir el mejor almacén de datos para optimizar las necesidades de la interfaz de usuario de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="a5ade-259">Building read models with the materialized view pattern enables you to decouple the view from the write model and choose the best data store to optimize the needs of your application UI.</span></span>

<span data-ttu-id="a5ade-260">Para este patrón, considere un almacén de datos que admita directamente el origen de eventos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-260">For this pattern, consider a data store that directly supports event sourcing.</span></span> <span data-ttu-id="a5ade-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB y RavenDB son buenos candidatos.</span><span class="sxs-lookup"><span data-stu-id="a5ade-261">Azure Cosmos DB, MongoDB, Cassandra, CouchDB, and RavenDB are good candidates.</span></span>

<span data-ttu-id="a5ade-262">Al igual que con todos los patrones y tecnologías, implemente estratégicamente y cuando sea necesario.</span><span class="sxs-lookup"><span data-stu-id="a5ade-262">As with all patterns and technologies, implement strategically and when needed.</span></span> <span data-ttu-id="a5ade-263">Aunque el suministro de eventos puede proporcionar un mayor rendimiento y escalabilidad, se refiere a la complejidad y la curva de aprendizaje.</span><span class="sxs-lookup"><span data-stu-id="a5ade-263">While event sourcing can provide increased performance and scalability, it comes at the expense of complexity and a learning curve.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="a5ade-264">[Anterior](service-mesh-communication-infrastructure.md)
>[Siguiente](relational-vs-nosql-data.md)</span><span class="sxs-lookup"><span data-stu-id="a5ade-264">[Previous](service-mesh-communication-infrastructure.md)
[Next](relational-vs-nosql-data.md)</span></span>
