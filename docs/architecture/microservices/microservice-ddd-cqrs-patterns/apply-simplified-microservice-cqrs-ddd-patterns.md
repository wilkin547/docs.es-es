---
title: Aplicar los patrones CQRS y DDD simplificados en un microservicio
description: Arquitectura de microservicios de .NET para aplicaciones .NET en contenedores | Información sobre la relación general entre patrones DDD y CQRS.
ms.date: 01/13/2021
ms.openlocfilehash: c1a990689a446e2efba48beafe4b55d614b54427
ms.sourcegitcommit: a4cecb7389f02c27e412b743f9189bd2a6dea4d6
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/14/2021
ms.locfileid: "98188964"
---
# <a name="apply-simplified-cqrs-and-ddd-patterns-in-a-microservice"></a><span data-ttu-id="bf956-103">Aplicación de patrones CQRS y DDD simplificados en un microservicio</span><span class="sxs-lookup"><span data-stu-id="bf956-103">Apply simplified CQRS and DDD patterns in a microservice</span></span>

<span data-ttu-id="bf956-104">CQRS es un patrón de arquitectura que separa los modelos para leer y escribir datos.</span><span class="sxs-lookup"><span data-stu-id="bf956-104">CQRS is an architectural pattern that separates the models for reading and writing data.</span></span> <span data-ttu-id="bf956-105">Bertrand Meyer definió originalmente el término relacionado [Separación de consultas y comandos (CQS)](https://martinfowler.com/bliki/CommandQuerySeparation.html) en su libro *Construcción de software orientado a objetos*.</span><span class="sxs-lookup"><span data-stu-id="bf956-105">The related term [Command Query Separation (CQS)](https://martinfowler.com/bliki/CommandQuerySeparation.html) was originally defined by Bertrand Meyer in his book *Object-Oriented Software Construction*.</span></span> <span data-ttu-id="bf956-106">La idea básica es que puede dividir las operaciones de un sistema en dos categorías claramente diferenciadas:</span><span class="sxs-lookup"><span data-stu-id="bf956-106">The basic idea is that you can divide a system's operations into two sharply separated categories:</span></span>

- <span data-ttu-id="bf956-107">Consultas.</span><span class="sxs-lookup"><span data-stu-id="bf956-107">Queries.</span></span> <span data-ttu-id="bf956-108">Estas consultas devuelven un resultado sin cambiar el estado del sistema y no tienen efectos secundarios.</span><span class="sxs-lookup"><span data-stu-id="bf956-108">These queries return a result and do not change the state of the system, and they are free of side effects.</span></span>

- <span data-ttu-id="bf956-109">Comandos.</span><span class="sxs-lookup"><span data-stu-id="bf956-109">Commands.</span></span> <span data-ttu-id="bf956-110">Estos comandos cambian el estado de un sistema.</span><span class="sxs-lookup"><span data-stu-id="bf956-110">These commands change the state of a system.</span></span>

<span data-ttu-id="bf956-111">CQS es un concepto simple: se trata de métodos dentro del mismo objeto que son consultas o comandos.</span><span class="sxs-lookup"><span data-stu-id="bf956-111">CQS is a simple concept: it is about methods within the same object being either queries or commands.</span></span> <span data-ttu-id="bf956-112">Cada método devuelve o transforma el estado, pero no ambas cosas.</span><span class="sxs-lookup"><span data-stu-id="bf956-112">Each method either returns state or mutates state, but not both.</span></span> <span data-ttu-id="bf956-113">Incluso un único objeto de patrón de repositorio puede cumplir con CQS.</span><span class="sxs-lookup"><span data-stu-id="bf956-113">Even a single repository pattern object can comply with CQS.</span></span> <span data-ttu-id="bf956-114">CQS puede considerarse un principio fundamental para CQRS.</span><span class="sxs-lookup"><span data-stu-id="bf956-114">CQS can be considered a foundational principle for CQRS.</span></span>

<span data-ttu-id="bf956-115">Greg Young introdujo el concepto [Segregación de responsabilidad de consultas y comandos (CQRS)](https://martinfowler.com/bliki/CQRS.html), que también lo promocionaron mucho Udi Dahan y otros.</span><span class="sxs-lookup"><span data-stu-id="bf956-115">[Command and Query Responsibility Segregation (CQRS)](https://martinfowler.com/bliki/CQRS.html) was introduced by Greg Young and strongly promoted by Udi Dahan and others.</span></span> <span data-ttu-id="bf956-116">Se basa en el principio CQS, aunque es más detallado.</span><span class="sxs-lookup"><span data-stu-id="bf956-116">It is based on the CQS principle, although it is more detailed.</span></span> <span data-ttu-id="bf956-117">Se puede considerar un patrón basado en comandos y eventos y, opcionalmente, en mensajes asincrónicos.</span><span class="sxs-lookup"><span data-stu-id="bf956-117">It can be considered a pattern based on commands and events plus optionally on asynchronous messages.</span></span> <span data-ttu-id="bf956-118">En muchos casos, CQRS está relacionado con escenarios más avanzados, como tener una base de datos física para operaciones de lectura (consultas) distinta que para operaciones de escritura (actualizaciones).</span><span class="sxs-lookup"><span data-stu-id="bf956-118">In many cases, CQRS is related to more advanced scenarios, like having a different physical database for reads (queries) than for writes (updates).</span></span> <span data-ttu-id="bf956-119">Además, un sistema CQRS más evolucionado podría implementar [Event-Sourcing (ES)](https://martinfowler.com/eaaDev/EventSourcing.html) para la base de datos de las actualizaciones, de modo que solo almacenaría eventos en el modelo del dominio en lugar de almacenar los datos de estado actual.</span><span class="sxs-lookup"><span data-stu-id="bf956-119">Moreover, a more evolved CQRS system might implement [Event-Sourcing (ES)](https://martinfowler.com/eaaDev/EventSourcing.html) for your updates database, so you would only store events in the domain model instead of storing the current-state data.</span></span> <span data-ttu-id="bf956-120">Sin embargo, este enfoque no se utiliza en esta guía.</span><span class="sxs-lookup"><span data-stu-id="bf956-120">However, this approach is not used in this guide.</span></span> <span data-ttu-id="bf956-121">En esta guía se usa el enfoque CQRS más sencillo, que consiste simplemente en separar las consultas de los comandos.</span><span class="sxs-lookup"><span data-stu-id="bf956-121">This guide uses the simplest CQRS approach, which consists of just separating the queries from the commands.</span></span>

<span data-ttu-id="bf956-122">La separación que CQRS persigue se consigue mediante la agrupación de las operaciones de consulta en una capa y de los comandos en otra.</span><span class="sxs-lookup"><span data-stu-id="bf956-122">The separation aspect of CQRS is achieved by grouping query operations in one layer and commands in another layer.</span></span> <span data-ttu-id="bf956-123">Cada capa tiene su propio modelo de datos (tenga en cuenta que decimos modelo, no necesariamente una base de datos diferente) y se basa en su propia combinación de patrones y tecnologías.</span><span class="sxs-lookup"><span data-stu-id="bf956-123">Each layer has its own data model (note that we say model, not necessarily a different database) and is built using its own combination of patterns and technologies.</span></span> <span data-ttu-id="bf956-124">Lo más importante es que las dos capas pueden estar dentro del mismo nivel o microservicio, como en el ejemplo (microservicio de pedidos) usado para esta guía.</span><span class="sxs-lookup"><span data-stu-id="bf956-124">More importantly, the two layers can be within the same tier or microservice, as in the example (ordering microservice) used for this guide.</span></span> <span data-ttu-id="bf956-125">O pueden implementarse en diferentes microservicios o procesos para que se puedan optimizar y escalar horizontalmente por separado sin que una afecte a la otra.</span><span class="sxs-lookup"><span data-stu-id="bf956-125">Or they could be implemented on different microservices or processes so they can be optimized and scaled out separately without affecting one another.</span></span>

<span data-ttu-id="bf956-126">CQRS significa tener dos objetos para una operación de lectura/escritura cuando en otros contextos solo hay uno.</span><span class="sxs-lookup"><span data-stu-id="bf956-126">CQRS means having two objects for a read/write operation where in other contexts there is one.</span></span> <span data-ttu-id="bf956-127">Hay razones para tener una base de datos para las operaciones de lectura sin normalizar, de la cual puede obtener información en la bibliografía sobre CQRS más avanzada.</span><span class="sxs-lookup"><span data-stu-id="bf956-127">There are reasons to have a denormalized reads database, which you can learn about in more advanced CQRS literature.</span></span> <span data-ttu-id="bf956-128">Pero aquí no vamos a usar ese enfoque, ya que el objetivo es tener más flexibilidad en las consultas en lugar de limitar las consultas con las restricciones de patrones de DDD como los agregados.</span><span class="sxs-lookup"><span data-stu-id="bf956-128">But we are not using that approach here, where the goal is to have more flexibility in the queries instead of limiting the queries with constraints from DDD patterns like aggregates.</span></span>

<span data-ttu-id="bf956-129">Un ejemplo de este tipo de servicio es el microservicio de pedidos de la aplicación de referencia de eShopOnContainers.</span><span class="sxs-lookup"><span data-stu-id="bf956-129">An example of this kind of service is the ordering microservice from the eShopOnContainers reference application.</span></span> <span data-ttu-id="bf956-130">Este servicio implementa un microservicio basado en un enfoque simplificado de CQRS.</span><span class="sxs-lookup"><span data-stu-id="bf956-130">This service implements a microservice based on a simplified CQRS approach.</span></span> <span data-ttu-id="bf956-131">Usa un solo origen de datos o base de datos, pero dos modelos lógicos, además de patrones de DDD para el dominio transaccional, como se muestra en la figura 7-2.</span><span class="sxs-lookup"><span data-stu-id="bf956-131">It uses a single data source or database, but two logical models plus DDD patterns for the transactional domain, as shown in Figure 7-2.</span></span>

![Diagrama que muestra un microservicio CQRS y DDD simplificado de alto nivel.](./media/apply-simplified-microservice-cqrs-ddd-patterns/simplified-cqrs-ddd-microservice.png)

<span data-ttu-id="bf956-133">**Figura 7-2**.</span><span class="sxs-lookup"><span data-stu-id="bf956-133">**Figure 7-2**.</span></span> <span data-ttu-id="bf956-134">Microservicio con CQRS simplificado y basado en DDD</span><span class="sxs-lookup"><span data-stu-id="bf956-134">Simplified CQRS- and DDD-based microservice</span></span>

<span data-ttu-id="bf956-135">El microservicio "Ordering" lógico incluye su base de datos Ordering, que puede estar, pero no tiene que estar, en el mismo host de Docker.</span><span class="sxs-lookup"><span data-stu-id="bf956-135">The Logical "Ordering" Microservice includes its Ordering database, which can be, but doesn't have to be, the same Docker host.</span></span> <span data-ttu-id="bf956-136">La presencia de la base de datos en el mismo host de Docker es buena para el desarrollo, pero no para producción.</span><span class="sxs-lookup"><span data-stu-id="bf956-136">Having the database in the same Docker host is good for development, but not for production.</span></span>

<span data-ttu-id="bf956-137">El nivel de aplicación puede ser la propia API web.</span><span class="sxs-lookup"><span data-stu-id="bf956-137">The application layer can be the Web API itself.</span></span> <span data-ttu-id="bf956-138">Aquí, el aspecto de diseño importante es que el microservicio, siguiendo el patrón de CQRS, ha dividido las consultas y los ViewModels (modelos de datos creados especialmente para las aplicaciones cliente) de los comandos, del modelo del dominio y de las transacciones.</span><span class="sxs-lookup"><span data-stu-id="bf956-138">The important design aspect here is that the microservice has split the queries and ViewModels (data models especially created for the client applications) from the commands, domain model, and transactions following the CQRS pattern.</span></span> <span data-ttu-id="bf956-139">Este enfoque mantiene las consultas independientes de las restricciones procedentes de los patrones DDD que solo tienen sentido para las transacciones y las actualizaciones, como se explica en secciones posteriores.</span><span class="sxs-lookup"><span data-stu-id="bf956-139">This approach keeps the queries independent from restrictions and constraints coming from DDD patterns that only make sense for transactions and updates, as explained in later sections.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="bf956-140">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="bf956-140">Additional resources</span></span>

- <span data-ttu-id="bf956-141">**Greg Young. Versioning in an Event Sourced System** (Control de versiones en un sistema con abastecimiento de eventos, libro electrónico en línea gratuito) </span><span class="sxs-lookup"><span data-stu-id="bf956-141">**Greg Young. Versioning in an Event Sourced System** (Free to read online e-book) </span></span>\
   <https://leanpub.com/esversioning/read>

>[!div class="step-by-step"]
><span data-ttu-id="bf956-142">[Anterior](index.md)
>[Siguiente](eshoponcontainers-cqrs-ddd-microservice.md)</span><span class="sxs-lookup"><span data-stu-id="bf956-142">[Previous](index.md)
[Next](eshoponcontainers-cqrs-ddd-microservice.md)</span></span>
