---
title: 'CA1838: evitar parámetros StringBuilder para P/Invoke (análisis de código)'
description: 'Más información sobre la regla de análisis de código CA1838: evitar parámetros StringBuilder para P/Invoke'
ms.date: 08/03/2020
ms.topic: reference
f1_keywords:
- AvoidStringBuilderPInvokeParameters
- CA1838
helpviewer_keywords:
- AvoidStringBuilderPInvokeParameters
- CA1838
author: elinor-fung
ms.author: elfung
ms.openlocfilehash: db981bdd47f01e373c4969848a310033e8964593
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/06/2021
ms.locfileid: "99787687"
---
# <a name="ca1838-avoid-stringbuilder-parameters-for-pinvokes"></a><span data-ttu-id="14d72-103">CA1838: evitar `StringBuilder` parámetros para P/Invoke</span><span class="sxs-lookup"><span data-stu-id="14d72-103">CA1838: Avoid `StringBuilder` parameters for P/Invokes</span></span>

| | <span data-ttu-id="14d72-104">Value</span><span class="sxs-lookup"><span data-stu-id="14d72-104">Value</span></span> |
|-|-|
| <span data-ttu-id="14d72-105">**Identificador de la regla**</span><span class="sxs-lookup"><span data-stu-id="14d72-105">**Rule ID**</span></span> |<span data-ttu-id="14d72-106">CA1838</span><span class="sxs-lookup"><span data-stu-id="14d72-106">CA1838</span></span>|
| <span data-ttu-id="14d72-107">**Categoría**</span><span class="sxs-lookup"><span data-stu-id="14d72-107">**Category**</span></span> |[<span data-ttu-id="14d72-108">Rendimiento</span><span class="sxs-lookup"><span data-stu-id="14d72-108">Performance</span></span>](performance-warnings.md)|
| <span data-ttu-id="14d72-109">**Corrección o interrupción**</span><span class="sxs-lookup"><span data-stu-id="14d72-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="14d72-110">Poco problemático</span><span class="sxs-lookup"><span data-stu-id="14d72-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="14d72-111">Causa</span><span class="sxs-lookup"><span data-stu-id="14d72-111">Cause</span></span>

<span data-ttu-id="14d72-112">[P/Invoke](../../../standard/native-interop/pinvoke.md) tiene un <xref:System.Text.StringBuilder> parámetro.</span><span class="sxs-lookup"><span data-stu-id="14d72-112">A [P/Invoke](../../../standard/native-interop/pinvoke.md) has a <xref:System.Text.StringBuilder> parameter.</span></span>

## <a name="rule-description"></a><span data-ttu-id="14d72-113">Descripción de la regla</span><span class="sxs-lookup"><span data-stu-id="14d72-113">Rule description</span></span>

<span data-ttu-id="14d72-114">La serialización de `StringBuilder` siempre crea una copia de búfer nativa, lo que da lugar a varias asignaciones para una llamada P/Invoke.</span><span class="sxs-lookup"><span data-stu-id="14d72-114">Marshaling of `StringBuilder` always creates a native buffer copy, resulting in multiple allocations for one P/Invoke call.</span></span> <span data-ttu-id="14d72-115">Para calcular las referencias de `StringBuilder` como un parámetro P/Invoke, el Runtime hará lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="14d72-115">To marshal a `StringBuilder` as a P/Invoke parameter, the runtime will:</span></span>

- <span data-ttu-id="14d72-116">Asigne un búfer nativo.</span><span class="sxs-lookup"><span data-stu-id="14d72-116">Allocate a native buffer.</span></span>
- <span data-ttu-id="14d72-117">Si es un `In` parámetro, copie el contenido de `StringBuilder` en el búfer nativo.</span><span class="sxs-lookup"><span data-stu-id="14d72-117">If it is an `In` parameter, copy the contents of the `StringBuilder` to the native buffer.</span></span>
- <span data-ttu-id="14d72-118">Si es un `Out` parámetro, copie el búfer nativo en una matriz administrada recién asignada.</span><span class="sxs-lookup"><span data-stu-id="14d72-118">If it is an `Out` parameter, copy the native buffer into a newly allocated managed array.</span></span>

<span data-ttu-id="14d72-119">De forma predeterminada, `StringBuilder` es `In` y `Out` .</span><span class="sxs-lookup"><span data-stu-id="14d72-119">By default, `StringBuilder` is `In` and `Out`.</span></span>

<span data-ttu-id="14d72-120">Esta regla está deshabilitada de forma predeterminada porque puede requerir el análisis de casos por caso de que la infracción sea de interés y de refactorización potencialmente no trivial para solucionar la infracción.</span><span class="sxs-lookup"><span data-stu-id="14d72-120">This rule is disabled by default, because it can require case-by-case analysis of whether the violation is of interest and potentially non-trivial refactoring to address the violation.</span></span> <span data-ttu-id="14d72-121">Los usuarios pueden habilitar explícitamente esta regla [configurando su gravedad](../configuration-options.md#severity-level).</span><span class="sxs-lookup"><span data-stu-id="14d72-121">Users can explicitly enable this rule by [configuring its severity](../configuration-options.md#severity-level).</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="14d72-122">Cómo corregir infracciones</span><span class="sxs-lookup"><span data-stu-id="14d72-122">How to fix violations</span></span>

<span data-ttu-id="14d72-123">En general, la dirección de una infracción implica el retrabajo de P/Invoke y sus llamadores para utilizar un búfer en lugar de `StringBuilder` .</span><span class="sxs-lookup"><span data-stu-id="14d72-123">In general, addressing a violation involves reworking the P/Invoke and its callers to use a buffer instead of `StringBuilder`.</span></span> <span data-ttu-id="14d72-124">Los detalles dependerán de los casos de uso de P/Invoke.</span><span class="sxs-lookup"><span data-stu-id="14d72-124">The specifics would depend on the use cases for the P/Invoke.</span></span>

<span data-ttu-id="14d72-125">Este es un ejemplo para el escenario común de uso de `StringBuilder` como búfer de salida que va a rellenar la función nativa:</span><span class="sxs-lookup"><span data-stu-id="14d72-125">Here is an example for the common scenario of using `StringBuilder` as an output buffer to be filled by the native function:</span></span>

```csharp
// Violation
[DllImport("MyLibrary", CharSet = CharSet.Unicode)]
private static extern void Foo(StringBuilder sb, ref int length);

public void Bar()
{
    int BufferSize = ...
    StringBuilder sb = new StringBuilder(BufferSize);
    int len = sb.Capacity;
    Foo(sb, ref len);
    string result = sb.ToString();
}
```

<span data-ttu-id="14d72-126">En los casos de uso en los que el búfer es pequeño y el `unsafe` código es aceptable, se puede usar [stackalloc](../../../csharp/language-reference/operators/stackalloc.md) para asignar el búfer en la pila:</span><span class="sxs-lookup"><span data-stu-id="14d72-126">For use cases where the buffer is small and `unsafe` code is acceptable, [stackalloc](../../../csharp/language-reference/operators/stackalloc.md) can be used to allocate the buffer on the stack:</span></span>

```csharp
[DllImport("MyLibrary", CharSet = CharSet.Unicode)]
private static extern unsafe void Foo(char* buffer, ref int length);

public void Bar()
{
    int BufferSize = ...
    unsafe
    {
        char* buffer = stackalloc char[BufferSize];
        int len = BufferSize;
        Foo(buffer, ref len);
        string result = new string(buffer);
    }
}
```

<span data-ttu-id="14d72-127">En el caso de los búferes mayores, se puede asignar una nueva matriz como búfer:</span><span class="sxs-lookup"><span data-stu-id="14d72-127">For larger buffers, a new array can be allocated as the buffer:</span></span>

```csharp
[DllImport("MyLibrary", CharSet = CharSet.Unicode)]
private static extern void Foo([Out] char[] buffer, ref int length);

public void Bar()
{
    int BufferSize = ...
    char[] buffer = new char[BufferSize];
    int len = buffer.Length;
    Foo(buffer, ref len);
    string result = new string(buffer);
}
```

<span data-ttu-id="14d72-128">Cuando a menudo se llama a P/Invoke para búferes de mayor tamaño, <xref:System.Buffers.ArrayPool%601> puede usarse para evitar las asignaciones repetidas y la presión de memoria que se incluye en ellos:</span><span class="sxs-lookup"><span data-stu-id="14d72-128">When the P/Invoke is frequently called for larger buffers, <xref:System.Buffers.ArrayPool%601> can be used to avoid the repeated allocations and memory pressure that comes with them:</span></span>

```csharp
[DllImport("MyLibrary", CharSet = CharSet.Unicode)]
private static extern unsafe void Foo([Out] char[] buffer, ref int length);

public void Bar()
{
    int BufferSize = ...
    char[] buffer = ArrayPool<char>.Shared.Rent(BufferSize);
    try
    {
        int len = buffer.Length;
        Foo(buffer, ref len);
        string result = new string(buffer);
    }
    finally
    {
        ArrayPool<char>.Shared.Return(buffer);
    }
}
```

<span data-ttu-id="14d72-129">Si no se conoce el tamaño del búfer hasta el tiempo de ejecución, es posible que sea necesario crear el búfer de manera diferente en función del tamaño para evitar la asignación de búferes de gran tamaño con `stackalloc` .</span><span class="sxs-lookup"><span data-stu-id="14d72-129">If the buffer size is not known until runtime, the buffer may need to be created differently based on the size to avoid allocating large buffers with `stackalloc`.</span></span>

<span data-ttu-id="14d72-130">En los ejemplos anteriores se utilizan caracteres anchos de 2 bytes ( `CharSet.Unicode` ).</span><span class="sxs-lookup"><span data-stu-id="14d72-130">The preceding examples use 2-byte wide characters (`CharSet.Unicode`).</span></span> <span data-ttu-id="14d72-131">Si la función nativa usa caracteres de 1 byte ( `CharSet.Ansi` ), `byte` se puede utilizar un búfer en lugar de un `char` búfer.</span><span class="sxs-lookup"><span data-stu-id="14d72-131">If the native function uses 1-byte characters (`CharSet.Ansi`), a `byte` buffer can be used instead of a `char` buffer.</span></span> <span data-ttu-id="14d72-132">Por ejemplo:</span><span class="sxs-lookup"><span data-stu-id="14d72-132">For example:</span></span>

```csharp
[DllImport("MyLibrary", CharSet = CharSet.Ansi)]
private static extern unsafe void Foo(byte* buffer, ref int length);

public void Bar()
{
    int BufferSize = ...
    unsafe
    {
        byte* buffer = stackalloc byte[BufferSize];
        int len = BufferSize;
        Foo(buffer, ref len);
        string result = Marshal.PtrToStringAnsi((IntPtr)buffer);
    }
}
```

<span data-ttu-id="14d72-133">Si el parámetro también se usa como entrada, los búferes se deben rellenar con los datos de cadena con cualquier terminador nulo agregado explícitamente.</span><span class="sxs-lookup"><span data-stu-id="14d72-133">If the parameter is also used as input, the buffers need to be populated with the string data with any null terminator explicitly added.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="14d72-134">Cuándo suprimir advertencias</span><span class="sxs-lookup"><span data-stu-id="14d72-134">When to suppress warnings</span></span>

<span data-ttu-id="14d72-135">Suprima una infracción de esta regla si no le preocupa el impacto en el rendimiento de la serialización de un `StringBuilder` .</span><span class="sxs-lookup"><span data-stu-id="14d72-135">Suppress a violation of this rule if you're not concerned about the performance impact of marshaling a `StringBuilder`.</span></span>

## <a name="see-also"></a><span data-ttu-id="14d72-136">Vea también</span><span class="sxs-lookup"><span data-stu-id="14d72-136">See also</span></span>

- [<span data-ttu-id="14d72-137">Reglas de rendimiento</span><span class="sxs-lookup"><span data-stu-id="14d72-137">Performance rules</span></span>](performance-warnings.md)
- [<span data-ttu-id="14d72-138">Procedimientos recomendados de interoperabilidad nativa</span><span class="sxs-lookup"><span data-stu-id="14d72-138">Native interoperability best practices</span></span>](../../../standard/native-interop/best-practices.md)
- <xref:System.Buffers.ArrayPool%601>
- [<span data-ttu-id="14d72-139">stackalloc</span><span class="sxs-lookup"><span data-stu-id="14d72-139">stackalloc</span></span>](../../../csharp/language-reference/operators/stackalloc.md)
- [<span data-ttu-id="14d72-140">Juegos</span><span class="sxs-lookup"><span data-stu-id="14d72-140">Charsets</span></span>](../../../standard/native-interop/charset.md)
