---
title: 'CA2000: desechar objetos antes de perder el ámbito (análisis de código)'
description: 'Más información sobre la regla de análisis de código CA2000: desechar objetos antes de perder el ámbito'
ms.date: 05/14/2019
ms.topic: reference
f1_keywords:
- CA2000
- Dispose objects before losing scope
- DisposeObjectsBeforeLosingScope
helpviewer_keywords:
- CA2000
- DisposeObjectsBeforeLosingScope
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: 7e90ef1e07160fdd307d95131631f24c8ba371ad
ms.sourcegitcommit: 4df8e005c074ceb1f978f007b222fe253be2baf3
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/04/2021
ms.locfileid: "99545963"
---
# <a name="ca2000-dispose-objects-before-losing-scope"></a><span data-ttu-id="67e89-103">CA2000: Desechar objetos antes de perder el ámbito</span><span class="sxs-lookup"><span data-stu-id="67e89-103">CA2000: Dispose objects before losing scope</span></span>

| | <span data-ttu-id="67e89-104">Valor</span><span class="sxs-lookup"><span data-stu-id="67e89-104">Value</span></span> |
|-|-|
| <span data-ttu-id="67e89-105">**Identificador de la regla**</span><span class="sxs-lookup"><span data-stu-id="67e89-105">**Rule ID**</span></span> |<span data-ttu-id="67e89-106">CA2000</span><span class="sxs-lookup"><span data-stu-id="67e89-106">CA2000</span></span>|
| <span data-ttu-id="67e89-107">**Categoría**</span><span class="sxs-lookup"><span data-stu-id="67e89-107">**Category**</span></span> |[<span data-ttu-id="67e89-108">Microsoft.Reliability</span><span class="sxs-lookup"><span data-stu-id="67e89-108">Microsoft.Reliability</span></span>](reliability-warnings.md)|
| <span data-ttu-id="67e89-109">**Corrección o interrupción**</span><span class="sxs-lookup"><span data-stu-id="67e89-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="67e89-110">Poco problemático</span><span class="sxs-lookup"><span data-stu-id="67e89-110">Non-breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="67e89-111">Causa</span><span class="sxs-lookup"><span data-stu-id="67e89-111">Cause</span></span>

<span data-ttu-id="67e89-112">Se crea un objeto local de un <xref:System.IDisposable> tipo, pero el objeto no se elimina antes de que todas las referencias al objeto estén fuera del ámbito.</span><span class="sxs-lookup"><span data-stu-id="67e89-112">A local object of an <xref:System.IDisposable> type is created, but the object is not disposed before all references to the object are out of scope.</span></span>

<span data-ttu-id="67e89-113">De forma predeterminada, esta regla analiza todo el código base, pero esto es [configurable](#configure-code-to-analyze).</span><span class="sxs-lookup"><span data-stu-id="67e89-113">By default, this rule analyzes the entire codebase, but this is [configurable](#configure-code-to-analyze).</span></span>

## <a name="rule-description"></a><span data-ttu-id="67e89-114">Descripción de la regla</span><span class="sxs-lookup"><span data-stu-id="67e89-114">Rule description</span></span>

<span data-ttu-id="67e89-115">Si un objeto que se puede eliminar (método Dispose) no se elimina de forma explícita antes de que todas las referencias a él estén fuera de ámbito, el objeto se eliminará en algún momento indeterminado cuando el recolector de elementos no utilizados ejecute el finalizador del objeto.</span><span class="sxs-lookup"><span data-stu-id="67e89-115">If a disposable object is not explicitly disposed before all references to it are out of scope, the object will be disposed at some indeterminate time when the garbage collector runs the finalizer of the object.</span></span> <span data-ttu-id="67e89-116">Puesto que podría producirse un evento excepcional que impida que se ejecute el finalizador del objeto, el objeto debe eliminarse de forma explícita.</span><span class="sxs-lookup"><span data-stu-id="67e89-116">Because an exceptional event might occur that will prevent the finalizer of the object from running, the object should be explicitly disposed instead.</span></span>

## <a name="special-cases"></a><span data-ttu-id="67e89-117">Casos especiales</span><span class="sxs-lookup"><span data-stu-id="67e89-117">Special cases</span></span>

<span data-ttu-id="67e89-118">La regla CA2000 no se activa para objetos locales de los siguientes tipos, aunque no se elimine el objeto:</span><span class="sxs-lookup"><span data-stu-id="67e89-118">Rule CA2000 does not fire for local objects of the following types even if the object is not disposed:</span></span>

- <xref:System.IO.Stream?displayProperty=nameWithType>
- <xref:System.IO.StringReader?displayProperty=nameWithType>
- <xref:System.IO.TextReader?displayProperty=nameWithType>
- <xref:System.IO.TextWriter?displayProperty=nameWithType>
- <xref:System.Resources.IResourceReader?displayProperty=nameWithType>

<span data-ttu-id="67e89-119">Pasar un objeto de uno de estos tipos a un constructor y, a continuación, asignarlo a un campo indica una *transferencia de propiedad de Dispose* al tipo recién construido.</span><span class="sxs-lookup"><span data-stu-id="67e89-119">Passing an object of one of these types to a constructor and then assigning it to a field indicates a *dispose ownership transfer* to the newly constructed type.</span></span> <span data-ttu-id="67e89-120">Es decir, el tipo recién construido ahora es responsable de desechar el objeto.</span><span class="sxs-lookup"><span data-stu-id="67e89-120">That is, the newly constructed type is now responsible for disposing of the object.</span></span> <span data-ttu-id="67e89-121">Si el código pasa un objeto de uno de estos tipos a un constructor, no se produce ninguna infracción de la regla CA2000 aunque no se elimine el objeto antes de que todas las referencias a él estén fuera del ámbito.</span><span class="sxs-lookup"><span data-stu-id="67e89-121">If your code passes an object of one of these types to a constructor, no violation of rule CA2000 occurs even if the object is not disposed before all references to it are out of scope.</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="67e89-122">Cómo corregir infracciones</span><span class="sxs-lookup"><span data-stu-id="67e89-122">How to fix violations</span></span>

<span data-ttu-id="67e89-123">Para corregir una infracción de esta regla, llame a <xref:System.IDisposable.Dispose%2A> en el objeto antes de que todas las referencias a este estén fuera de ámbito.</span><span class="sxs-lookup"><span data-stu-id="67e89-123">To fix a violation of this rule, call <xref:System.IDisposable.Dispose%2A> on the object before all references to it are out of scope.</span></span>

<span data-ttu-id="67e89-124">Puede usar la [ `using` instrucción](../../../csharp/language-reference/keywords/using-statement.md) ( [`Using`](../../../visual-basic/language-reference/statements/using-statement.md) en Visual Basic) para ajustar los objetos que implementan <xref:System.IDisposable> .</span><span class="sxs-lookup"><span data-stu-id="67e89-124">You can use the [`using` statement](../../../csharp/language-reference/keywords/using-statement.md) ([`Using`](../../../visual-basic/language-reference/statements/using-statement.md) in Visual Basic) to wrap objects that implement <xref:System.IDisposable>.</span></span> <span data-ttu-id="67e89-125">Los objetos que se ajustan de esta manera se eliminan automáticamente al final del `using` bloque.</span><span class="sxs-lookup"><span data-stu-id="67e89-125">Objects that are wrapped in this manner are automatically disposed at the end of the `using` block.</span></span> <span data-ttu-id="67e89-126">Sin embargo, las siguientes situaciones no deben o no se pueden controlar con una `using` instrucción:</span><span class="sxs-lookup"><span data-stu-id="67e89-126">However, the following situations should not or cannot be handled with a `using` statement:</span></span>

- <span data-ttu-id="67e89-127">Para devolver un objeto descartable, el objeto debe construirse en un `try/finally` bloque fuera de un `using` bloque.</span><span class="sxs-lookup"><span data-stu-id="67e89-127">To return a disposable object, the object must constructed in a `try/finally` block outside of a `using` block.</span></span>

- <span data-ttu-id="67e89-128">No inicialice los miembros de un objeto descartable en el constructor de una `using` instrucción.</span><span class="sxs-lookup"><span data-stu-id="67e89-128">Do not initialize members of a disposable object in the constructor of a `using` statement.</span></span>

- <span data-ttu-id="67e89-129">Cuando los constructores que están protegidos por un solo controlador de excepciones están anidados en la [parte de adquisición de una `using` instrucción](../../../csharp/language-reference/keywords/using-statement.md), un error en el constructor externo puede dar lugar a que el objeto creado por el constructor anidado no se cierre nunca.</span><span class="sxs-lookup"><span data-stu-id="67e89-129">When constructors that are protected by only one exception handler are nested in the [acquisition part of a `using` statement](../../../csharp/language-reference/keywords/using-statement.md), a failure in the outer constructor can result in the object created by the nested constructor never being closed.</span></span> <span data-ttu-id="67e89-130">En el ejemplo siguiente, un error en el <xref:System.IO.StreamReader> constructor puede dar lugar a <xref:System.IO.FileStream> que nunca se cierre el objeto.</span><span class="sxs-lookup"><span data-stu-id="67e89-130">In the following example, a failure in the <xref:System.IO.StreamReader> constructor can result in the <xref:System.IO.FileStream> object never being closed.</span></span> <span data-ttu-id="67e89-131">CA2000 marca una infracción de la regla en este caso.</span><span class="sxs-lookup"><span data-stu-id="67e89-131">CA2000 flags a violation of the rule in this case.</span></span>

   ```csharp
   using (StreamReader sr = new StreamReader(new FileStream("C:\myfile.txt", FileMode.Create)))
   { ... }
   ```

- <span data-ttu-id="67e89-132">Los objetos dinámicos deben usar un objeto Shadow para implementar el patrón de Dispose de <xref:System.IDisposable> objetos.</span><span class="sxs-lookup"><span data-stu-id="67e89-132">Dynamic objects should use a shadow object to implement the dispose pattern of <xref:System.IDisposable> objects.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="67e89-133">Cuándo suprimir advertencias</span><span class="sxs-lookup"><span data-stu-id="67e89-133">When to suppress warnings</span></span>

<span data-ttu-id="67e89-134">No suprima una advertencia de esta regla a menos que:</span><span class="sxs-lookup"><span data-stu-id="67e89-134">Do not suppress a warning from this rule unless:</span></span>

- <span data-ttu-id="67e89-135">Ha llamado a un método en el objeto que llama a `Dispose` , como <xref:System.IO.Stream.Close%2A></span><span class="sxs-lookup"><span data-stu-id="67e89-135">You've called a method on your object that calls `Dispose`, such as <xref:System.IO.Stream.Close%2A></span></span>
- <span data-ttu-id="67e89-136">El método que generó la advertencia devuelve un <xref:System.IDisposable> objeto que contiene el objeto.</span><span class="sxs-lookup"><span data-stu-id="67e89-136">The method that raised the warning returns an <xref:System.IDisposable> object that wraps your object</span></span>
- <span data-ttu-id="67e89-137">El método de asignación no tiene la propiedad Dispose; es decir, la responsabilidad de desechar el objeto se transfiere a otro objeto o contenedor que se crea en el método y se devuelve al autor de la llamada.</span><span class="sxs-lookup"><span data-stu-id="67e89-137">The allocating method does not have dispose ownership; that is, the responsibility to dispose the object is transferred to another object or wrapper that's created in the method and returned to the caller</span></span>

## <a name="configure-code-to-analyze"></a><span data-ttu-id="67e89-138">Configurar el código para analizar</span><span class="sxs-lookup"><span data-stu-id="67e89-138">Configure code to analyze</span></span>

<span data-ttu-id="67e89-139">Use las opciones siguientes para configurar en qué partes del código base ejecutar esta regla.</span><span class="sxs-lookup"><span data-stu-id="67e89-139">Use the following options to configure which parts of your codebase to run this rule on.</span></span>

- [<span data-ttu-id="67e89-140">Excluir símbolos específicos</span><span class="sxs-lookup"><span data-stu-id="67e89-140">Exclude specific symbols</span></span>](#exclude-specific-symbols)
- [<span data-ttu-id="67e89-141">Excluir tipos específicos y sus tipos derivados</span><span class="sxs-lookup"><span data-stu-id="67e89-141">Exclude specific types and their derived types</span></span>](#exclude-specific-types-and-their-derived-types)

<span data-ttu-id="67e89-142">Puede configurar estas opciones solo para esta regla, para todas las reglas o para todas las reglas de esta categoría ([confiabilidad](reliability-warnings.md)).</span><span class="sxs-lookup"><span data-stu-id="67e89-142">You can configure these options for just this rule, for all rules, or for all rules in this category ([Reliability](reliability-warnings.md)).</span></span> <span data-ttu-id="67e89-143">Para obtener más información, vea [Opciones de configuración de reglas de calidad de código](../code-quality-rule-options.md).</span><span class="sxs-lookup"><span data-stu-id="67e89-143">For more information, see [Code quality rule configuration options](../code-quality-rule-options.md).</span></span>

[!INCLUDE[excluded-symbol-names](~/includes/code-analysis/excluded-symbol-names.md)]

[!INCLUDE[excluded-type-names-with-derived-types](~/includes/code-analysis/excluded-type-names-with-derived-types.md)]

## <a name="related-rules"></a><span data-ttu-id="67e89-144">Reglas relacionadas</span><span class="sxs-lookup"><span data-stu-id="67e89-144">Related rules</span></span>

- [<span data-ttu-id="67e89-145">CA2213: Los campos descartables deben ser descartables</span><span class="sxs-lookup"><span data-stu-id="67e89-145">CA2213: Disposable fields should be disposed</span></span>](ca2213.md)

## <a name="example-1"></a><span data-ttu-id="67e89-146">Ejemplo 1</span><span class="sxs-lookup"><span data-stu-id="67e89-146">Example 1</span></span>

<span data-ttu-id="67e89-147">Si va a implementar un método que devuelve un objeto descartable, use un bloque try/finally sin un bloque catch para asegurarse de que el objeto se desecha.</span><span class="sxs-lookup"><span data-stu-id="67e89-147">If you're implementing a method that returns a disposable object, use a try/finally block without a catch block to make sure that the object is disposed.</span></span> <span data-ttu-id="67e89-148">Al usar un bloque try/finally, permite la generación de excepciones en el momento del error y se asegura de que se elimine el objeto.</span><span class="sxs-lookup"><span data-stu-id="67e89-148">By using a try/finally block, you allow exceptions to be raised at the fault point and make sure that object is disposed.</span></span>

<span data-ttu-id="67e89-149">En el método OpenPort1, se puede producir un error en la llamada para abrir el elemento SerialPort del objeto ISerializable o en la llamada a SomeMethod.</span><span class="sxs-lookup"><span data-stu-id="67e89-149">In the OpenPort1 method, the call to open the ISerializable object SerialPort or the call to SomeMethod can fail.</span></span> <span data-ttu-id="67e89-150">En esta implementación se desencadena una advertencia CA2000.</span><span class="sxs-lookup"><span data-stu-id="67e89-150">A CA2000 warning is raised on this implementation.</span></span>

<span data-ttu-id="67e89-151">En el método OpenPort2, dos objetos SerialPort se declaran y establecen en NULL:</span><span class="sxs-lookup"><span data-stu-id="67e89-151">In the OpenPort2 method, two SerialPort objects are declared and set to null:</span></span>

- <span data-ttu-id="67e89-152">`tempPort`, que se usa para probar la correcta realización de las operaciones del método.</span><span class="sxs-lookup"><span data-stu-id="67e89-152">`tempPort`, which is used to test that the method operations succeed.</span></span>

- <span data-ttu-id="67e89-153">`port`, que se usa para el valor devuelto del método.</span><span class="sxs-lookup"><span data-stu-id="67e89-153">`port`, which is used for the return value of the method.</span></span>

<span data-ttu-id="67e89-154">`tempPort` se construye y abre en un bloque `try` y cualquier otro trabajo que sea necesario se realiza en el mismo bloque `try`.</span><span class="sxs-lookup"><span data-stu-id="67e89-154">The `tempPort` is constructed and opened in a `try` block, and any other required work is performed in the same `try` block.</span></span> <span data-ttu-id="67e89-155">Al final del bloque `try`, el puerto abierto se asigna al objeto `port` que se devolverá y el objeto `tempPort` se establece en `null`.</span><span class="sxs-lookup"><span data-stu-id="67e89-155">At the end of the `try` block, the opened port is assigned to the `port` object that will be returned and the `tempPort` object is set to `null`.</span></span>

<span data-ttu-id="67e89-156">El bloque `finally` comprueba el valor de `tempPort`.</span><span class="sxs-lookup"><span data-stu-id="67e89-156">The `finally` block checks the value of `tempPort`.</span></span> <span data-ttu-id="67e89-157">Si no es NULL, se ha producido un error en una operación del método y `tempPort` se cierra para garantizar la liberación de los recursos.</span><span class="sxs-lookup"><span data-stu-id="67e89-157">If it is not null, an operation in the method has failed, and `tempPort` is closed to make sure that any resources are released.</span></span> <span data-ttu-id="67e89-158">El objeto Port devuelto contendrá el objeto SerialPort abierto si las operaciones del método se han realizado correctamente o será NULL si se produce un error en una operación.</span><span class="sxs-lookup"><span data-stu-id="67e89-158">The returned port object will contain the opened SerialPort object if the operations of the method succeeded, or it will be null if an operation failed.</span></span>

```csharp
public SerialPort OpenPort1(string portName)
{
   SerialPort port = new SerialPort(portName);
   port.Open();  //CA2000 fires because this might throw
   SomeMethod(); //Other method operations can fail
   return port;
}

public SerialPort OpenPort2(string portName)
{
   SerialPort tempPort = null;
   SerialPort port = null;
   try
   {
      tempPort = new SerialPort(portName);
      tempPort.Open();
      SomeMethod();
      //Add any other methods above this line
      port = tempPort;
      tempPort = null;

   }
   finally
   {
      if (tempPort != null)
      {
         tempPort.Close();
      }
   }
   return port;
}
```

```vb
Public Function OpenPort1(ByVal PortName As String) As SerialPort

   Dim port As New SerialPort(PortName)
   port.Open()    'CA2000 fires because this might throw
   SomeMethod()   'Other method operations can fail
   Return port

End Function

Public Function OpenPort2(ByVal PortName As String) As SerialPort

   Dim tempPort As SerialPort = Nothing
   Dim port As SerialPort = Nothing

   Try
      tempPort = New SerialPort(PortName)
      tempPort.Open()
      SomeMethod()
      'Add any other methods above this line
      port = tempPort
      tempPort = Nothing

   Finally
      If Not tempPort Is Nothing Then
         tempPort.Close()
      End If

   End Try

   Return port

End Function
```

## <a name="example-2"></a><span data-ttu-id="67e89-159">Ejemplo 2</span><span class="sxs-lookup"><span data-stu-id="67e89-159">Example 2</span></span>

<span data-ttu-id="67e89-160">De forma predeterminada, el compilador Visual Basic tiene todos los operadores aritméticos que comprueban el desbordamiento.</span><span class="sxs-lookup"><span data-stu-id="67e89-160">By default, the Visual Basic compiler has all arithmetic operators check for overflow.</span></span> <span data-ttu-id="67e89-161">Por consiguiente, cualquier operación aritmética de Visual Basic puede producir una excepción de tipo <xref:System.OverflowException>.</span><span class="sxs-lookup"><span data-stu-id="67e89-161">Therefore, any Visual Basic arithmetic operation might throw an <xref:System.OverflowException>.</span></span> <span data-ttu-id="67e89-162">Esto podría dar lugar a infracciones inesperadas de reglas como CA2000.</span><span class="sxs-lookup"><span data-stu-id="67e89-162">This could lead to unexpected violations in rules such as CA2000.</span></span> <span data-ttu-id="67e89-163">Por ejemplo, la siguiente función CreateReader1 producirá una infracción de CA2000 porque el compilador de Visual Basic emite una instrucción de comprobación de desbordamiento para la suma que podría producir una excepción que provocaría que StreamReader no se eliminase.</span><span class="sxs-lookup"><span data-stu-id="67e89-163">For example, the following CreateReader1 function will produce a CA2000 violation because the Visual Basic compiler is emitting an overflow checking instruction for the addition that could throw an exception that would cause the StreamReader not to be disposed.</span></span>

<span data-ttu-id="67e89-164">Para corregir este problema, puede deshabilitar la emisión de comprobaciones de desbordamiento mediante el compilador de Visual Basic en el proyecto o puede modificar el código como en la siguiente función CreateReader2.</span><span class="sxs-lookup"><span data-stu-id="67e89-164">To fix this, you can disable the emitting of overflow checks by the Visual Basic compiler in your project or you can modify your code as in the following CreateReader2 function.</span></span>

<span data-ttu-id="67e89-165">Para deshabilitar la emisión de comprobaciones de desbordamiento, haga clic con el botón secundario en el nombre del proyecto en Explorador de soluciones y, a continuación, haga clic en **propiedades**.</span><span class="sxs-lookup"><span data-stu-id="67e89-165">To disable the emitting of overflow checks, right-click the project name in Solution Explorer and then click **Properties**.</span></span> <span data-ttu-id="67e89-166">Haga clic en **compilar**, haga clic en **Opciones de compilación avanzadas** y, a continuación, seleccione **quitar comprobaciones de desbordamiento con enteros**.</span><span class="sxs-lookup"><span data-stu-id="67e89-166">Click **Compile**, click **Advanced Compile Options**, and then check **Remove integer overflow checks**.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca2000-dispose-objects-before-losing-scope-vboverflow_1.vb":::

## <a name="see-also"></a><span data-ttu-id="67e89-167">Vea también</span><span class="sxs-lookup"><span data-stu-id="67e89-167">See also</span></span>

- <xref:System.IDisposable>
- [<span data-ttu-id="67e89-168">Patrón de Dispose</span><span class="sxs-lookup"><span data-stu-id="67e89-168">Dispose Pattern</span></span>](../../../standard/garbage-collection/implementing-dispose.md)
