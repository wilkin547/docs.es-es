---
title: 'CA1060: Move P-invoca a la clase NativeMethods (análisis de código)'
description: 'Más información sobre la regla de análisis de código CA1060: Move P-Invocations to NativeMethods (clase)'
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
helpviewer_keywords:
- MovePInvokesToNativeMethodsClass
- CA1060
author: gewarren
ms.author: gewarren
dev_langs:
- CSharp
- VB
ms.openlocfilehash: d1b47bac2bfe33bd926b77c4f59efab7574e4851
ms.sourcegitcommit: 4df8e005c074ceb1f978f007b222fe253be2baf3
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 02/04/2021
ms.locfileid: "99546717"
---
# <a name="ca1060-move-pinvokes-to-nativemethods-class"></a><span data-ttu-id="40b15-103">CA1060: Mueva P/Invokes a la clase NativeMethods</span><span class="sxs-lookup"><span data-stu-id="40b15-103">CA1060: Move P/Invokes to NativeMethods class</span></span>

| | <span data-ttu-id="40b15-104">Valor</span><span class="sxs-lookup"><span data-stu-id="40b15-104">Value</span></span> |
|-|-|
| <span data-ttu-id="40b15-105">**Identificador de la regla**</span><span class="sxs-lookup"><span data-stu-id="40b15-105">**Rule ID**</span></span> |<span data-ttu-id="40b15-106">CA1060</span><span class="sxs-lookup"><span data-stu-id="40b15-106">CA1060</span></span>|
| <span data-ttu-id="40b15-107">**Categoría**</span><span class="sxs-lookup"><span data-stu-id="40b15-107">**Category**</span></span> |[<span data-ttu-id="40b15-108">Microsoft. Design</span><span class="sxs-lookup"><span data-stu-id="40b15-108">Microsoft.Design</span></span>](design-warnings.md)|
| <span data-ttu-id="40b15-109">**Corrección o interrupción**</span><span class="sxs-lookup"><span data-stu-id="40b15-109">**Fix is breaking or non-breaking**</span></span> |<span data-ttu-id="40b15-110">Problemático</span><span class="sxs-lookup"><span data-stu-id="40b15-110">Breaking</span></span>|

## <a name="cause"></a><span data-ttu-id="40b15-111">Causa</span><span class="sxs-lookup"><span data-stu-id="40b15-111">Cause</span></span>

<span data-ttu-id="40b15-112">Un método usa servicios de invocación de plataforma para tener acceso a código no administrado y no es miembro de una de las clases **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="40b15-112">A method uses Platform Invocation Services to access unmanaged code and is not a member of one of the **NativeMethods** classes.</span></span>

## <a name="rule-description"></a><span data-ttu-id="40b15-113">Descripción de la regla</span><span class="sxs-lookup"><span data-stu-id="40b15-113">Rule description</span></span>

<span data-ttu-id="40b15-114">Los métodos de invocación de plataforma, como los marcados con el <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> atributo, o los métodos que se definen mediante la `Declare` palabra clave en Visual Basic, tienen acceso al código no administrado.</span><span class="sxs-lookup"><span data-stu-id="40b15-114">Platform Invocation methods, such as those that are marked by using the <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> attribute, or methods that are defined by using the `Declare` keyword in Visual Basic, access unmanaged code.</span></span> <span data-ttu-id="40b15-115">Estos métodos deben estar en una de las clases siguientes:</span><span class="sxs-lookup"><span data-stu-id="40b15-115">These methods should be in one of the following classes:</span></span>

- <span data-ttu-id="40b15-116">**NativeMethods** : esta clase no suprime los recorridos de pila para el permiso de código no administrado.</span><span class="sxs-lookup"><span data-stu-id="40b15-116">**NativeMethods** - This class does not suppress stack walks for unmanaged code permission.</span></span> <span data-ttu-id="40b15-117">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> no se debe aplicar a esta clase). Esta clase es para los métodos que se pueden usar en cualquier lugar porque se realizará un recorrido de pila.</span><span class="sxs-lookup"><span data-stu-id="40b15-117">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> must not be applied to this class.) This class is for methods that can be used anywhere because a stack walk will be performed.</span></span>

- <span data-ttu-id="40b15-118">**SafeNativeMethods** : esta clase suprime los recorridos de pila para el permiso de código no administrado.</span><span class="sxs-lookup"><span data-stu-id="40b15-118">**SafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="40b15-119">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> se aplica a esta clase). Esta clase es para los métodos seguros para que cualquier usuario llame a.</span><span class="sxs-lookup"><span data-stu-id="40b15-119">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are safe for anyone to call.</span></span> <span data-ttu-id="40b15-120">Los autores de llamadas de estos métodos no son necesarios para realizar una revisión de seguridad completa para asegurarse de que el uso es seguro porque los métodos son inofensivos para cualquier llamador.</span><span class="sxs-lookup"><span data-stu-id="40b15-120">Callers of these methods are not required to perform a full security review to make sure that the usage is secure because the methods are harmless for any caller.</span></span>

- <span data-ttu-id="40b15-121">**UnsafeNativeMethods** : esta clase suprime los recorridos de pila para el permiso de código no administrado.</span><span class="sxs-lookup"><span data-stu-id="40b15-121">**UnsafeNativeMethods** - This class suppresses stack walks for unmanaged code permission.</span></span> <span data-ttu-id="40b15-122">( <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> se aplica a esta clase). Esta clase es para los métodos que son potencialmente peligrosos.</span><span class="sxs-lookup"><span data-stu-id="40b15-122">(<xref:System.Security.SuppressUnmanagedCodeSecurityAttribute?displayProperty=fullName> is applied to this class.) This class is for methods that are potentially dangerous.</span></span> <span data-ttu-id="40b15-123">Cualquier llamador de estos métodos debe realizar una revisión de seguridad completa para asegurarse de que el uso es seguro porque no se realizará ningún recorrido de pila.</span><span class="sxs-lookup"><span data-stu-id="40b15-123">Any caller of these methods must perform a full security review to make sure that the usage is secure because no stack walk will be performed.</span></span>

<span data-ttu-id="40b15-124">Estas clases se declaran como `internal` ( `Friend` en Visual Basic) y declaran un constructor privado para evitar que se creen instancias nuevas.</span><span class="sxs-lookup"><span data-stu-id="40b15-124">These classes are declared as `internal` (`Friend` in Visual Basic) and declare a private constructor to prevent new instances from being created.</span></span> <span data-ttu-id="40b15-125">Los métodos de estas clases deben ser `static` y `internal` ( `Shared` y `Friend` en Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="40b15-125">The methods in these classes should be `static` and `internal` (`Shared` and `Friend` in Visual Basic).</span></span>

## <a name="how-to-fix-violations"></a><span data-ttu-id="40b15-126">Cómo corregir infracciones</span><span class="sxs-lookup"><span data-stu-id="40b15-126">How to fix violations</span></span>

<span data-ttu-id="40b15-127">Para corregir una infracción de esta regla, mueva el método a la clase **NativeMethods** adecuada.</span><span class="sxs-lookup"><span data-stu-id="40b15-127">To fix a violation of this rule, move the method to the appropriate **NativeMethods** class.</span></span> <span data-ttu-id="40b15-128">Para la mayoría de las aplicaciones, el movimiento de P/Invoke a una nueva clase denominada **NativeMethods** es suficiente.</span><span class="sxs-lookup"><span data-stu-id="40b15-128">For most applications, moving P/Invokes to a new class that is named **NativeMethods** is enough.</span></span>

<span data-ttu-id="40b15-129">Sin embargo, si está desarrollando bibliotecas para usarlas en otras aplicaciones, considere la posibilidad de definir otras dos clases que se llamen como **SafeNativeMethods** y **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="40b15-129">However, if you are developing libraries for use in other applications, you should consider defining two other classes that are called **SafeNativeMethods** and **UnsafeNativeMethods**.</span></span> <span data-ttu-id="40b15-130">Estas clases se asemejan a la clase **NativeMethods** ; sin embargo, se marcan con un atributo especial denominado **SuppressUnmanagedCodeSecurityAttribute**.</span><span class="sxs-lookup"><span data-stu-id="40b15-130">These classes resemble the **NativeMethods** class; however, they are marked by using a special attribute called **SuppressUnmanagedCodeSecurityAttribute**.</span></span> <span data-ttu-id="40b15-131">Cuando se aplica este atributo, el tiempo de ejecución no realiza un recorrido de pila completo para asegurarse de que todos los llamadores tienen el permiso **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="40b15-131">When this attribute is applied, the runtime does not perform a full stack walk to make sure that all callers have the **UnmanagedCode** permission.</span></span> <span data-ttu-id="40b15-132">Normalmente, el tiempo de ejecución comprueba este permiso en el inicio.</span><span class="sxs-lookup"><span data-stu-id="40b15-132">The runtime ordinarily checks for this permission at startup.</span></span> <span data-ttu-id="40b15-133">Dado que la comprobación no se realiza, puede mejorar considerablemente el rendimiento de las llamadas a estos métodos no administrados, también permite que el código con permisos limitados llame a estos métodos.</span><span class="sxs-lookup"><span data-stu-id="40b15-133">Because the check is not performed, it can greatly improve performance for calls to these unmanaged methods, It also enables code that has limited permissions to call these methods.</span></span>

<span data-ttu-id="40b15-134">Sin embargo, debe usar este atributo con mucha atención.</span><span class="sxs-lookup"><span data-stu-id="40b15-134">However, you should use this attribute with great care.</span></span> <span data-ttu-id="40b15-135">Puede tener implicaciones de seguridad graves si se implementa incorrectamente.</span><span class="sxs-lookup"><span data-stu-id="40b15-135">It can have serious security implications if it is implemented incorrectly..</span></span>

<span data-ttu-id="40b15-136">Para obtener información sobre cómo implementar los métodos, vea el ejemplo de **NativeMethods** , el ejemplo de **SafeNativeMethods** y el ejemplo de **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="40b15-136">For information about how to implement the methods, see the **NativeMethods** example, **SafeNativeMethods** example, and **UnsafeNativeMethods** example.</span></span>

## <a name="when-to-suppress-warnings"></a><span data-ttu-id="40b15-137">Cuándo suprimir advertencias</span><span class="sxs-lookup"><span data-stu-id="40b15-137">When to suppress warnings</span></span>

<span data-ttu-id="40b15-138">No suprima las advertencias de esta regla.</span><span class="sxs-lookup"><span data-stu-id="40b15-138">Do not suppress a warning from this rule.</span></span>

## <a name="example"></a><span data-ttu-id="40b15-139">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="40b15-139">Example</span></span>

<span data-ttu-id="40b15-140">En el ejemplo siguiente se declara un método que infringe esta regla.</span><span class="sxs-lookup"><span data-stu-id="40b15-140">The following example declares a method that violates this rule.</span></span> <span data-ttu-id="40b15-141">Para corregir la infracción, el **RemoveDirectory** P/Invoke debe moverse a una clase adecuada que esté diseñada para contener solo p/Invoke.</span><span class="sxs-lookup"><span data-stu-id="40b15-141">To correct the violation, the **RemoveDirectory** P/Invoke should be moved to an appropriate class that is designed to hold only P/Invokes.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet1":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet1":::

## <a name="nativemethods-example"></a><span data-ttu-id="40b15-142">Ejemplo de NativeMethods</span><span class="sxs-lookup"><span data-stu-id="40b15-142">NativeMethods example</span></span>

<span data-ttu-id="40b15-143">Dado que la clase **NativeMethods** no debe marcarse mediante **SuppressUnmanagedCodeSecurityAttribute**, P/Invokes que se colocan en ella necesitará el permiso **UnmanagedCode** .</span><span class="sxs-lookup"><span data-stu-id="40b15-143">Because the **NativeMethods** class should not be marked by using **SuppressUnmanagedCodeSecurityAttribute**, P/Invokes that are put in it will require **UnmanagedCode** permission.</span></span> <span data-ttu-id="40b15-144">Dado que la mayoría de las aplicaciones se ejecutan desde el equipo local y se ejecutan con plena confianza, esto no suele ser un problema.</span><span class="sxs-lookup"><span data-stu-id="40b15-144">Because most applications run from the local computer and run together with full trust, this is usually not a problem.</span></span> <span data-ttu-id="40b15-145">Sin embargo, si está desarrollando bibliotecas reutilizables, considere la posibilidad de definir una clase **SafeNativeMethods** o **UnsafeNativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="40b15-145">However, if you are developing reusable libraries, you should consider defining a **SafeNativeMethods** or **UnsafeNativeMethods** class.</span></span>

<span data-ttu-id="40b15-146">En el ejemplo siguiente se muestra un método **Interaction. Beep** que ajusta la función **MessageBeep** de user32.dll.</span><span class="sxs-lookup"><span data-stu-id="40b15-146">The following example shows an **Interaction.Beep** method that wraps the **MessageBeep** function from user32.dll.</span></span> <span data-ttu-id="40b15-147">**MessageBeep** P/Invoke se coloca en la clase **NativeMethods** .</span><span class="sxs-lookup"><span data-stu-id="40b15-147">The **MessageBeep** P/Invoke is put in the **NativeMethods** class.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet2":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet2":::

## <a name="safenativemethods-example"></a><span data-ttu-id="40b15-148">Ejemplo de SafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="40b15-148">SafeNativeMethods example</span></span>

<span data-ttu-id="40b15-149">Los métodos P/Invoke que se pueden exponer de forma segura a cualquier aplicación y que no tienen ningún efecto secundario deben colocarse en una clase denominada **SafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="40b15-149">P/Invoke methods that can be safely exposed to any application and that do not have any side effects should be put in a class that is named **SafeNativeMethods**.</span></span> <span data-ttu-id="40b15-150">No tiene que solicitar permisos y no tiene que prestar mucha atención a la ubicación desde la que se les llama.</span><span class="sxs-lookup"><span data-stu-id="40b15-150">You do not have to demand permissions and you do not have to pay much attention to where they are called from.</span></span>

<span data-ttu-id="40b15-151">En el ejemplo siguiente se muestra una propiedad **Environment. TickCount** que contiene la función **GetTickCount** de kernel32.dll.</span><span class="sxs-lookup"><span data-stu-id="40b15-151">The following example shows an **Environment.TickCount** property that wraps the **GetTickCount** function from kernel32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet3":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet3":::

## <a name="unsafenativemethods-example"></a><span data-ttu-id="40b15-152">Ejemplo de UnsafeNativeMethods</span><span class="sxs-lookup"><span data-stu-id="40b15-152">UnsafeNativeMethods example</span></span>

<span data-ttu-id="40b15-153">Los métodos P/Invoke a los que no se puede llamar de manera segura y que podrían provocar efectos secundarios deberían colocarse en una clase denominada **UnsafeNativeMethods**.</span><span class="sxs-lookup"><span data-stu-id="40b15-153">P/Invoke methods that cannot be safely called and that could cause side effects should be put in a class that is named **UnsafeNativeMethods**.</span></span> <span data-ttu-id="40b15-154">Estos métodos deben comprobarse rigurosamente para asegurarse de que no se exponen al usuario de forma involuntaria.</span><span class="sxs-lookup"><span data-stu-id="40b15-154">These methods should be rigorously checked to make sure that they are not exposed to the user unintentionally.</span></span> <span data-ttu-id="40b15-155">Como alternativa, los métodos deben tener otro permiso exigido en lugar de **UnmanagedCode** cuando los usan.</span><span class="sxs-lookup"><span data-stu-id="40b15-155">Alternatively, the methods should have another permission that is demanded instead of **UnmanagedCode** when they use them.</span></span>

<span data-ttu-id="40b15-156">En el ejemplo siguiente se muestra un método **cursor. Hide** que contiene la función **ShowCursor** de user32.dll.</span><span class="sxs-lookup"><span data-stu-id="40b15-156">The following example shows a **Cursor.Hide** method that wraps the **ShowCursor** function from user32.dll.</span></span>

:::code language="vb" source="snippets/vb/all-rules/ca1060-move-p-invokes-to-nativemethods-class_1.vb" id="snippet4":::

:::code language="csharp" source="snippets/csharp/all-rules/ca1060.cs" id="snippet4":::

## <a name="see-also"></a><span data-ttu-id="40b15-157">Vea también</span><span class="sxs-lookup"><span data-stu-id="40b15-157">See also</span></span>

- [<span data-ttu-id="40b15-158">Reglas de diseño</span><span class="sxs-lookup"><span data-stu-id="40b15-158">Design rules</span></span>](design-warnings.md)
