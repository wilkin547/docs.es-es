---
title: Cancelación en subprocesos administrados
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
ms.openlocfilehash: d4bbf30923d65ad7aeced80efa626136ae27491b
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 03/15/2020
ms.locfileid: "73138138"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="2408e-102">Cancelación en subprocesos administrados</span><span class="sxs-lookup"><span data-stu-id="2408e-102">Cancellation in Managed Threads</span></span>
<span data-ttu-id="2408e-103">A partir de .NET Framework 4, .NET Framework usa un modelo unificado para la cancelación cooperativa de operaciones asincrónicas o sincrónicas de ejecución prolongada.</span><span class="sxs-lookup"><span data-stu-id="2408e-103">Starting with the .NET Framework 4, the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="2408e-104">Este modelo se basa en un objeto ligero denominado token de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-104">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="2408e-105">El objeto que invoca una o más operaciones cancelables, por ejemplo creando un nuevo subproceso o tarea, pasa el token a cada operación.</span><span class="sxs-lookup"><span data-stu-id="2408e-105">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="2408e-106">Las operaciones individuales pueden pasar a su vez copias del token a otras operaciones.</span><span class="sxs-lookup"><span data-stu-id="2408e-106">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="2408e-107">En algún momento posterior, el objeto que creó el token puede usarlo para solicitar que las operaciones se detengan.</span><span class="sxs-lookup"><span data-stu-id="2408e-107">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="2408e-108">Solo el objeto solicitante puede emitir la solicitud de cancelación y cada agente de escucha es responsable de observar la solicitud y responder a ella de manera puntual.</span><span class="sxs-lookup"><span data-stu-id="2408e-108">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="2408e-109">El patrón general para implementar el modelo de cancelación cooperativa es:</span><span class="sxs-lookup"><span data-stu-id="2408e-109">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="2408e-110">Crear una instancia de un objeto <xref:System.Threading.CancellationTokenSource>, que administra y envía una notificación de cancelación a los tokens de cancelación individuales.</span><span class="sxs-lookup"><span data-stu-id="2408e-110">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="2408e-111">Pasar el token devuelto por la propiedad <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> para cada tarea o el subproceso que realiza escuchas de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-111">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="2408e-112">Proporcionar un mecanismo para que cada tarea o subproceso responda a la cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-112">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="2408e-113">Llamar al método <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> para proporcionar una notificación de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-113">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="2408e-114">La clase <xref:System.Threading.CancellationTokenSource> implementa la interfaz <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="2408e-114">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="2408e-115">Debe asegurarse de llamar al método <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> cuando termine de usar el origen del token de cancelación para liberar los recursos no administrados que contiene.</span><span class="sxs-lookup"><span data-stu-id="2408e-115">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="2408e-116">En la siguiente ilustración se muestra la relación entre un origen de token y todas las copias de su token.</span><span class="sxs-lookup"><span data-stu-id="2408e-116">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="2408e-117">![CancellationTokenSource y tokens de cancelación](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="2408e-117">![CancellationTokenSource and cancellation tokens](../../../docs/standard/threading/media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="2408e-118">El nuevo modelo de cancelación facilita la creación de bibliotecas y aplicaciones compatibles con la cancelación y admite las siguientes características:</span><span class="sxs-lookup"><span data-stu-id="2408e-118">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="2408e-119">La cancelación es cooperativa y no se impone al agente de escucha.</span><span class="sxs-lookup"><span data-stu-id="2408e-119">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="2408e-120">El agente de escucha determina cómo finalizar correctamente en respuesta a una solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-120">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="2408e-121">La solicitud es distinta que la escucha.</span><span class="sxs-lookup"><span data-stu-id="2408e-121">Requesting is distinct from listening.</span></span> <span data-ttu-id="2408e-122">Un objeto que invoca una operación cancelable puede controlar cuándo se solicita la cancelación (si se solicita).</span><span class="sxs-lookup"><span data-stu-id="2408e-122">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="2408e-123">El objeto solicitante emite la solicitud de cancelación para todas las copias del token usando simplemente una llamada de método.</span><span class="sxs-lookup"><span data-stu-id="2408e-123">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="2408e-124">Si los une en un *token vinculado*, un agente de escucha puede escuchar varios tokens simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="2408e-124">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="2408e-125">El código de usuario puede observar y responder a las solicitudes de cancelación desde código de biblioteca y el código de biblioteca puede observar y responder a las solicitudes de cancelación desde código de usuario.</span><span class="sxs-lookup"><span data-stu-id="2408e-125">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="2408e-126">Los agentes de escucha pueden recibir las solicitudes de cancelación mediante sondeo, registro de devolución de llamada o espera en identificadores de espera.</span><span class="sxs-lookup"><span data-stu-id="2408e-126">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="2408e-127">Tipos de cancelación</span><span class="sxs-lookup"><span data-stu-id="2408e-127">Cancellation Types</span></span>  
 <span data-ttu-id="2408e-128">El marco de cancelación se implementa como un conjunto de tipos relacionados. Estos tipos se enumeran en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="2408e-128">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="2408e-129">Nombre de tipo</span><span class="sxs-lookup"><span data-stu-id="2408e-129">Type name</span></span>|<span data-ttu-id="2408e-130">Descripción</span><span class="sxs-lookup"><span data-stu-id="2408e-130">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="2408e-131">Objeto que se crea un token de cancelación y también emite la solicitud de cancelación para todas las copias de ese token.</span><span class="sxs-lookup"><span data-stu-id="2408e-131">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="2408e-132">Tipo de valor ligero pasado a uno o varios agentes de escucha, normalmente como un parámetro de método.</span><span class="sxs-lookup"><span data-stu-id="2408e-132">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="2408e-133">Los agentes de escucha supervisan el valor de la propiedad `IsCancellationRequested` del token mediante sondeo, devolución de llamada o identificador de espera.</span><span class="sxs-lookup"><span data-stu-id="2408e-133">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="2408e-134">Las sobrecargas del constructor de esta excepción aceptan <xref:System.Threading.CancellationToken> como parámetro.</span><span class="sxs-lookup"><span data-stu-id="2408e-134">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="2408e-135">Los agentes de escucha pueden generar esta excepción para comprobar el origen de la cancelación y notificar a otros que ha respondido a una solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-135">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="2408e-136">El nuevo modelo de cancelación se integra en .NET Framework en varios tipos.</span><span class="sxs-lookup"><span data-stu-id="2408e-136">The new cancellation model is integrated into the .NET Framework in several types.</span></span> <span data-ttu-id="2408e-137">Los más importantes son <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> y <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="2408e-137">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="2408e-138">Le recomendamos usar este nuevo modelo de cancelación para todo el código de biblioteca y aplicación nuevo.</span><span class="sxs-lookup"><span data-stu-id="2408e-138">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="2408e-139">Ejemplo de código</span><span class="sxs-lookup"><span data-stu-id="2408e-139">Code Example</span></span>  
 <span data-ttu-id="2408e-140">En el ejemplo siguiente, el objeto solicitante crea un objeto <xref:System.Threading.CancellationTokenSource> y, a continuación, pasa su propiedad <xref:System.Threading.CancellationTokenSource.Token%2A> a la operación cancelable.</span><span class="sxs-lookup"><span data-stu-id="2408e-140">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="2408e-141">La operación que recibe la solicitud supervisa el valor de la propiedad <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> del token mediante sondeo.</span><span class="sxs-lookup"><span data-stu-id="2408e-141">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="2408e-142">Cuando el valor se convierte en `true`, el agente de escucha puede finalizar de la manera adecuada.</span><span class="sxs-lookup"><span data-stu-id="2408e-142">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="2408e-143">En este ejemplo el método simplemente sale, que es lo único necesario en muchos casos.</span><span class="sxs-lookup"><span data-stu-id="2408e-143">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2408e-144">En el ejemplo se usa el método <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> para demostrar que el nuevo marco de cancelación es compatible con las API heredadas.</span><span class="sxs-lookup"><span data-stu-id="2408e-144">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="2408e-145">Para obtener un ejemplo en donde se utiliza el nuevo tipo preferido, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, vea [Procedimiento: Cancelar una tarea y sus elementos secundarios](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-145">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../../../docs/standard/parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="2408e-146">Cancelación de operaciones frente a cancelación de objetos</span><span class="sxs-lookup"><span data-stu-id="2408e-146">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="2408e-147">En el nuevo marco de cancelación, la cancelación se refiere a las operaciones, no a objetos.</span><span class="sxs-lookup"><span data-stu-id="2408e-147">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="2408e-148">La solicitud de cancelación significa que la operación debe detenerse lo antes posible después de realizar cualquier limpieza necesaria.</span><span class="sxs-lookup"><span data-stu-id="2408e-148">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="2408e-149">Un token de cancelación debe hacer referencia a una "operación cancelable", independientemente de si esa operación está implementada en su programa.</span><span class="sxs-lookup"><span data-stu-id="2408e-149">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="2408e-150">Después de establecer la propiedad <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> del token en `true`, no puede restablecerse a `false`.</span><span class="sxs-lookup"><span data-stu-id="2408e-150">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="2408e-151">Por lo tanto, los tokens de cancelación no pueden volver a usarse una vez cancelados.</span><span class="sxs-lookup"><span data-stu-id="2408e-151">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="2408e-152">Si necesita un mecanismo de cancelación de objetos, puede basarlo en el mecanismo de cancelación de operaciones mediante una llamada al método <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType>, tal como se muestra en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="2408e-152">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="2408e-153">Si un objeto admite más de una operación cancelable simultánea, pase un token independiente como entrada para cada operación cancelable.</span><span class="sxs-lookup"><span data-stu-id="2408e-153">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="2408e-154">De este modo, se puede cancelar una operación sin que afecte al resto.</span><span class="sxs-lookup"><span data-stu-id="2408e-154">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="2408e-155">Escucha y respuesta a solicitudes de cancelación</span><span class="sxs-lookup"><span data-stu-id="2408e-155">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="2408e-156">En el delegado de usuario, el implementador de una operación cancelable determina cómo finalizar la operación en respuesta a una solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-156">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="2408e-157">En muchos casos, el delegado de usuario puede realizar simplemente cualquier limpieza necesaria y volver inmediatamente.</span><span class="sxs-lookup"><span data-stu-id="2408e-157">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="2408e-158">Sin embargo, en casos más complejos, es posible que sea necesario que el delegado de usuario notifique al código de biblioteca que se ha producido la cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-158">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="2408e-159">En estos casos, la manera correcta de finalizar la operación es que el delegado llame al método <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, lo que provocará que se genere <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="2408e-159">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="2408e-160">El código de biblioteca puede detectar esta excepción en el subproceso de delegado de usuario y examinar el token de la excepción para determinar si la excepción indica una cancelación cooperativa o alguna otra situación excepcional.</span><span class="sxs-lookup"><span data-stu-id="2408e-160">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="2408e-161">La clase <xref:System.Threading.Tasks.Task> administra <xref:System.OperationCanceledException> de esta manera.</span><span class="sxs-lookup"><span data-stu-id="2408e-161">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="2408e-162">Para más información, vea [Cancelación de tareas](../../../docs/standard/parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-162">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="2408e-163">Escuchas mediante sondeo</span><span class="sxs-lookup"><span data-stu-id="2408e-163">Listening by Polling</span></span>  
 <span data-ttu-id="2408e-164">Para los cálculos de ejecución prolongada que se repiten, puede escuchar una solicitud de cancelación sondeando periódicamente el valor de la propiedad <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="2408e-164">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="2408e-165">Si su valor es `true`, el método debe realizar una limpieza y finalizar lo antes posible.</span><span class="sxs-lookup"><span data-stu-id="2408e-165">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="2408e-166">La frecuencia óptima de sondeo depende del tipo de aplicación.</span><span class="sxs-lookup"><span data-stu-id="2408e-166">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="2408e-167">Es el desarrollador quien determina la mejor frecuencia de sondeo para cualquier programa dado.</span><span class="sxs-lookup"><span data-stu-id="2408e-167">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="2408e-168">El sondeo en sí no afecta significativamente al rendimiento.</span><span class="sxs-lookup"><span data-stu-id="2408e-168">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="2408e-169">En el ejemplo siguiente se muestra una posible manera de sondeo.</span><span class="sxs-lookup"><span data-stu-id="2408e-169">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="2408e-170">Para obtener un ejemplo más completo, vea [Cómo: Escucha de solicitudes de cancelación mediante sondeo](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-170">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="2408e-171">Escuchas mediante el registro de una devolución de llamada</span><span class="sxs-lookup"><span data-stu-id="2408e-171">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="2408e-172">Algunas operaciones se pueden bloquear de forma que no pueden comprobar el valor del token de cancelación de manera oportuna.</span><span class="sxs-lookup"><span data-stu-id="2408e-172">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="2408e-173">En estos casos, se puede registrar un método de devolución de llamada que desbloquee el método cuando se reciba una solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-173">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="2408e-174">El método <xref:System.Threading.CancellationToken.Register%2A> devuelve un objeto <xref:System.Threading.CancellationTokenRegistration> que se usa específicamente para este propósito.</span><span class="sxs-lookup"><span data-stu-id="2408e-174">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="2408e-175">En el ejemplo siguiente se muestra cómo usar el método <xref:System.Threading.CancellationToken.Register%2A> para cancelar una solicitud web asincrónica.</span><span class="sxs-lookup"><span data-stu-id="2408e-175">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="2408e-176">El objeto <xref:System.Threading.CancellationTokenRegistration> administra la sincronización de subprocesos y garantiza que la devolución de llamada dejará de ejecutarse en un momento concreto en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="2408e-176">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="2408e-177">Para garantizar la capacidad de respuesta del sistema y evitar los interbloqueos, deben seguirse las siguientes directrices al registrar devoluciones de llamada:</span><span class="sxs-lookup"><span data-stu-id="2408e-177">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="2408e-178">El método de devolución de llamada debe ser rápido porque se llama sincrónicamente y, por tanto, la llamada a <xref:System.Threading.CancellationTokenSource.Cancel%2A> no devuelve un valor hasta que no se devuelve la devolución de llamada.</span><span class="sxs-lookup"><span data-stu-id="2408e-178">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="2408e-179">Si se llama a <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> mientras se ejecuta la devolución de llamada y se mantiene un bloqueo que está esperando la devolución de llamada, el programa puede causar interbloqueos.</span><span class="sxs-lookup"><span data-stu-id="2408e-179">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="2408e-180">Después de que `Dispose` devuelve un valor, puede liberar todos los recursos requeridos por la devolución de llamada.</span><span class="sxs-lookup"><span data-stu-id="2408e-180">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="2408e-181">Las devoluciones de llamada no deben realizar ningún subproceso manual ni uso de o <xref:System.Threading.SynchronizationContext> en una devolución de llamada.</span><span class="sxs-lookup"><span data-stu-id="2408e-181">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="2408e-182">Si una devolución de llamada debe ejecutarse en un subproceso concreto, use el constructor <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> que le permite especificar que la clase syncContext de destino es el <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType> activo.</span><span class="sxs-lookup"><span data-stu-id="2408e-182">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="2408e-183">Si se realiza un subproceso manual en una devolución de llamada, puede producirse un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="2408e-183">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="2408e-184">Para obtener un ejemplo más completo, vea [Cómo: Registro de devoluciones de llamada como solicitudes de cancelación](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-184">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](../../../docs/standard/threading/how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="2408e-185">Escuchas mediante un identificador de espera</span><span class="sxs-lookup"><span data-stu-id="2408e-185">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="2408e-186">Cuando una operación cancelable puede bloquearse mientras espera en una primitiva de sincronización como <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> o <xref:System.Threading.Semaphore?displayProperty=nameWithType>, se puede usar la propiedad <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> para habilitar la operación de espera en el evento y la solicitud de cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-186">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="2408e-187">El identificador de espera del token de cancelación se señalará en respuesta a una solicitud de cancelación y el método puede usar el valor devuelto del método <xref:System.Threading.WaitHandle.WaitAny%2A> para determinar si era el token de cancelación el que señalaba.</span><span class="sxs-lookup"><span data-stu-id="2408e-187">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="2408e-188">A continuación, la operación puede cerrarse o generar <xref:System.OperationCanceledException>, según corresponda.</span><span class="sxs-lookup"><span data-stu-id="2408e-188">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="2408e-189">En el nuevo código destinado a .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> y <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> admiten el nuevo marco de cancelación en sus métodos `Wait`.</span><span class="sxs-lookup"><span data-stu-id="2408e-189">In new code that targets the .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="2408e-190"><xref:System.Threading.CancellationToken> puede pasarse al método y, cuando se solicita la cancelación, el evento se activa y genera <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="2408e-190">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="2408e-191">Para obtener un ejemplo más completo, vea [Cómo: Escucha de solicitudes de cancelación que tienen identificadores de espera](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-191">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](../../../docs/standard/threading/how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="2408e-192">Escucha de varios tokens simultáneamente</span><span class="sxs-lookup"><span data-stu-id="2408e-192">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="2408e-193">En algunos casos, un agente de escucha tiene que escuchar varios tokens de cancelación de manera simultánea.</span><span class="sxs-lookup"><span data-stu-id="2408e-193">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="2408e-194">Por ejemplo, una operación cancelable puede tener que supervisar un token de cancelación interno además de un token pasado externamente como argumento a un parámetro de método.</span><span class="sxs-lookup"><span data-stu-id="2408e-194">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="2408e-195">Para lograr esto, cree un origen de tokens vinculados que pueda combinar dos o más tokens en uno, como se muestra en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="2408e-195">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="2408e-196">Tenga en cuenta que debe llamar a `Dispose` en el origen de tokens vinculados cuando haya terminado con él.</span><span class="sxs-lookup"><span data-stu-id="2408e-196">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="2408e-197">Para obtener un ejemplo más completo, vea [Cómo: Escucha de varias solicitudes de cancelación](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-197">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](../../../docs/standard/threading/how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="2408e-198">Cooperación entre código de biblioteca y código de usuario</span><span class="sxs-lookup"><span data-stu-id="2408e-198">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="2408e-199">El marco de cancelación unificada hace posible que el código de biblioteca pueda cancelar el código de usuario y que el código de usuario pueda cancelar el código de la biblioteca de manera cooperativa.</span><span class="sxs-lookup"><span data-stu-id="2408e-199">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="2408e-200">Una buena cooperación depende de que cada lado siga estas instrucciones:</span><span class="sxs-lookup"><span data-stu-id="2408e-200">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="2408e-201">Si el código de biblioteca proporciona operaciones cancelables, también debe proporcionar métodos públicos que acepten un token de cancelación externo para que el código de usuario pueda solicitar la cancelación.</span><span class="sxs-lookup"><span data-stu-id="2408e-201">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="2408e-202">Si el código de biblioteca llama al código de usuario, el código de biblioteca debe interpretar OperationCanceledException (externalToken) como *cancelación cooperativa* y no necesariamente como una excepción de error.</span><span class="sxs-lookup"><span data-stu-id="2408e-202">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="2408e-203">Los delegados de usuario deben intentar responder a las solicitudes de cancelación del código de biblioteca de manera adecuada.</span><span class="sxs-lookup"><span data-stu-id="2408e-203">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="2408e-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> y <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> son ejemplos de clases que siguen estas instrucciones.</span><span class="sxs-lookup"><span data-stu-id="2408e-204"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="2408e-205">Para más información, vea [Cancelación de tareas](../../../docs/standard/parallel-programming/task-cancellation.md) y [Cómo: Cancelar una consulta PLINQ](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="2408e-205">For more information, see [Task Cancellation](../../../docs/standard/parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2408e-206">Vea también</span><span class="sxs-lookup"><span data-stu-id="2408e-206">See also</span></span>

- [<span data-ttu-id="2408e-207">Principios básicos del subprocesamiento administrado</span><span class="sxs-lookup"><span data-stu-id="2408e-207">Managed Threading Basics</span></span>](../../../docs/standard/threading/managed-threading-basics.md)
