---
title: 'Cómo: Escribir un bucle Parallel.For con variables locales de subproceso'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
ms.openlocfilehash: bb6ac1a64c3a71646946d1af894d1124b12e4769
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290764"
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="de1b6-102">Cómo: Escribir un bucle Parallel.For con variables locales de subproceso</span><span class="sxs-lookup"><span data-stu-id="de1b6-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="de1b6-103">En este ejemplo se muestra la forma de usar variables locales para el subproceso para almacenar y recuperar el estado en cada una de las tareas independientes creadas por un bucle <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="de1b6-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="de1b6-104">Mediante el uso de datos locales de subproceso, se puede evitar la sobrecarga que supone la sincronización de un gran número de accesos a un estado compartido.</span><span class="sxs-lookup"><span data-stu-id="de1b6-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="de1b6-105">En vez de escribir en un recurso compartido en cada iteración, se calcula y se almacena el valor hasta que finalizan todas las iteraciones de la tarea.</span><span class="sxs-lookup"><span data-stu-id="de1b6-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="de1b6-106">A continuación, se escribe una vez el resultado final en el recurso compartido o se pasa a otro método.</span><span class="sxs-lookup"><span data-stu-id="de1b6-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="de1b6-107">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="de1b6-107">Example</span></span>  
 <span data-ttu-id="de1b6-108">En el ejemplo siguiente se llama al método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> para calcular la suma de los valores de una matriz que contiene un millón de elementos.</span><span class="sxs-lookup"><span data-stu-id="de1b6-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="de1b6-109">El valor de cada elemento es igual a su índice.</span><span class="sxs-lookup"><span data-stu-id="de1b6-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="de1b6-110">Los dos primeros parámetros de cada método <xref:System.Threading.Tasks.Parallel.For%2A> especifican los valores de iteración inicial y final.</span><span class="sxs-lookup"><span data-stu-id="de1b6-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="de1b6-111">En esta sobrecarga del método, el tercer parámetro es donde se inicializa el estado local.</span><span class="sxs-lookup"><span data-stu-id="de1b6-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="de1b6-112">En este contexto, estado local significa una variable cuya duración se extiende desde justo antes de la primera iteración del bucle en el subproceso actual, hasta justo después de la última iteración.</span><span class="sxs-lookup"><span data-stu-id="de1b6-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="de1b6-113">El tipo del tercer parámetro es <xref:System.Func%601>, donde `TResult` es el tipo de la variable que almacenará el estado local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="de1b6-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="de1b6-114">Su tipo se define mediante el argumento de tipo genérico que se proporciona al llamar al método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> genérico, que en este caso es <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="de1b6-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="de1b6-115">El argumento de tipo le indica al compilador el tipo de variable temporal que se usará para almacenar el estado local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="de1b6-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="de1b6-116">En este ejemplo, la expresión `() => 0` (o `Function() 0` en Visual Basic) inicializa la variable local de subproceso en cero.</span><span class="sxs-lookup"><span data-stu-id="de1b6-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="de1b6-117">Si el argumento de tipo genérico es un tipo de referencia o un tipo de valor definido por el usuario, la expresión tendrá el aspecto siguiente:</span><span class="sxs-lookup"><span data-stu-id="de1b6-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="de1b6-118">El cuarto parámetro define la lógica del bucle</span><span class="sxs-lookup"><span data-stu-id="de1b6-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="de1b6-119">y debe ser un delegado o una expresión lambda cuya firma sea `Func<int, ParallelLoopState, long, long>` en C# o `Func(Of Integer, ParallelLoopState, Long, Long)` en Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="de1b6-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="de1b6-120">El primer parámetro es el valor del contador de bucle correspondiente a esa iteración del bucle.</span><span class="sxs-lookup"><span data-stu-id="de1b6-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="de1b6-121">El segundo es un objeto <xref:System.Threading.Tasks.ParallelLoopState> que se puede usar para desglosar el bucle; la clase <xref:System.Threading.Tasks.Parallel> proporciona este objeto a cada repetición del bucle.</span><span class="sxs-lookup"><span data-stu-id="de1b6-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="de1b6-122">El tercer parámetro es la variable local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="de1b6-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="de1b6-123">El último parámetro es el tipo de valor devuelto.</span><span class="sxs-lookup"><span data-stu-id="de1b6-123">The last parameter is the return type.</span></span> <span data-ttu-id="de1b6-124">En este caso, el tipo es <xref:System.Int64> porque es el que se especificó en el argumento de tipo <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="de1b6-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="de1b6-125">Esa variable se denomina `subtotal` y la devuelve la expresión lambda.</span><span class="sxs-lookup"><span data-stu-id="de1b6-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="de1b6-126">El valor devuelto se usa para inicializar `subtotal` en todas las iteraciones posteriores del bucle.</span><span class="sxs-lookup"><span data-stu-id="de1b6-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="de1b6-127">Este último parámetro también se puede considerar como un valor que se pasa a todas las iteraciones y que, cuando finaliza la última iteración, se pasa al delegado `localFinally`.</span><span class="sxs-lookup"><span data-stu-id="de1b6-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="de1b6-128">El quinto parámetro define el método que se llama una vez, después de que se hayan completado todas las iteraciones de un subproceso en particular.</span><span class="sxs-lookup"><span data-stu-id="de1b6-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="de1b6-129">El tipo del argumento de entrada se corresponde de nuevo con el argumento de tipo del método <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> y el tipo devuelto por la expresión lambda del cuerpo.</span><span class="sxs-lookup"><span data-stu-id="de1b6-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="de1b6-130">En este ejemplo, el valor se agrega a una variable en el ámbito de clase de un modo seguro para subprocesos mediante una llamada al método <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="de1b6-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="de1b6-131">Gracias a la variable local de subproceso, se ha evitado el tener que escribir en esta variable de clase en cada iteración del bucle.</span><span class="sxs-lookup"><span data-stu-id="de1b6-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="de1b6-132">Para obtener más información sobre cómo usar las expresiones lambda, vea [Expresiones lambda en PLINQ y TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="de1b6-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="de1b6-133">Vea también</span><span class="sxs-lookup"><span data-stu-id="de1b6-133">See also</span></span>

- <span data-ttu-id="de1b6-134">[Data Parallelism](data-parallelism-task-parallel-library.md) (Paralelismo de datos)</span><span class="sxs-lookup"><span data-stu-id="de1b6-134">[Data Parallelism](data-parallelism-task-parallel-library.md)</span></span>
- [<span data-ttu-id="de1b6-135">Programación en paralelo</span><span class="sxs-lookup"><span data-stu-id="de1b6-135">Parallel Programming</span></span>](index.md)
- [<span data-ttu-id="de1b6-136">Biblioteca TPL</span><span class="sxs-lookup"><span data-stu-id="de1b6-136">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
- [<span data-ttu-id="de1b6-137">Expresiones lambda en PLINQ y TPL</span><span class="sxs-lookup"><span data-stu-id="de1b6-137">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
