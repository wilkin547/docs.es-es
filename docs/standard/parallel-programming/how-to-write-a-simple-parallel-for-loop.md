---
title: Procedimiento para escribir un bucle Parallel.For simple
description: Aprenda a escribir bucles Parallel.For en .NET en los que no tiene que cancelar el bucle, interrumpir las iteraciones del bucle ni mantener ningún estado local del subproceso.
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
ms.openlocfilehash: 8307f2205653fbd213d824acffc405ee97580166
ms.sourcegitcommit: 7137e12f54c4e83a94ae43ec320f8cf59c1772ea
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 06/10/2020
ms.locfileid: "84662698"
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="d0808-103">Procedimiento para escribir un bucle Parallel.For simple</span><span class="sxs-lookup"><span data-stu-id="d0808-103">How to: Write a Simple Parallel.For Loop</span></span>

<span data-ttu-id="d0808-104">Este tema contiene dos ejemplos que ilustran el método <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d0808-104">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d0808-105">El primer ejemplo usa la sobrecarga del método <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> y el segundo usa la sobrecarga <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType>, las dos sobrecargas más simples del método <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d0808-105">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d0808-106">Puede usar estas dos sobrecargas del método <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> cuando no sea necesario cancelar el bucle, interrumpir las iteraciones del bucle o mantener cualquier estado local de subproceso.</span><span class="sxs-lookup"><span data-stu-id="d0808-106">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>

> [!NOTE]
> <span data-ttu-id="d0808-107">En esta documentación, se utilizan expresiones lambda para definir delegados en la TPL.</span><span class="sxs-lookup"><span data-stu-id="d0808-107">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="d0808-108">Si no está familiarizado con las expresiones lambda de C# o Visual Basic, consulte [Expresiones lambda en PLINQ y TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="d0808-108">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="d0808-109">El primer ejemplo calcula el tamaño de los archivos de un solo directorio.</span><span class="sxs-lookup"><span data-stu-id="d0808-109">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="d0808-110">El segundo calcula el producto de dos matrices.</span><span class="sxs-lookup"><span data-stu-id="d0808-110">The second computes the product of two matrices.</span></span>

## <a name="directory-size-example"></a><span data-ttu-id="d0808-111">Ejemplo de tamaño de directorio</span><span class="sxs-lookup"><span data-stu-id="d0808-111">Directory size example</span></span>

<span data-ttu-id="d0808-112">Este ejemplo es una utilidad de línea de comandos simple que calcula el tamaño total de los archivos de un directorio.</span><span class="sxs-lookup"><span data-stu-id="d0808-112">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="d0808-113">Espera una ruta de directorio única como argumento e informa del número y el tamaño total de los archivos del directorio.</span><span class="sxs-lookup"><span data-stu-id="d0808-113">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="d0808-114">Después de comprobar que el directorio existe, usa el método <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> para enumerar los archivos del directorio y determinar su tamaño.</span><span class="sxs-lookup"><span data-stu-id="d0808-114">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="d0808-115">A continuación, el tamaño de los archivos se agrega a la variable `totalSize`.</span><span class="sxs-lookup"><span data-stu-id="d0808-115">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="d0808-116">Tenga en cuenta que la adición se realiza llamando a <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> para que se lleve a cabo como una operación atómica.</span><span class="sxs-lookup"><span data-stu-id="d0808-116">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="d0808-117">De lo contrario, varias tareas podrían tratar de actualizar la variable `totalSize` simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="d0808-117">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>

[!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
[!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]

## <a name="matrix-and-stopwatch-example"></a><span data-ttu-id="d0808-118">Ejemplo de matriz y cronómetro</span><span class="sxs-lookup"><span data-stu-id="d0808-118">Matrix and stopwatch example</span></span>

<span data-ttu-id="d0808-119">Este ejemplo usa el método <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> para calcular el producto de dos matrices.</span><span class="sxs-lookup"><span data-stu-id="d0808-119">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="d0808-120">También muestra cómo usar la clase <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> para comparar el rendimiento de un bucle paralelo con un bucle no paralelo.</span><span class="sxs-lookup"><span data-stu-id="d0808-120">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="d0808-121">Tenga en cuenta que, como puede generar un gran volumen de salida, el ejemplo permite redirigir la salida a un archivo.</span><span class="sxs-lookup"><span data-stu-id="d0808-121">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>

[!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
[!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]

<span data-ttu-id="d0808-122">Al paralelizar código, incluidos los bucles, un objetivo importante consiste en usar los procesadores tanto como sea posible, sin paralelizar en exceso hasta el punto de que la sobrecarga del procesamiento en paralelo niegue cualquier mejora en el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="d0808-122">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="d0808-123">En este ejemplo concreto solo se paraleliza el bucle externo, ya que el bucle interno no realiza mucho trabajo.</span><span class="sxs-lookup"><span data-stu-id="d0808-123">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="d0808-124">La combinación de una pequeña cantidad de trabajo y efectos no deseados en la caché puede producir una degradación del rendimiento en los bucles paralelos anidados.</span><span class="sxs-lookup"><span data-stu-id="d0808-124">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="d0808-125">Por consiguiente, paralelizar el bucle exterior solo es la mejor manera de maximizar las ventajas de simultaneidad en la mayoría de los sistemas.</span><span class="sxs-lookup"><span data-stu-id="d0808-125">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>

## <a name="the-delegate"></a><span data-ttu-id="d0808-126">Delegado</span><span class="sxs-lookup"><span data-stu-id="d0808-126">The Delegate</span></span>

<span data-ttu-id="d0808-127">El tercer parámetro de esta sobrecarga de <xref:System.Threading.Tasks.Parallel.For%2A> es un delegado de tipo `Action<int>` en C# o `Action(Of Integer)` en Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="d0808-127">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="d0808-128">Un delegado `Action`, tanto si tiene uno, dieciséis o ningún parámetro de tipo, siempre devuelve void.</span><span class="sxs-lookup"><span data-stu-id="d0808-128">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="d0808-129">En Visual Basic, el comportamiento de `Action` se define con `Sub`.</span><span class="sxs-lookup"><span data-stu-id="d0808-129">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="d0808-130">El ejemplo usa una expresión lambda para crear el delegado, pero puede crear el delegado de otras maneras.</span><span class="sxs-lookup"><span data-stu-id="d0808-130">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="d0808-131">Para obtener más información, consulte [Expresiones lambda en PLINQ y TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="d0808-131">For more information, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

## <a name="the-iteration-value"></a><span data-ttu-id="d0808-132">Valor de iteración</span><span class="sxs-lookup"><span data-stu-id="d0808-132">The Iteration Value</span></span>

<span data-ttu-id="d0808-133">El delegado toma un solo parámetro de entrada cuyo valor es la iteración actual.</span><span class="sxs-lookup"><span data-stu-id="d0808-133">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="d0808-134">Este valor de iteración lo suministra el tiempo de ejecución y su valor inicial es el índice del primer elemento del segmento (partición) del origen que se está procesando en el subproceso actual.</span><span class="sxs-lookup"><span data-stu-id="d0808-134">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>

<span data-ttu-id="d0808-135">Si necesita más control sobre el nivel de simultaneidad, use una de las sobrecargas que toma un parámetro de entrada <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType>, como <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d0808-135">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>

## <a name="return-value-and-exception-handling"></a><span data-ttu-id="d0808-136">Valor devuelto y control de excepciones</span><span class="sxs-lookup"><span data-stu-id="d0808-136">Return Value and Exception Handling</span></span>

<span data-ttu-id="d0808-137"><xref:System.Threading.Tasks.Parallel.For%2A> devuelve un objeto <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> cuando se completen todos los subprocesos.</span><span class="sxs-lookup"><span data-stu-id="d0808-137"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="d0808-138">Este valor devuelto es útil cuando se desea detener o interrumpir la iteración de bucle manualmente, ya que <xref:System.Threading.Tasks.ParallelLoopResult> almacena información, como la última iteración que se ejecutó hasta completarse.</span><span class="sxs-lookup"><span data-stu-id="d0808-138">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="d0808-139">Si se producen una o más excepciones en uno de los subprocesos, se inicia <xref:System.AggregateException?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="d0808-139">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>

<span data-ttu-id="d0808-140">En el código de este ejemplo, no se usa el valor devuelto de <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="d0808-140">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>

## <a name="analysis-and-performance"></a><span data-ttu-id="d0808-141">Análisis y rendimiento</span><span class="sxs-lookup"><span data-stu-id="d0808-141">Analysis and Performance</span></span>

<span data-ttu-id="d0808-142">Puede usar el Asistente de rendimiento para ver el uso de CPU en el equipo.</span><span class="sxs-lookup"><span data-stu-id="d0808-142">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="d0808-143">Como experimento, aumente el número de columnas y filas de las matrices.</span><span class="sxs-lookup"><span data-stu-id="d0808-143">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="d0808-144">Cuanto mayores sean las matrices, mayor será la diferencia de rendimiento entre las versiones paralelas y secuenciales del cálculo.</span><span class="sxs-lookup"><span data-stu-id="d0808-144">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="d0808-145">Si la matriz es pequeña, la versión secuencial se ejecutará más rápido debido a la sobrecarga de la configuración del bucle paralelo.</span><span class="sxs-lookup"><span data-stu-id="d0808-145">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>

<span data-ttu-id="d0808-146">Las llamadas sincrónicas a los recursos compartidos, como la consola o el sistema de archivos, reducirán considerablemente el rendimiento de un bucle paralelo.</span><span class="sxs-lookup"><span data-stu-id="d0808-146">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="d0808-147">Al medir el rendimiento, intente evitar las llamadas como <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> dentro del bucle.</span><span class="sxs-lookup"><span data-stu-id="d0808-147">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>

## <a name="compile-the-code"></a><span data-ttu-id="d0808-148">Compilar el código</span><span class="sxs-lookup"><span data-stu-id="d0808-148">Compile the Code</span></span>

<span data-ttu-id="d0808-149">Copie y pegue este código en un proyecto de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d0808-149">Copy and paste this code into a Visual Studio project.</span></span>

## <a name="see-also"></a><span data-ttu-id="d0808-150">Vea también</span><span class="sxs-lookup"><span data-stu-id="d0808-150">See also</span></span>

- <xref:System.Threading.Tasks.Parallel.For%2A>
- <xref:System.Threading.Tasks.Parallel.ForEach%2A>
- [<span data-ttu-id="d0808-151">Paralelismo de datos</span><span class="sxs-lookup"><span data-stu-id="d0808-151">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="d0808-152">Programación en paralelo</span><span class="sxs-lookup"><span data-stu-id="d0808-152">Parallel Programming</span></span>](index.md)
