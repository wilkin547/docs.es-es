---
title: Instrucciones para la inserción de dependencias
description: Conozca diferentes procedimientos recomendados y guías de inserción de dependencias para el desarrollo de aplicaciones .NET.
author: IEvangelist
ms.author: dapine
ms.date: 10/29/2020
ms.topic: guide
ms.openlocfilehash: 105536df873829dc79dcca1b86d080360e71303f
ms.sourcegitcommit: f2ab02d9a780819ca2e5310bbcf5cfe5b7993041
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 02/03/2021
ms.locfileid: "102402208"
---
# <a name="dependency-injection-guidelines"></a><span data-ttu-id="913cb-103">Instrucciones para la inserción de dependencias</span><span class="sxs-lookup"><span data-stu-id="913cb-103">Dependency injection guidelines</span></span>

<span data-ttu-id="913cb-104">En este artículo se proporcionan instrucciones generales y procedimientos recomendados para implementar la inserción de dependencias en aplicaciones .NET.</span><span class="sxs-lookup"><span data-stu-id="913cb-104">This article provides general guidelines and best practices for implementing dependency injection in .NET applications.</span></span>

## <a name="design-services-for-dependency-injection"></a><span data-ttu-id="913cb-105">Diseño de servicios para la inserción de dependencias</span><span class="sxs-lookup"><span data-stu-id="913cb-105">Design services for dependency injection</span></span>

<span data-ttu-id="913cb-106">Al diseñar servicios para la inserción de dependencias:</span><span class="sxs-lookup"><span data-stu-id="913cb-106">When designing services for dependency injection:</span></span>

- <span data-ttu-id="913cb-107">Evitar clases y miembros estáticos y con estado.</span><span class="sxs-lookup"><span data-stu-id="913cb-107">Avoid stateful, static classes and members.</span></span> <span data-ttu-id="913cb-108">Evitar crear un estado global mediante el diseño de aplicaciones para usar servicios singleton en su lugar.</span><span class="sxs-lookup"><span data-stu-id="913cb-108">Avoid creating global state by designing apps to use singleton services instead.</span></span>
- <span data-ttu-id="913cb-109">Evitar la creación directa de instancias de clases dependientes dentro de los servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-109">Avoid direct instantiation of dependent classes within services.</span></span> <span data-ttu-id="913cb-110">La creación directa de instancias se acopla al código de una implementación particular.</span><span class="sxs-lookup"><span data-stu-id="913cb-110">Direct instantiation couples the code to a particular implementation.</span></span>
- <span data-ttu-id="913cb-111">Cree servicios pequeños, bien factorizados y probados con facilidad.</span><span class="sxs-lookup"><span data-stu-id="913cb-111">Make services small, well-factored, and easily tested.</span></span>

<span data-ttu-id="913cb-112">Si una clase tiene muchas dependencias insertadas, podría ser un signo de que la clase tiene demasiadas responsabilidades e infringe el [principio de responsabilidad única (SRP)](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#single-responsibility).</span><span class="sxs-lookup"><span data-stu-id="913cb-112">If a class has many injected dependencies, it might be a sign that the class has too many responsibilities and violates the [Single Responsibility Principle (SRP)](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#single-responsibility).</span></span> <span data-ttu-id="913cb-113">Trate de mover algunas de las responsabilidades de la clase a clases nuevas para intentar refactorizarla.</span><span class="sxs-lookup"><span data-stu-id="913cb-113">Attempt to refactor the class by moving some of its responsibilities into new classes.</span></span>

### <a name="disposal-of-services"></a><span data-ttu-id="913cb-114">Eliminación de servicios</span><span class="sxs-lookup"><span data-stu-id="913cb-114">Disposal of services</span></span>

<span data-ttu-id="913cb-115">El contenedor es responsable de la limpieza de los tipos que crea y llama a <xref:System.IDisposable.Dispose%2A> en las instancias de <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="913cb-115">The container is responsible for cleanup of types it creates, and calls <xref:System.IDisposable.Dispose%2A> on <xref:System.IDisposable> instances.</span></span> <span data-ttu-id="913cb-116">El desarrollador nunca debe eliminar los servicios resueltos desde el contenedor.</span><span class="sxs-lookup"><span data-stu-id="913cb-116">Services resolved from the container should never be disposed by the developer.</span></span> <span data-ttu-id="913cb-117">Si un tipo o fábrica se registra como singleton, el contenedor elimina el singleton de manera automática.</span><span class="sxs-lookup"><span data-stu-id="913cb-117">If a type or factory is registered as a singleton, the container disposes the singleton automatically.</span></span>

<span data-ttu-id="913cb-118">En el ejemplo siguiente, el contenedor de servicios crea los servicios y se eliminan de manera automática:</span><span class="sxs-lookup"><span data-stu-id="913cb-118">In the following example, the services are created by the service container and disposed automatically:</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/TransientDisposable.cs":::

<span data-ttu-id="913cb-119">El tipo descartable anterior está diseñado para tener una duración transitoria.</span><span class="sxs-lookup"><span data-stu-id="913cb-119">The preceding disposable is intended to have a transient lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/ScopedDisposable.cs":::

<span data-ttu-id="913cb-120">El tipo descartable anterior está diseñado para tener una duración con ámbito.</span><span class="sxs-lookup"><span data-stu-id="913cb-120">The preceding disposable is intended to have a scoped lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/SingletonDisposable.cs":::

<span data-ttu-id="913cb-121">El tipo descartable anterior está diseñado para tener una duración de singleton.</span><span class="sxs-lookup"><span data-stu-id="913cb-121">The preceding disposable is intended to have a singleton lifetime.</span></span>

:::code language="csharp" source="snippets/configuration/console-di-disposable/Program.cs" range="1-21,41-60" highlight="":::

<span data-ttu-id="913cb-122">En la consola de depuración se muestra el siguiente resultado de ejemplo después de la ejecución:</span><span class="sxs-lookup"><span data-stu-id="913cb-122">The debug console shows the following sample output after running:</span></span>

```console
Scope 1...
ScopedDisposable.Dispose()
TransientDisposable.Dispose()

Scope 2...
ScopedDisposable.Dispose()
TransientDisposable.Dispose()

info: Microsoft.Hosting.Lifetime[0]
      Application started.Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
     Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
     Content root path: .\configuration\console-di-disposable\bin\Debug\net5.0
info: Microsoft.Hosting.Lifetime[0]
     Application is shutting down...
SingletonDisposable.Dispose()
```

### <a name="services-not-created-by-the-service-container"></a><span data-ttu-id="913cb-123">Servicios no creados por el contenedor de servicios</span><span class="sxs-lookup"><span data-stu-id="913cb-123">Services not created by the service container</span></span>

<span data-ttu-id="913cb-124">Observe el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="913cb-124">Consider the following code:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton(new ExampleService());

    // ...
}
```

<span data-ttu-id="913cb-125">En el código anterior:</span><span class="sxs-lookup"><span data-stu-id="913cb-125">In the preceding code:</span></span>

- <span data-ttu-id="913cb-126">El contenedor de servicios **no** crea la instancia de `ExampleService`.</span><span class="sxs-lookup"><span data-stu-id="913cb-126">The `ExampleService` instance is **not** created by the service container.</span></span>
- <span data-ttu-id="913cb-127">El marco de trabajo **no** elimina los servicios de manera automática.</span><span class="sxs-lookup"><span data-stu-id="913cb-127">The framework does **not** dispose of the services automatically.</span></span>
- <span data-ttu-id="913cb-128">El desarrollador es responsable de la eliminación de los servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-128">The developer is responsible for disposing the services.</span></span>

### <a name="idisposable-guidance-for-transient-and-shared-instances"></a><span data-ttu-id="913cb-129">Instrucciones de IDisposable para instancias transitorias y compartidas</span><span class="sxs-lookup"><span data-stu-id="913cb-129">IDisposable guidance for Transient and shared instances</span></span>

#### <a name="transient-limited-lifetime"></a><span data-ttu-id="913cb-130">Instancia transitoria, duración limitada</span><span class="sxs-lookup"><span data-stu-id="913cb-130">Transient, limited lifetime</span></span>

<span data-ttu-id="913cb-131">**Escenario**</span><span class="sxs-lookup"><span data-stu-id="913cb-131">**Scenario**</span></span>

<span data-ttu-id="913cb-132">La aplicación requiere una instancia de <xref:System.IDisposable> con una duración transitoria para cualquiera de estos escenarios:</span><span class="sxs-lookup"><span data-stu-id="913cb-132">The app requires an <xref:System.IDisposable> instance with a transient lifetime for either of the following scenarios:</span></span>

- <span data-ttu-id="913cb-133">La instancia se resuelve en el ámbito raíz (contenedor raíz).</span><span class="sxs-lookup"><span data-stu-id="913cb-133">The instance is resolved in the root scope (root container).</span></span>
- <span data-ttu-id="913cb-134">La instancia se debe eliminar antes de que finalice el ámbito.</span><span class="sxs-lookup"><span data-stu-id="913cb-134">The instance should be disposed before the scope ends.</span></span>

<span data-ttu-id="913cb-135">**Solución**</span><span class="sxs-lookup"><span data-stu-id="913cb-135">**Solution**</span></span>

<span data-ttu-id="913cb-136">Use el patrón de fábrica para crear una instancia fuera del ámbito principal.</span><span class="sxs-lookup"><span data-stu-id="913cb-136">Use the factory pattern to create an instance outside of the parent scope.</span></span> <span data-ttu-id="913cb-137">En esta situación, la aplicación habitualmente tendría un método `Create` que llama directamente al constructor del tipo final.</span><span class="sxs-lookup"><span data-stu-id="913cb-137">In this situation, the app would generally have a `Create` method that calls the final type's constructor directly.</span></span> <span data-ttu-id="913cb-138">Si el tipo final tiene otras dependencias, la fábrica puede:</span><span class="sxs-lookup"><span data-stu-id="913cb-138">If the final type has other dependencies, the factory can:</span></span>

- <span data-ttu-id="913cb-139">Recibir un <xref:System.IServiceProvider> en su constructor.</span><span class="sxs-lookup"><span data-stu-id="913cb-139">Receive an <xref:System.IServiceProvider> in its constructor.</span></span>
- <span data-ttu-id="913cb-140">Usar <xref:Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateInstance%2A?displayProperty=nameWithType> para crear instancias de la instancia fuera del contenedor, mientras usa el contenedor para sus dependencias.</span><span class="sxs-lookup"><span data-stu-id="913cb-140">Use <xref:Microsoft.Extensions.DependencyInjection.ActivatorUtilities.CreateInstance%2A?displayProperty=nameWithType> to instantiate the instance outside of the container, while using the container for its dependencies.</span></span>

#### <a name="shared-instance-limited-lifetime"></a><span data-ttu-id="913cb-141">Instancia compartida, duración limitada</span><span class="sxs-lookup"><span data-stu-id="913cb-141">Shared instance, limited lifetime</span></span>

<span data-ttu-id="913cb-142">**Escenario**</span><span class="sxs-lookup"><span data-stu-id="913cb-142">**Scenario**</span></span>

<span data-ttu-id="913cb-143">La aplicación requiere una instancia de <xref:System.IDisposable> compartida en varios servicios, pero la instancia de <xref:System.IDisposable> debe tener una duración limitada.</span><span class="sxs-lookup"><span data-stu-id="913cb-143">The app requires a shared <xref:System.IDisposable> instance across multiple services, but the <xref:System.IDisposable> instance should have a limited lifetime.</span></span>

<span data-ttu-id="913cb-144">**Solución**</span><span class="sxs-lookup"><span data-stu-id="913cb-144">**Solution**</span></span>

<span data-ttu-id="913cb-145">Registre la instancia con una duración restringida.</span><span class="sxs-lookup"><span data-stu-id="913cb-145">Register the instance with a scoped lifetime.</span></span> <span data-ttu-id="913cb-146">Use <xref:Microsoft.Extensions.DependencyInjection.IServiceScopeFactory.CreateScope%2A?displayProperty=nameWithType> para crear un <xref:Microsoft.Extensions.DependencyInjection.IServiceScope> nuevo.</span><span class="sxs-lookup"><span data-stu-id="913cb-146">Use <xref:Microsoft.Extensions.DependencyInjection.IServiceScopeFactory.CreateScope%2A?displayProperty=nameWithType> to create a new <xref:Microsoft.Extensions.DependencyInjection.IServiceScope>.</span></span> <span data-ttu-id="913cb-147">Use el <xref:System.IServiceProvider> del ámbito para obtener los servicios necesarios.</span><span class="sxs-lookup"><span data-stu-id="913cb-147">Use the scope's <xref:System.IServiceProvider> to get required services.</span></span> <span data-ttu-id="913cb-148">Elimine el ámbito cuando ya no lo necesite.</span><span class="sxs-lookup"><span data-stu-id="913cb-148">Dispose the scope when it's no longer needed.</span></span>

#### <a name="general-idisposable-guidelines"></a><span data-ttu-id="913cb-149">Instrucciones generales sobre `IDisposable`</span><span class="sxs-lookup"><span data-stu-id="913cb-149">General `IDisposable` guidelines</span></span>

- <span data-ttu-id="913cb-150">No registre instancias de <xref:System.IDisposable> con una duración transitoria.</span><span class="sxs-lookup"><span data-stu-id="913cb-150">Don't register <xref:System.IDisposable> instances with a transient lifetime.</span></span> <span data-ttu-id="913cb-151">En su lugar, use el patrón de fábrica.</span><span class="sxs-lookup"><span data-stu-id="913cb-151">Use the factory pattern instead.</span></span>
- <span data-ttu-id="913cb-152">No resuelva instancias de <xref:System.IDisposable> con una duración transitoria o restringida en el ámbito raíz.</span><span class="sxs-lookup"><span data-stu-id="913cb-152">Don't resolve <xref:System.IDisposable> instances with a transient or scoped lifetime in the root scope.</span></span> <span data-ttu-id="913cb-153">La única excepción a esto es si la aplicación crea o vuelve a crear y elimina <xref:System.IServiceProvider>, pero este no es un patrón ideal.</span><span class="sxs-lookup"><span data-stu-id="913cb-153">The only exception to this is if the app creates/recreates and disposes <xref:System.IServiceProvider>, but this isn't an ideal pattern.</span></span>
- <span data-ttu-id="913cb-154">La recepción de una dependencia de <xref:System.IDisposable> a través de las inserciones de dependencias no requiere que el receptor implemente <xref:System.IDisposable> por sí mismo.</span><span class="sxs-lookup"><span data-stu-id="913cb-154">Receiving an <xref:System.IDisposable> dependency via DI doesn't require that the receiver implement <xref:System.IDisposable> itself.</span></span> <span data-ttu-id="913cb-155">El receptor de la dependencia de <xref:System.IDisposable> no debe llamar a <xref:System.IDisposable.Dispose%2A> en esa dependencia.</span><span class="sxs-lookup"><span data-stu-id="913cb-155">The receiver of the <xref:System.IDisposable> dependency shouldn't call <xref:System.IDisposable.Dispose%2A> on that dependency.</span></span>
- <span data-ttu-id="913cb-156">Use ámbitos para controlar las duraciones de los servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-156">Use scopes to control the lifetimes of services.</span></span> <span data-ttu-id="913cb-157">Los ámbitos no son jerárquicos y no hay ninguna conexión especial entre ellos.</span><span class="sxs-lookup"><span data-stu-id="913cb-157">Scopes aren't hierarchical, and there's no special connection among scopes.</span></span>

<span data-ttu-id="913cb-158">Para más información sobre la limpieza de recursos, vea [Implementación de un método`Dispose`](../../standard/garbage-collection/implementing-dispose.md) o [Implementación de un método `DisposeAsync`](../../standard/garbage-collection/implementing-disposeasync.md).</span><span class="sxs-lookup"><span data-stu-id="913cb-158">For more information on resource cleanup, see [Implement a `Dispose` method](../../standard/garbage-collection/implementing-dispose.md), or [Implement a `DisposeAsync` method](../../standard/garbage-collection/implementing-disposeasync.md).</span></span> <span data-ttu-id="913cb-159">Además, tenga en cuenta el escenario [Servicios transitorios descartables capturados por el contenedor](#disposable-transient-services-captured-by-container) por su relación con la limpieza de recursos.</span><span class="sxs-lookup"><span data-stu-id="913cb-159">Additionally, consider the [Disposable transient services captured by container](#disposable-transient-services-captured-by-container) scenario as it relates to resource cleanup.</span></span>

## <a name="default-service-container-replacement"></a><span data-ttu-id="913cb-160">Reemplazo del contenedor de servicios predeterminado</span><span class="sxs-lookup"><span data-stu-id="913cb-160">Default service container replacement</span></span>

<span data-ttu-id="913cb-161">El contenedor de servicios integrado está diseñado para atender las necesidades del marco y de la mayoría de las aplicaciones de consumidor.</span><span class="sxs-lookup"><span data-stu-id="913cb-161">The built-in service container is designed to serve the needs of the framework and most consumer apps.</span></span> <span data-ttu-id="913cb-162">Se recomienda usar el contenedor integrado a menos que se necesite una característica específica no admitida por el contenedor, como:</span><span class="sxs-lookup"><span data-stu-id="913cb-162">We recommend using the built-in container unless you need a specific feature that it doesn't support, such as:</span></span>

- <span data-ttu-id="913cb-163">Inserción de propiedades</span><span class="sxs-lookup"><span data-stu-id="913cb-163">Property injection</span></span>
- <span data-ttu-id="913cb-164">Inserción basada en nombres</span><span class="sxs-lookup"><span data-stu-id="913cb-164">Injection based on name</span></span>
- <span data-ttu-id="913cb-165">Contenedores secundarios</span><span class="sxs-lookup"><span data-stu-id="913cb-165">Child containers</span></span>
- <span data-ttu-id="913cb-166">Administración personalizada del ciclo de vida</span><span class="sxs-lookup"><span data-stu-id="913cb-166">Custom lifetime management</span></span>
- <span data-ttu-id="913cb-167">Compatibilidad con `Func<T>` para la inicialización diferida</span><span class="sxs-lookup"><span data-stu-id="913cb-167">`Func<T>` support for lazy initialization</span></span>
- <span data-ttu-id="913cb-168">Registro basado en convenciones</span><span class="sxs-lookup"><span data-stu-id="913cb-168">Convention-based registration</span></span>

<span data-ttu-id="913cb-169">Los siguientes contenedores de terceros se pueden usar con aplicaciones ASP.NET Core:</span><span class="sxs-lookup"><span data-stu-id="913cb-169">The following third-party containers can be used with ASP.NET Core apps:</span></span>

- [<span data-ttu-id="913cb-170">Autofac</span><span class="sxs-lookup"><span data-stu-id="913cb-170">Autofac</span></span>](https://autofac.readthedocs.io/en/latest/integration/aspnetcore.html)
- [<span data-ttu-id="913cb-171">DryIoc</span><span class="sxs-lookup"><span data-stu-id="913cb-171">DryIoc</span></span>](https://www.nuget.org/packages/DryIoc.Microsoft.DependencyInjection)
- [<span data-ttu-id="913cb-172">Grace</span><span class="sxs-lookup"><span data-stu-id="913cb-172">Grace</span></span>](https://www.nuget.org/packages/Grace.DependencyInjection.Extensions)
- [<span data-ttu-id="913cb-173">LightInject</span><span class="sxs-lookup"><span data-stu-id="913cb-173">LightInject</span></span>](https://github.com/seesharper/LightInject.Microsoft.DependencyInjection)
- [<span data-ttu-id="913cb-174">Lamar</span><span class="sxs-lookup"><span data-stu-id="913cb-174">Lamar</span></span>](https://jasperfx.github.io/lamar/)
- [<span data-ttu-id="913cb-175">Stashbox</span><span class="sxs-lookup"><span data-stu-id="913cb-175">Stashbox</span></span>](https://github.com/z4kn4fein/stashbox-extensions-dependencyinjection)
- [<span data-ttu-id="913cb-176">Unity</span><span class="sxs-lookup"><span data-stu-id="913cb-176">Unity</span></span>](https://www.nuget.org/packages/Unity.Microsoft.DependencyInjection)

## <a name="thread-safety"></a><span data-ttu-id="913cb-177">Seguridad para subprocesos</span><span class="sxs-lookup"><span data-stu-id="913cb-177">Thread safety</span></span>

<span data-ttu-id="913cb-178">Cree servicios de singleton seguros para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="913cb-178">Create thread-safe singleton services.</span></span> <span data-ttu-id="913cb-179">Si un servicio de singleton tiene una dependencia en un servicio transitorio, es posible que este también deba ser seguro para subprocesos, según cómo lo use el singleton.</span><span class="sxs-lookup"><span data-stu-id="913cb-179">If a singleton service has a dependency on a transient service, the transient service may also require thread safety depending on how it's used by the singleton.</span></span>

<span data-ttu-id="913cb-180">El Factory Method de un servicio singleton, como el segundo argumento para [AddSingleton\<TService>(IServiceCollection, Func\<IServiceProvider,TService>)](xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionServiceExtensions.AddSingleton%2A), no necesita ser seguro para subprocesos.</span><span class="sxs-lookup"><span data-stu-id="913cb-180">The factory method of a singleton service, such as the second argument to [AddSingleton\<TService>(IServiceCollection, Func\<IServiceProvider,TService>)](xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionServiceExtensions.AddSingleton%2A), doesn't need to be thread-safe.</span></span> <span data-ttu-id="913cb-181">Al igual que un constructor de tipos (`static`), se garantiza que se le llame solo una vez mediante un único subproceso.</span><span class="sxs-lookup"><span data-stu-id="913cb-181">Like a type (`static`) constructor, it's guaranteed to be called only once by a single thread.</span></span>

## <a name="recommendations"></a><span data-ttu-id="913cb-182">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="913cb-182">Recommendations</span></span>

- <span data-ttu-id="913cb-183">No se admite la resolución de servicio basada en `async/await` y `Task`.</span><span class="sxs-lookup"><span data-stu-id="913cb-183">`async/await` and `Task` based service resolution isn't supported.</span></span> <span data-ttu-id="913cb-184">Como C# no admite constructores asincrónicos, use los métodos asincrónicos después de resolver sincrónicamente el servicio.</span><span class="sxs-lookup"><span data-stu-id="913cb-184">Because C# doesn't support asynchronous constructors, use asynchronous methods after synchronously resolving the service.</span></span>
- <span data-ttu-id="913cb-185">Evite almacenar datos y configuraciones directamente en el contenedor de servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-185">Avoid storing data and configuration directly in the service container.</span></span> <span data-ttu-id="913cb-186">Por ejemplo, el carro de la compra de un usuario no debería agregarse al contenedor de servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-186">For example, a user's shopping cart shouldn't typically be added to the service container.</span></span> <span data-ttu-id="913cb-187">La configuración debe usar el patrón de opciones.</span><span class="sxs-lookup"><span data-stu-id="913cb-187">Configuration should use the options pattern.</span></span> <span data-ttu-id="913cb-188">Del mismo modo, evite los objetos de tipo "contenedor de datos" que solo existen para permitir el acceso a otro objeto.</span><span class="sxs-lookup"><span data-stu-id="913cb-188">Similarly, avoid "data holder" objects that only exist to allow access to another object.</span></span> <span data-ttu-id="913cb-189">Es mejor solicitar el elemento real que se necesita mediante la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="913cb-189">It's better to request the actual item via DI.</span></span>
- <span data-ttu-id="913cb-190">Evite el acceso estático a los servicios.</span><span class="sxs-lookup"><span data-stu-id="913cb-190">Avoid static access to services.</span></span> <span data-ttu-id="913cb-191">Por ejemplo, evite capturar [IApplicationBuilder.ApplicationServices](xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.ApplicationServices) como campo estático o propiedad para su uso en otra parte.</span><span class="sxs-lookup"><span data-stu-id="913cb-191">For example, avoid capturing [IApplicationBuilder.ApplicationServices](xref:Microsoft.AspNetCore.Builder.IApplicationBuilder.ApplicationServices) as a static field or property for use elsewhere.</span></span>
- <span data-ttu-id="913cb-192">Mantenga los [generadores de DI](#async-di-factories-can-cause-deadlocks) rápidos y sincrónicos.</span><span class="sxs-lookup"><span data-stu-id="913cb-192">Keep [DI factories](#async-di-factories-can-cause-deadlocks) fast and synchronous.</span></span>
- <span data-ttu-id="913cb-193">Evite el uso del [*patrón del localizador de servicios*](#scoped-service-as-singleton).</span><span class="sxs-lookup"><span data-stu-id="913cb-193">Avoid using the [*service locator pattern*](#scoped-service-as-singleton).</span></span> <span data-ttu-id="913cb-194">Por ejemplo, no invoque a <xref:System.IServiceProvider.GetService%2A> para obtener una instancia de servicio si puede usar la inserción de dependencias en su lugar.</span><span class="sxs-lookup"><span data-stu-id="913cb-194">For example, don't invoke <xref:System.IServiceProvider.GetService%2A> to obtain a service instance when you can use DI instead.</span></span>
- <span data-ttu-id="913cb-195">Otra variación del localizador de servicios que se debe evitar es insertar una fábrica que resuelva dependencias en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="913cb-195">Another service locator variation to avoid is injecting a factory that resolves dependencies at runtime.</span></span> <span data-ttu-id="913cb-196">Estas dos prácticas combinan estrategias de [Inversión de control](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion).</span><span class="sxs-lookup"><span data-stu-id="913cb-196">Both of these practices mix [Inversion of Control](/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion) strategies.</span></span>
- <span data-ttu-id="913cb-197">Evite las llamadas a <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider%2A> en `ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="913cb-197">Avoid calls to <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider%2A> in `ConfigureServices`.</span></span> <span data-ttu-id="913cb-198">La llamada a `BuildServiceProvider` suele ocurrir cuando el desarrollador desea resolver un servicio en `ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="913cb-198">Calling `BuildServiceProvider` typically happens when the developer wants to resolve a service in `ConfigureServices`.</span></span>
- <span data-ttu-id="913cb-199">El contenedor [captura los servicios transitorios descartables](#disposable-transient-services-captured-by-container) para su eliminación.</span><span class="sxs-lookup"><span data-stu-id="913cb-199">[Disposable transient services are captured](#disposable-transient-services-captured-by-container) by the container for disposal.</span></span> <span data-ttu-id="913cb-200">Esto puede resultar en una fuga de memoria si se resuelve desde el contenedor de nivel superior.</span><span class="sxs-lookup"><span data-stu-id="913cb-200">This can turn into a memory leak if resolved from the top-level container.</span></span>
- <span data-ttu-id="913cb-201">Habilite la validación con ámbito para asegurarse de que la aplicación no tenga singletons que capturen los servicios con ámbito.</span><span class="sxs-lookup"><span data-stu-id="913cb-201">Enable scope validation to make sure the app doesn't have singletons that capture scoped services.</span></span> <span data-ttu-id="913cb-202">Para más información, vea [Validación del ámbito](dependency-injection.md#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="913cb-202">For more information, see [Scope validation](dependency-injection.md#scope-validation).</span></span>

<span data-ttu-id="913cb-203">Al igual que sucede con todas las recomendaciones, podría verse en una situación que le obligue a ignorar alguna de ellas.</span><span class="sxs-lookup"><span data-stu-id="913cb-203">Like all sets of recommendations, you may encounter situations where ignoring a recommendation is required.</span></span> <span data-ttu-id="913cb-204">Las excepciones son poco frecuentes, principalmente en casos especiales dentro del marco de trabajo mismo.</span><span class="sxs-lookup"><span data-stu-id="913cb-204">Exceptions are rare, mostly special cases within the framework itself.</span></span>

<span data-ttu-id="913cb-205">La inserción de dependencias es una *alternativa* a los patrones de acceso a objetos estáticos o globales.</span><span class="sxs-lookup"><span data-stu-id="913cb-205">DI is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="913cb-206">No podrá aprovechar las ventajas de la inserción de dependencias si la combina con el acceso a objetos estáticos.</span><span class="sxs-lookup"><span data-stu-id="913cb-206">You may not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="example-anti-patterns"></a><span data-ttu-id="913cb-207">Antipatrones de ejemplo</span><span class="sxs-lookup"><span data-stu-id="913cb-207">Example anti-patterns</span></span>

<span data-ttu-id="913cb-208">Además de las instrucciones de este artículo, hay varios antipatrones que ***debe** evitar*.</span><span class="sxs-lookup"><span data-stu-id="913cb-208">In addition to the guidelines in this article, there are several anti-patterns *you **should** avoid*.</span></span> <span data-ttu-id="913cb-209">Algunos de estos antipatrones son aprender del desarrollo de los propios tiempos de ejecución.</span><span class="sxs-lookup"><span data-stu-id="913cb-209">Some of these anti-patterns are learnings from developing the runtimes themselves.</span></span>

> [!WARNING]
> <span data-ttu-id="913cb-210">Estos son antipatrones de ejemplo: *no* copiar el código, *no* usar estos patrones y evitar estos patrones a toda costa.</span><span class="sxs-lookup"><span data-stu-id="913cb-210">These are example anti-patterns, *do not* copy the code, *do not* use these patterns, and avoid these patterns at all costs.</span></span>

### <a name="disposable-transient-services-captured-by-container"></a><span data-ttu-id="913cb-211">El contenedor captura los servicios transitorios descartables</span><span class="sxs-lookup"><span data-stu-id="913cb-211">Disposable transient services captured by container</span></span>

<span data-ttu-id="913cb-212">Cuando se registran servicios *transitorios* que implementan <xref:System.IDisposable>, de forma predeterminada, el contenedor de DI incluirá estas referencias y ningún método <xref:System.IDisposable.Dispose> hasta que el contenedor se elimine cuando la aplicación se detenga si se resolvieron desde el contenedor, o hasta que se elimine el ámbito si se resolvieron desde un ámbito.</span><span class="sxs-lookup"><span data-stu-id="913cb-212">When you register *Transient* services that implement <xref:System.IDisposable>, by default the DI container will hold onto these references, and not <xref:System.IDisposable.Dispose> of them until the container is disposed when application stops if they were resolved from the container, or until the scope is disposed if they were resolved from a scope.</span></span> <span data-ttu-id="913cb-213">Esto puede resultar en una fuga de memoria si se resuelve desde el nivel de contenedor.</span><span class="sxs-lookup"><span data-stu-id="913cb-213">This can turn into a memory leak if resolved from container level.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="18-30":::

<span data-ttu-id="913cb-214">En el antipatrón anterior, se crean instancias de 1000 objetos `ExampleDisposable` y se liberan.</span><span class="sxs-lookup"><span data-stu-id="913cb-214">In the preceding anti-pattern, 1,000 `ExampleDisposable` objects are instantiated and rooted.</span></span> <span data-ttu-id="913cb-215">No se eliminarán hasta que se elimine la instancia de `serviceProvider`.</span><span class="sxs-lookup"><span data-stu-id="913cb-215">They will not be disposed of until the `serviceProvider` instance is disposed.</span></span>

<span data-ttu-id="913cb-216">Para más información sobre cómo depurar fugas de memoria, vea [Depuración de una fuga de memoria en .NET Core](../diagnostics/debug-memory-leak.md).</span><span class="sxs-lookup"><span data-stu-id="913cb-216">For more information on debugging memory leaks, see [Debug a memory leak in .NET](../diagnostics/debug-memory-leak.md).</span></span>

### <a name="async-di-factories-can-cause-deadlocks"></a><span data-ttu-id="913cb-217">Los generadores de DI asincrónicos pueden producir interbloqueos</span><span class="sxs-lookup"><span data-stu-id="913cb-217">Async DI factories can cause deadlocks</span></span>

<span data-ttu-id="913cb-218">El término "generadores de DI" hace referencia a los métodos de sobrecarga que existen al llamar a `Add{LIFETIME}`.</span><span class="sxs-lookup"><span data-stu-id="913cb-218">The term "DI factories" refers to the overload methods that exist when calling `Add{LIFETIME}`.</span></span> <span data-ttu-id="913cb-219">Hay sobrecargas que aceptan un `Func<IServiceProvider, T>`, donde `T` es el servicio que se está registrando, y el parámetro se denomina `implementationFactory`.</span><span class="sxs-lookup"><span data-stu-id="913cb-219">There are overloads accepting a `Func<IServiceProvider, T>` where `T` is the service being registered, and the parameter is named `implementationFactory`.</span></span> <span data-ttu-id="913cb-220">`implementationFactory` se puede proporcionar como una expresión lambda, una función local o un método.</span><span class="sxs-lookup"><span data-stu-id="913cb-220">The `implementationFactory` can be provided as a lambda expression, local function, or method.</span></span> <span data-ttu-id="913cb-221">Si el generador es asincrónico y se usa <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType>, se producirá un interbloqueo.</span><span class="sxs-lookup"><span data-stu-id="913cb-221">If the factory is asynchronous, and you use <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType>, this will cause a deadlock.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="32-45" highlight="4-8":::

<span data-ttu-id="913cb-222">En el código anterior, se proporciona una expresión lambda a `implementationFactory`, donde el cuerpo llama a <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType> en un método de devolución `Task<Bar>`.</span><span class="sxs-lookup"><span data-stu-id="913cb-222">In the preceding code, the `implementationFactory` is given a lambda expression where the body calls <xref:System.Threading.Tasks.Task%601.Result?displayProperty=nameWithType> on a `Task<Bar>` returning method.</span></span> <span data-ttu-id="913cb-223">Esto ***provoca un interbloqueo***.</span><span class="sxs-lookup"><span data-stu-id="913cb-223">This ***causes a deadlock***.</span></span> <span data-ttu-id="913cb-224">El método `GetBarAsync` simplemente emula una operación de trabajo asincrónica con <xref:System.Threading.Tasks.Task.Delay%2A?displayProperty=nameWithType> y, a continuación, llama a <xref:Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService%60%601(System.IServiceProvider)>.</span><span class="sxs-lookup"><span data-stu-id="913cb-224">The `GetBarAsync` method simply emulates an asynchronous work operation with <xref:System.Threading.Tasks.Task.Delay%2A?displayProperty=nameWithType>, and then calls <xref:Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService%60%601(System.IServiceProvider)>.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="47-53":::

<span data-ttu-id="913cb-225">Para más información sobre la programación asincrónica, vea [Programación asincrónica: Consejos e información importante](../../csharp/async.md#important-info-and-advice).</span><span class="sxs-lookup"><span data-stu-id="913cb-225">For more information on asynchronous guidance, see [Asynchronous programming: Important info and advice](../../csharp/async.md#important-info-and-advice).</span></span> <span data-ttu-id="913cb-226">Para más información sobre la depuración de interbloqueos, vea [Depuración de un interbloqueo en .NET Core](../diagnostics/debug-deadlock.md).</span><span class="sxs-lookup"><span data-stu-id="913cb-226">For more information debugging deadlocks, see [Debug a deadlock in .NET](../diagnostics/debug-deadlock.md).</span></span>

<span data-ttu-id="913cb-227">Cuando se ejecuta este antipatrón y se produce el interbloqueo, puede ver los dos subprocesos en espera de la ventana Pilas paralelas de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="913cb-227">When you're running this anti-pattern and the deadlock occurs, you can view the two threads waiting from Visual Studio's Parallel Stacks window.</span></span> <span data-ttu-id="913cb-228">Para más información, vea [Visualización de subprocesos y tareas en la ventana Pilas paralelas](/visualstudio/debugger/using-the-parallel-stacks-window).</span><span class="sxs-lookup"><span data-stu-id="913cb-228">For more information, see [View threads and tasks in the Parallel Stacks window](/visualstudio/debugger/using-the-parallel-stacks-window).</span></span>

### <a name="captive-dependency"></a><span data-ttu-id="913cb-229">Dependencia cautiva</span><span class="sxs-lookup"><span data-stu-id="913cb-229">Captive dependency</span></span>

<span data-ttu-id="913cb-230">El término ["dependencia cautiva"](https://blog.ploeh.dk/2014/06/02/captive-dependency) lo acuñó [Mark Seeman](https://blog.ploeh.dk/about) y hace referencia a la configuración incorrecta de la duración de los servicios, donde un servicio de mayor duración mantiene una dependencia cautiva del servicio de menor duración.</span><span class="sxs-lookup"><span data-stu-id="913cb-230">The term ["captive dependency"](https://blog.ploeh.dk/2014/06/02/captive-dependency) was coined by [Mark Seeman](https://blog.ploeh.dk/about), and refers to the misconfiguration of service lifetimes, where a longer-lived service holds a shorter-lived service captive.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="55-65":::

<span data-ttu-id="913cb-231">En el código anterior, `Foo` se registra como singleton y `Bar` tiene el ámbito, que en la superficie parece válido.</span><span class="sxs-lookup"><span data-stu-id="913cb-231">In the preceding code, `Foo` is registered as a singleton and `Bar` is scoped - which on the surface seems valid.</span></span> <span data-ttu-id="913cb-232">Sin embargo, tenga en cuenta la implementación de `Foo`.</span><span class="sxs-lookup"><span data-stu-id="913cb-232">However, consider the implementation of `Foo`.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Foo.cs" highlight="5":::

<span data-ttu-id="913cb-233">El objeto `Foo` requiere un objeto `Bar` y, como `Foo` es un singleton y `Bar` su ámbito, se trata de una configuración incorrecta.</span><span class="sxs-lookup"><span data-stu-id="913cb-233">The `Foo` object requires a `Bar` object, and since `Foo` is a singleton, and `Bar` is scoped - this is a misconfiguration.</span></span> <span data-ttu-id="913cb-234">Tal y como está, solo se crearía una instancia de `Foo`, y se mantendría en `Bar` mientras dure, que será un período mayor respecto a la duración con ámbito prevista de `Bar`.</span><span class="sxs-lookup"><span data-stu-id="913cb-234">As is, `Foo` would only be instantiated once, and it would hold onto `Bar` for its lifetime, which is longer than the intended scoped lifetime of `Bar`.</span></span> <span data-ttu-id="913cb-235">Considere la posibilidad de validar ámbitos, pasando `validateScopes: true` a <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(Microsoft.Extensions.DependencyInjection.IServiceCollection,System.Boolean)>.</span><span class="sxs-lookup"><span data-stu-id="913cb-235">You should consider validating scopes, by passing `validateScopes: true` to the <xref:Microsoft.Extensions.DependencyInjection.ServiceCollectionContainerBuilderExtensions.BuildServiceProvider(Microsoft.Extensions.DependencyInjection.IServiceCollection,System.Boolean)>.</span></span> <span data-ttu-id="913cb-236">Al validar los ámbitos, obtendría un <xref:System.InvalidOperationException> con un mensaje similar a "No se puede consumir el servicio 'Bar' con ámbito en el singleton 'Foo'".</span><span class="sxs-lookup"><span data-stu-id="913cb-236">When you validate the scopes, you'd get an <xref:System.InvalidOperationException> with a message similar to "Cannot consume scoped service 'Bar' from singleton 'Foo'.".</span></span>

<span data-ttu-id="913cb-237">Para más información, vea [Validación del ámbito](dependency-injection.md#scope-validation).</span><span class="sxs-lookup"><span data-stu-id="913cb-237">For more information, see [Scope validation](dependency-injection.md#scope-validation).</span></span>

### <a name="scoped-service-as-singleton"></a><span data-ttu-id="913cb-238">Servicio con ámbito como singleton</span><span class="sxs-lookup"><span data-stu-id="913cb-238">Scoped service as singleton</span></span>

<span data-ttu-id="913cb-239">Al usar los servicios con ámbito, si no va a crear un ámbito o en un ámbito existente, el servicio se convierte en un singleton.</span><span class="sxs-lookup"><span data-stu-id="913cb-239">When using scoped services, if you're not creating a scope or within an existing scope - the service becomes a singleton.</span></span>

:::code language="csharp" source="snippets/configuration/di-anti-patterns/Program.cs" range="68-82" highlight="13-14":::

<span data-ttu-id="913cb-240">En el código anterior, `Bar` se recupera dentro de un <xref:Microsoft.Extensions.DependencyInjection.IServiceScope>, que es correcto.</span><span class="sxs-lookup"><span data-stu-id="913cb-240">In the preceding code, `Bar` is retrieved within an <xref:Microsoft.Extensions.DependencyInjection.IServiceScope>, which is correct.</span></span> <span data-ttu-id="913cb-241">El antipatrón es la recuperación de `Bar` fuera del ámbito, y la variable se denomina `avoid` para mostrar qué recuperación de ejemplo es incorrecta.</span><span class="sxs-lookup"><span data-stu-id="913cb-241">The anti-pattern is the retrieval of `Bar` outside of the scope, and the variable is named `avoid` to show which example retrieval is incorrect.</span></span>

## <a name="see-also"></a><span data-ttu-id="913cb-242">Vea también</span><span class="sxs-lookup"><span data-stu-id="913cb-242">See also</span></span>

- [<span data-ttu-id="913cb-243">Inserción de dependencias en .NET</span><span class="sxs-lookup"><span data-stu-id="913cb-243">Dependency injection in .NET</span></span>](dependency-injection.md)
- [<span data-ttu-id="913cb-244">Tutorial: Uso de la inserción de dependencias en .NET</span><span class="sxs-lookup"><span data-stu-id="913cb-244">Tutorial: Use dependency injection in .NET</span></span>](dependency-injection-usage.md)
