---
title: Escritura y llamada a UDF en entornos interactivos de .NET para Apache Spark
description: Obtenga información sobre cómo escribir y llamar a UDF en shells interactivos de .NET para Apache Spark.
ms.author: nidutta
author: Niharikadutta
ms.date: 10/09/2020
ms.topic: conceptual
ms.custom: mvc,how-to
ms.openlocfilehash: c29c3a9f6269a342d1051d6d979a4e3adb42da02
ms.sourcegitcommit: c7f0beaa2bd66ebca86362ca17d673f7e8256ca6
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 03/23/2021
ms.locfileid: "104875556"
---
# <a name="write-and-call-udfs-in-net-for-apache-spark-interactive-environments"></a><span data-ttu-id="18390-103">Escritura y llamada a UDF en entornos interactivos de .NET para Apache Spark</span><span class="sxs-lookup"><span data-stu-id="18390-103">Write and call UDFs in .NET for Apache Spark interactive environments</span></span>

<span data-ttu-id="18390-104">En este artículo, aprenderá a usar funciones definidas por el usuario (UDF) en un entorno interactivo de .NET para Apache Spark.</span><span class="sxs-lookup"><span data-stu-id="18390-104">In this article, you will learn how to use user-defined functions (UDFs) in a .NET for Apache Spark interactive environment.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="18390-105">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="18390-105">Prerequisites</span></span>

1. <span data-ttu-id="18390-106">Instalar [.NET Interactive](https://github.com/dotnet/interactive)</span><span class="sxs-lookup"><span data-stu-id="18390-106">Install [.NET Interactive](https://github.com/dotnet/interactive)</span></span>
2. <span data-ttu-id="18390-107">Instalar [Jupyter Lab](https://jupyter.org/)</span><span class="sxs-lookup"><span data-stu-id="18390-107">Install [Jupyter lab](https://jupyter.org/)</span></span>

## <a name="net-for-apache-spark-interactive-experience"></a><span data-ttu-id="18390-108">Experiencia interactiva de .NET para Apache Spark</span><span class="sxs-lookup"><span data-stu-id="18390-108">.NET for Apache Spark Interactive experience</span></span>

<span data-ttu-id="18390-109">[.NET para Apache Spark](https://github.com/dotnet/spark) usa [.NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) a fin de proporcionar compatibilidad con .NET para la experiencia interactiva en Spark.</span><span class="sxs-lookup"><span data-stu-id="18390-109">[.NET for Apache Spark](https://github.com/dotnet/spark) uses [.NET Interactive](https://devblogs.microsoft.com/dotnet/net-interactive-is-here-net-notebooks-preview-2/) to provide .NET support for interactive experience inside Spark.</span></span> <span data-ttu-id="18390-110">Para saber cómo configurar el entorno a fin de probar .NET Interactive con cuadernos de Jupyter Notebook, vea el [repositorio de .NET Interactive](https://github.com/dotnet/interactive).</span><span class="sxs-lookup"><span data-stu-id="18390-110">To understand how to set up the environment to try .NET Interactive with Jupyter notebooks, see the [.NET Interactive repository](https://github.com/dotnet/interactive).</span></span>

<span data-ttu-id="18390-111">Además, se recomienda repasar [este artículo sobre la serialización de UDF en .NET para Apache Spark](udf-guide.md) a fin de entender qué son las UDF y cómo se serializan en .NET para Apache Spark.</span><span class="sxs-lookup"><span data-stu-id="18390-111">Also, it is recommended to go through [this article about UDF serialization in .NET for Apache Spark](udf-guide.md) to understand what UDFs are and how they are serialized in .NET for Apache Spark.</span></span>
<span data-ttu-id="18390-112">En esta guía se usan cuadernos de Jupyter Notebook para ilustrar cómo usar las UDF en una experiencia interactiva.</span><span class="sxs-lookup"><span data-stu-id="18390-112">This guide uses Jupyter Notebooks to illustrate how to use UDFs in an interactive experience.</span></span>

## <a name="define-a-udf-in-net-interactive"></a><span data-ttu-id="18390-113">Definición de una UDF en .NET Interactive</span><span class="sxs-lookup"><span data-stu-id="18390-113">Define a UDF in .NET Interactive</span></span>

<span data-ttu-id="18390-114">En la experiencia interactiva, una celda se puede considerar el fragmento de código que se envía como parte de una iteración de [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span><span class="sxs-lookup"><span data-stu-id="18390-114">In the interactive experience, a cell can be thought of as the code snippet being submitted as part of one iteration of the [REPL](https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop).</span></span> <span data-ttu-id="18390-115">Por ejemplo, examine el cuaderno siguiente para entender lo que significa:</span><span class="sxs-lookup"><span data-stu-id="18390-115">For example, take a look at the following notebook to understand what that means:</span></span>

![Celdas de Jupyter Notebook](./media/dotnet-interactive/dotnet-interactive-cells.png)

<span data-ttu-id="18390-117">Cada uno de los bloques marcados con la flecha roja es una celda o un envío de código a Spark.</span><span class="sxs-lookup"><span data-stu-id="18390-117">Each of those blocks marked by the red arrow is one cell, or one submission of code to Spark.</span></span> <span data-ttu-id="18390-118">Ahora, al definir una UDF que hace referencia a un objeto personalizado definido por el usuario, es necesario hacerlo en la misma celda en la que se define el objeto al que hace referencia.</span><span class="sxs-lookup"><span data-stu-id="18390-118">Now when defining a UDF that references a custom user-defined object, it is required that the UDF be defined in the same cell where the object it references is defined.</span></span> <span data-ttu-id="18390-119">En este ejemplo puede comprobar el aspecto que tiene:</span><span class="sxs-lookup"><span data-stu-id="18390-119">Let's look at what that looks like as an example:</span></span>

![UDF funcional](./media/dotnet-interactive/working-udf.png)

## <a name="call-a-udf-on-a-dataframe"></a><span data-ttu-id="18390-121">Llamada a una UDF en un objeto DataFrame</span><span class="sxs-lookup"><span data-stu-id="18390-121">Call a UDF on a DataFrame</span></span>

<span data-ttu-id="18390-122">Cuando se llama a una UDF definida previamente en un objeto `DataFrame`, es importante asegurarse de que la UDF se define en una celda enviada con anterioridad, antes de llamarla, como se puede observar en el ejemplo anterior.</span><span class="sxs-lookup"><span data-stu-id="18390-122">When calling a previously defined UDF on a `DataFrame` it is important to make sure the UDF is defined in a previously submitted cell, before calling it, as can be seen in the previous example.</span></span>

<span data-ttu-id="18390-123">Ahora se verá lo que sucede si se llama a la UDF en la misma celda en la que está definida.</span><span class="sxs-lookup"><span data-stu-id="18390-123">Now let's see what happens if we call the UDF in the same cell where it is defined.</span></span>

![Error en la llamada a la UDF](./media/dotnet-interactive/udf_fails.png)

<span data-ttu-id="18390-125">El error resaltado anteriormente se debe a que primero se deben compilar los ensamblados de UDF y enviarse a los trabajos antes de que se pueda llamar en un objeto DataFrame.</span><span class="sxs-lookup"><span data-stu-id="18390-125">The above highlighted error is because the UDF assemblies need to first be compiled and shipped to the workers before it can be called on a DataFrame.</span></span>

<span data-ttu-id="18390-126">Estos son algunos aspectos importantes que tener en cuenta al implementar las UDF en la experiencia interactiva de .NET para Apache Spark (como los [cuadernos de Azure Synapse](/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span><span class="sxs-lookup"><span data-stu-id="18390-126">These are a few important things to keep in mind while implementing UDFs in .NET for Apache Spark interactive experience (such as [Azure Synapse Notebooks](/azure/synapse-analytics/spark/apache-spark-development-using-notebooks)).</span></span>

## <a name="faqs"></a><span data-ttu-id="18390-127">Preguntas más frecuentes</span><span class="sxs-lookup"><span data-stu-id="18390-127">FAQs</span></span>

1. <span data-ttu-id="18390-128">**¿Por qué la UDF que hace referencia a un objeto definido por el usuario personalizado produce el error `Type Submission#_ is not marked as serializable`?**</span><span class="sxs-lookup"><span data-stu-id="18390-128">**Why does my UDF referencing a custom user-defined object throw the error `Type Submission#_ is not marked as serializable`?**</span></span>
    <span data-ttu-id="18390-129">.NET Interactive encapsula cada una de estas celdas con una clase contenedora del número de envío de la celda, para identificar de forma única cada celda que se envía.</span><span class="sxs-lookup"><span data-stu-id="18390-129">.NET Interactive wraps each of these cells with a wrapper class of the cell submission number, to uniquely identify each cell being submitted.</span></span> <span data-ttu-id="18390-130">Como se explica con detalle en [esta guía](udf-guide.md), cuando se serializa una UDF que hace referencia a un objeto personalizado, su destino también se selecciona para la serialización, que en el caso de .NET Interactive se encapsula mediante la clase contenedora de la celda en la que se define el objeto personalizado.</span><span class="sxs-lookup"><span data-stu-id="18390-130">Now as explained in detail in [this guide](udf-guide.md), when a UDF that references a custom object is being serialized its target is also picked up for serialization, which in the case of .NET Interactive gets wrapped by the wrapper class of the cell where the custom object is defined.</span></span>
    <span data-ttu-id="18390-131">Ahora se verá cómo afecta eso a la definición de la UDF en el cuaderno:</span><span class="sxs-lookup"><span data-stu-id="18390-131">Now let's see how that affects our UDF definition in the notebook:</span></span>

    ![Error de serialización de la UDF](./media/dotnet-interactive/udf-serialization-error.png)

    <span data-ttu-id="18390-133">Como se aprecia en el caso de `udf2_fails`, se ve el mensaje de error que indica que el tipo `Submission#7` no está marcado como serializable; esto se debe a que .NET Interactive encapsula todos los objetos definidos en una celda con su clase `Submission#`, que se genera sobre la marcha y, por tanto, no se marca como `Serializable`.</span><span class="sxs-lookup"><span data-stu-id="18390-133">As can be seen in the case of `udf2_fails`, we see the error message that says Type `Submission#7` is not marked as serializable, this is because .NET Interactive wraps every object defined in a cell with its `Submission#` class, which is generated on the fly and hence is not marked as `Serializable`.</span></span>

    <span data-ttu-id="18390-134">Por este motivo, es **obligatorio que una UDF que hace referencia a un objeto personalizado se defina en la misma celda que ese objeto**.</span><span class="sxs-lookup"><span data-stu-id="18390-134">For this reason, it is **required that a UDF referencing a custom object is defined in the same cell as that object**.</span></span>

2. <span data-ttu-id="18390-135">**¿Por qué no funcionan las variables de difusión con .NET Interactive?**</span><span class="sxs-lookup"><span data-stu-id="18390-135">**Why don't Broadcast Variables work with .NET Interactive?**</span></span>
    <span data-ttu-id="18390-136">Por los motivos explicados anteriormente, las variables de difusión no funcionan con .NET Interactive.</span><span class="sxs-lookup"><span data-stu-id="18390-136">For the reasons explained previously, broadcast variables don't work with .NET Interactive.</span></span> <span data-ttu-id="18390-137">Es aconsejable repasar [esta guía sobre las variables de difusión](broadcast-guide.md) para comprender mejor qué son y cómo usarlas.</span><span class="sxs-lookup"><span data-stu-id="18390-137">It is a good idea to go through [this guide on broadcast variables](broadcast-guide.md) to get a deeper understanding of what broadcast variables are and how to use them.</span></span> <span data-ttu-id="18390-138">El motivo por el que las variables de difusión no funcionan con escenarios interactivos se debe al diseño de .NET Interactive de anexar cada objeto definido en una celda con su clase de envío de celda; al no estar marcada como serializable, se inicia la misma excepción que se ha mostrado antes.</span><span class="sxs-lookup"><span data-stu-id="18390-138">The reason broadcast variables don't work with interactive scenarios is because of .NET interactive's design of appending each object defined in a cell with its cell submission class, which since is not marked serializable, fails with the same exception as shown previously.</span></span>
    <span data-ttu-id="18390-139">Ahora se profundizará con el ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="18390-139">Let's dive a little deeper with the following example:</span></span>

    ![Error de las variables de difusión](./media/dotnet-interactive/broadcast-fails.png)

    <span data-ttu-id="18390-141">Como se ha recomendado en las secciones anteriores, la UDF y el objeto al que hace referencia (en este caso la variable de difusión) se definen en la misma celda, pero todavía se ve que el error `SerializationException` se queja de que `Microsoft.Spark.Sql.Session` no se marque como serializable.</span><span class="sxs-lookup"><span data-stu-id="18390-141">As recommended in the previous sections, we define both the UDF and the object it is referencing (broadcast variable in this case) in the same cell, but we still see the `SerializationException` error complaining about `Microsoft.Spark.Sql.Session` not being marked as serializable.</span></span> <span data-ttu-id="18390-142">El motivo es que cuando el compilador intenta serializar el objeto de variable de difusión `bv`, encuentra que al nombre se le anexa el objeto `spark` [`SparkSession`](https://github.com/dotnet/spark/blob/main/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20), que se debe marcar como serializable.</span><span class="sxs-lookup"><span data-stu-id="18390-142">This is because when the compiler tries to serialize the broadcast variable object `bv`, it finds its name to be appended with [`SparkSession`](https://github.com/dotnet/spark/blob/main/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) object `spark`, which it requires to be marked as serializable.</span></span> <span data-ttu-id="18390-143">Esto se puede mostrar con más facilidad al examinar el ensamblado descompilado de este envío de celda:</span><span class="sxs-lookup"><span data-stu-id="18390-143">This can be demonstrated with more ease by taking a peek at the decompiled assembly of this cell submission:</span></span>

    ![Código de ensamblado descompilado](./media/dotnet-interactive/decompiledAssembly.png)

    <span data-ttu-id="18390-145">Si la clase [`SparkSession`](https://github.com/dotnet/spark/blob/main/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) se marca como `[Serializable]`, se puede conseguir que funcione, pero no es una solución ideal, ya que no interesa permitir al usuario serializar un objeto SparkSession, lo que podría dar lugar a un comportamiento extraño e indeseable.</span><span class="sxs-lookup"><span data-stu-id="18390-145">If we mark the [`SparkSession`](https://github.com/dotnet/spark/blob/main/src/csharp/Microsoft.Spark/Sql/SparkSession.cs#L20) class as `[Serializable]`, we can get this to work, but this is not an ideal solution as we don't want to give the user the ability to serialize a SparkSession object, as that could lead to some weird, undesirable behavior.</span></span> <span data-ttu-id="18390-146">Este es un [problema conocido](https://github.com/dotnet/spark/issues/619) y se resolverá en versiones futuras.</span><span class="sxs-lookup"><span data-stu-id="18390-146">This is a [known issue](https://github.com/dotnet/spark/issues/619) and will be resolved in future versions.</span></span>
